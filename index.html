<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¬¼æ»…ä¹‹åˆƒä¸€ç­†ç•«äº¤æ›ç¦®ç‰© (é€£é–ç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a more brush-style look -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'kimetsu-green': '#2ecc71', /* Tanjiro Green */
                        'kimetsu-dark-green': '#006400',
                        'kimetsu-black': '#2d3436',
                        'kimetsu-bg': '#f5f6fa', /* Light gray/paper */
                        'kimetsu-pink': '#fd79a8', /* Nezuko Pink */
                        'kimetsu-yellow': '#f1c40f', /* Zenitsu Yellow */
                        'wood-dark': '#5D4037',
                        'wood-light': '#8D6E63',
                    },
                    fontFamily: {
                        'kimetsu': ['"Noto Serif TC"', '"Songti TC"', 'serif'] 
                    },
                    backgroundImage: {
                        'checkered': "url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Cg fill-rule='evenodd'%3E%3Cpath d='M0 0h20v20H0V0zm20 20h20v20H20V20z' fill='%232ecc71' opacity='0.4'/%3E%3Cpath d='M20 0h20v20H20V0zM0 20h20v20H0V20z' fill='%232d3436' opacity='0.8'/%3E%3C/g%3E%3C/svg%3E\")"
                    }
                }
            }
        }
    </script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Noto Serif TC', serif; }
        .animate-fade-in { animation: fadeIn 0.8s ease-in; }
        .animate-slide-up { animation: slideUp 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Loading Spinner - Nichirin Sword Guard Style */
        #initial-loader { position: fixed; inset: 0; background: #2d3436; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s; }
        .spinner { 
            width: 60px; height: 60px; 
            border: 6px solid #2ecc71; 
            border-top: 6px solid #fd79a8; 
            border-radius: 50%; 
            animation: spin 1s linear infinite;
            box-shadow: 0 0 15px #2ecc71;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden-loader { opacity: 0; pointer-events: none; }
        
        /* Disable text selection for long press button */
        .noselect {
          -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none; /* Safari */
             -khtml-user-select: none; /* Konqueror HTML */
               -moz-user-select: none; /* Old versions of Firefox */
                -ms-user-select: none; /* Internet Explorer/Edge */
                    user-select: none; /* Non-prefixed version, currently
                                          supported by Chrome, Edge, Opera and Firefox */
        }

        /* Nezuko Box Styles */
        .nezuko-box {
            perspective: 1000px;
            /* cursor: pointer;  Moved to inline style for conditional logic */
        }
        .nezuko-door {
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: left;
        }
        .nezuko-box.open .nezuko-door {
            transform: rotateY(-110deg);
        }
        .wood-pattern {
            background-image: repeating-linear-gradient(90deg, transparent, transparent 10px, rgba(0,0,0,0.05) 10px, rgba(0,0,0,0.05) 20px);
        }
        .metal-strap {
            background: linear-gradient(90deg, #333, #555, #333);
            box-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="bg-checkered text-slate-800 font-kimetsu min-h-screen">
    
    <!-- åˆå§‹è¼‰å…¥ç•«é¢ -->
    <div id="initial-loader">
        <div class="spinner"></div>
        <p class="mt-6 text-kimetsu-green font-bold text-xl tracking-widest">å…¨é›†ä¸­å‘¼å¸...é€£ç·šä¸­...</p>
        <p id="error-msg" class="mt-2 text-kimetsu-pink text-sm max-w-md text-center hidden"></p>
    </div>

    <div id="root"></div>

    <!-- Global Error Handler -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            const loader = document.getElementById('initial-loader');
            const errText = document.getElementById('error-msg');
            if (loader && errText) {
                loader.classList.remove('hidden-loader'); 
                document.querySelector('.spinner').style.display = 'none'; 
                errText.classList.remove('hidden');
                errText.innerHTML = `<strong>è¡€é¬¼è¡“ï¼ˆéŒ¯èª¤ï¼‰ç™¼ç”Ÿï¼š</strong><br>${msg}<br><span style="font-size:10px; color:#ccc">${url}:${line}</span><br><br>è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸ã€‚`;
            }
            return false;
        };
    </script>

    <!-- React App Script -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18?dev';
        import { createRoot } from 'https://esm.sh/react-dom@18/client?dev';
        
        // Firebase Imports (Web SDK)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, collection, addDoc, onSnapshot, 
            doc, setDoc, updateDoc, deleteDoc, getDocs, writeBatch, serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // --- é¬¼æ®ºéšŠéšç´šè³‡æ–™ ---
        const RANKS = [
            'ç™¸', 'å£¬', 'è¾›', 'åºš', 'å·±', 'æˆŠ', 'ä¸', 'ä¸™', 'ä¹™', 'ç”²'
        ];
        const HASHIRA_TITLES = [
            'æ°´æŸ±', 'èŸ²æŸ±', 'ç‚æŸ±', 'éŸ³æŸ±', 'å²©æŸ±', 'æˆ€æŸ±', 'éœæŸ±', 'è›‡æŸ±', 'é¢¨æŸ±'
        ];

        const getRandomRank = () => {
            const roll = Math.random();
            if (roll < 0.1) { // 10% æ©Ÿç‡æˆç‚ºæŸ±
                return HASHIRA_TITLES[Math.floor(Math.random() * HASHIRA_TITLES.length)];
            }
            // éš¨æ©Ÿä¸€èˆ¬éšç´šï¼Œåå‘ä½éš
            const index = Math.floor(Math.random() * 5); // ç™¸~å·±
            return RANKS[index];
        };

        // --- å‘¼å¸æ³•æ¨£å¼è¨­å®š ---
        const BREATH_STYLES = {
            water: { 
                name: 'æ°´ä¹‹å‘¼å¸', 
                border: 'border-blue-600', 
                bg: 'bg-blue-50', 
                text: 'text-blue-800', 
                ring: 'ring-blue-400',
                icon: 'ğŸŒŠ' 
            },
            fire: { 
                name: 'ç‚ä¹‹å‘¼å¸', 
                border: 'border-red-600', 
                bg: 'bg-red-50', 
                text: 'text-red-800', 
                ring: 'ring-red-400',
                icon: 'ğŸ”¥'
            },
            thunder: { 
                name: 'é›·ä¹‹å‘¼å¸', 
                border: 'border-yellow-500', 
                bg: 'bg-yellow-50', 
                text: 'text-yellow-800', 
                ring: 'ring-yellow-400',
                icon: 'âš¡'
            },
            beast: { 
                name: 'ç¸ä¹‹å‘¼å¸', 
                border: 'border-stone-600', 
                bg: 'bg-stone-50', 
                text: 'text-stone-800', 
                ring: 'ring-stone-400',
                icon: 'ğŸ—'
            },
            insect: { 
                name: 'èŸ²ä¹‹å‘¼å¸', 
                border: 'border-purple-600', 
                bg: 'bg-purple-50', 
                text: 'text-purple-800', 
                ring: 'ring-purple-400',
                icon: 'ğŸ¦‹'
            },
            default: {
                name: 'æ™®é€šéšŠå“¡',
                border: 'border-kimetsu-black',
                bg: 'bg-white',
                text: 'text-kimetsu-black',
                ring: 'ring-kimetsu-green',
                icon: 'âš”ï¸'
            }
        };

        const getStyle = (key) => BREATH_STYLES[key] || BREATH_STYLES.default;

        // --- ç°¡æ˜“åœ–ç¤ºå…ƒä»¶ (SVG) ---
        const Icon = ({ path, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        // æ—¥è¼ªåˆ€é”é¢¨æ ¼çš„åœ–ç¤º
        const SwordIcon = ({ size = 24, className = "" }) => (
             <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M14.5 17.5L3 6V3h3l11.5 11.5"/>
                <path d="M13 19l6-6"/>
                <path d="M16 16l4 4"/>
                <path d="M19 21l2-2"/>
            </svg>
        );
        
        const Icons = {
            Gift: (p) => <Icon {...p} path={<><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></>} />,
            PenTool: (p) => <Icon {...p} path={<><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></>} />, // é€™è£¡å¯ä»¥æƒ³åƒæˆæ¯›ç­†
            Users: (p) => <Icon {...p} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />,
            Shuffle: (p) => <Icon {...p} path={<><path d="M2 18h1.4c1.3 0 2.5-.6 3.3-1.7l14.2-12.6"/><path d="m22 2-5 5"/><path d="m17 2 5 5"/><path d="M2 6h1.4c1.3 0 2.5.6 3.3 1.7l14.2 12.6"/><path d="m22 22-5-5"/><path d="m17 22 5-5"/></>} />,
            Eye: (p) => <Icon {...p} path={<><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></>} />,
            Snowflake: (p) => <Icon {...p} path={<><path d="M12 2v20"/><path d="M2 12h20"/><path d="m4.93 4.93 14.14 14.14"/><path d="m19.07 4.93-14.14 14.14"/></>} />, 
            RotateCcw: (p) => <Icon {...p} path={<><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></>} />,
            Save: (p) => <Icon {...p} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />,
            Check: (p) => <Icon {...p} path={<polyline points="20 6 9 17 4 12"/>} />,
            Cloud: (p) => <Icon {...p} path={<path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19 8.963 24.5 12 24.5s5.5-2.463 5.5-5.5z" />} />,
            WifiOff: (p) => <Icon {...p} path={<><line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></>} />,
            Settings: (p) => <Icon {...p} path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />,
            Loader2: (p) => <Icon {...p} className={`${p.className} animate-spin`} path={<path d="M21 12a9 9 0 1 1-6.219-8.56" />} />,
            Lock: (p) => <Icon {...p} path={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>} />,
            LogOut: (p) => <Icon {...p} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></>} />,
            Trash2: (p) => <Icon {...p} path={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>} />,
            Key: (p) => <Icon {...p} path={<><path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/></>} />,
            Image: (p) => <Icon {...p} path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></>} />, // å·è»¸æ¨£å¼
            Edit: (p) => <Icon {...p} path={<><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></>} />,
            EyeOff: (p) => <Icon {...p} path={<><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></>} />,
            Sword: SwordIcon,
            Mic: (p) => <Icon {...p} path={<><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></>} />,
            ArrowRight: (p) => <Icon {...p} path={<><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></>} />,
            ArrowLeft: (p) => <Icon {...p} path={<><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></>} />,
            RotateCw: (p) => <Icon {...p} path={<><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></>} />,
            Tv: (p) => <Icon {...p} path={<><rect x="2" y="7" width="20" height="15" rx="2" ry="2"/><polyline points="17 2 12 7 7 2"/></>} />,
        };

        // --- Nezuko Box Component (Updated: Controlled + Visual State) ---
        const NezukoBox = ({ children, isLocked, isOpen, onClick }) => {
            // Check if interactive (Spectators pass onClick=null)
            const canInteract = !!onClick; 

            const handleClick = () => {
                if (!canInteract) return; // Ignore clicks if not interactive
                if (isLocked) {
                    alert('å°šæœªè§£é–‹å°å°ï¼');
                    return;
                }
                onClick();
            };

            // Determine label based on interaction state
            let labelText = isOpen ? 'é»æ“Šé—œé–‰' : 'é»æ“Šé–‹ç®±';
            if (!canInteract) {
                labelText = isOpen ? 'å±•ç¤ºä¸­' : 'ç­‰å¾…æ­æ›‰';
            }

            return (
                <div 
                    className={`relative w-full h-full bg-wood-dark border-4 border-black rounded-lg shadow-2xl overflow-hidden nezuko-box ${isOpen ? 'open' : ''} ${canInteract ? 'cursor-pointer' : 'cursor-default'}`}
                    onClick={handleClick}
                >
                    {/* Content (Drawing) Inside */}
                    <div className="absolute inset-0 flex items-center justify-center bg-white flex-col">
                        {children}
                        {/* Fallback label if image fails or box is just empty */}
                        {!children && <span className="text-slate-300 font-bold">ç„¡å…§å®¹</span>}
                    </div>

                    {/* Door Overlay */}
                    <div className="absolute inset-0 bg-wood-light flex flex-col justify-between p-2 nezuko-door z-20 wood-pattern border-r-4 border-black">
                        {/* Metal Straps */}
                        <div className="w-full h-4 metal-strap rounded"></div>
                        <div className="w-full h-4 metal-strap rounded"></div>
                        
                        {/* Center Pattern */}
                        <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center">
                            <div className="w-16 h-16 border-4 border-black bg-kimetsu-pink rounded-full flex items-center justify-center shadow-lg">
                                <span className="text-black font-black text-2xl">ç¦°</span>
                            </div>
                            <span className="text-white bg-black px-2 py-1 text-xs mt-2 font-bold rounded">{labelText}</span>
                        </div>

                        <div className="w-full h-4 metal-strap rounded"></div>
                        <div className="w-full h-4 metal-strap rounded"></div>
                    </div>
                </div>
            );
        };

        // --- Long Press Button Component ---
        const LongPressButton = ({ onComplete, label, icon: Icon, disabled }) => {
            const [pressing, setPressing] = useState(false);
            const [progress, setProgress] = useState(0);
            const intervalRef = useRef(null);

            useEffect(() => {
                if (pressing && !disabled) {
                    intervalRef.current = setInterval(() => {
                        setProgress(p => {
                            if (p >= 100) {
                                clearInterval(intervalRef.current);
                                return 100;
                            }
                            return p + 2; 
                        });
                    }, 30); // 30ms * 50 = 1.5s approx hold
                } else {
                    setProgress(0);
                    if (intervalRef.current) clearInterval(intervalRef.current);
                }
                return () => {
                    if (intervalRef.current) clearInterval(intervalRef.current);
                }
            }, [pressing, disabled]);

            useEffect(() => {
                if (progress === 100) {
                    setPressing(false);
                    onComplete();
                }
            }, [progress, onComplete]);

            return (
                <button
                    disabled={disabled}
                    className={`w-full py-3 border-2 text-kimetsu-black rounded font-bold flex items-center justify-center gap-2 shadow-sm tracking-widest relative overflow-hidden noselect transition ${disabled ? 'bg-gray-100 border-gray-300 opacity-50 cursor-not-allowed' : 'bg-white border-kimetsu-black hover:bg-slate-50 cursor-pointer'}`}
                    onMouseDown={() => setPressing(true)}
                    onMouseUp={() => setPressing(false)}
                    onMouseLeave={() => setPressing(false)}
                    onTouchStart={() => setPressing(true)}
                    onTouchEnd={() => setPressing(false)}
                >
                    <div className="absolute inset-0 bg-red-200 transition-all duration-75 ease-linear" style={{ width: `${progress}%` }}></div>
                    <div className="relative flex items-center gap-2 z-10">
                        {Icon && <Icon size={20}/>} 
                        {pressing ? (progress === 100 ? 'å·²ç¢ºèª' : 'è«‹é•·æŒ‰ä»¥éŠ·æ¯€...') : label}
                    </div>
                </button>
            )
        };

        // --- Config Wizard Component ---
        const ConfigWizard = ({ onConfigComplete, onOfflineMode }) => {
            const [inputConfig, setInputConfig] = useState('');
            const [error, setError] = useState('');

            const handleSave = () => {
                try {
                    let configStr = inputConfig.trim();
                    configStr = configStr.replace(/^(const|let|var|export\s+const)\s+\w+\s*=\s*/, '');
                    configStr = configStr.replace(/;$/, '');
                    
                    let config;
                    try {
                        config = JSON.parse(configStr);
                    } catch (e1) {
                        try {
                            let jsStr = configStr;
                            if (!jsStr.startsWith('{')) {
                                jsStr = `{${jsStr}}`;
                            }
                            const fn = new Function(`return ${jsStr}`);
                            config = fn();
                        } catch (e2) {
                            throw new Error("ç„¡æ³•è§£æå…§å®¹ï¼Œè«‹æª¢æŸ¥æ ¼å¼ã€‚");
                        }
                    }

                    if (!config || typeof config !== 'object') throw new Error("è¨­å®šå¿…é ˆæ˜¯ç‰©ä»¶æ ¼å¼");
                    if (!config.apiKey) throw new Error("ç¼ºå°‘ apiKey");
                    
                    localStorage.setItem('fb_config_override', JSON.stringify(config));
                    onConfigComplete(config);
                } catch(e) {
                    setError('ç„¡æ³•è§£æï¼š' + e.message + 'ã€‚å»ºè­°ç›´æ¥å¾ Firebase Console è¤‡è£½æ•´æ®µ config ç‰©ä»¶ã€‚');
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4">
                    <div className="bg-white p-8 rounded-lg shadow-2xl max-w-lg w-full border-4 border-kimetsu-black relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-2 bg-kimetsu-green"></div>
                        <div className="flex justify-center mb-4 text-kimetsu-black"><Icons.Settings size={48} /></div>
                        <h2 className="text-2xl font-bold text-center mb-2 text-kimetsu-black tracking-widest">é¬¼æ®ºéšŠãƒ»ç¸½éƒ¨é€£ç·šè¨­å®š</h2>
                        <p className="text-slate-600 text-center mb-6 font-bold">åµæ¸¬ä¸åˆ°é¹é´‰ä¿¡è™Ÿã€‚è«‹è¼¸å…¥ Firebase Config é€£ç·šï¼Œæˆ–é¸æ“‡é›¢ç·šä¿®ç…‰ã€‚</p>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-bold text-kimetsu-black mb-1">è¼¸å…¥å¯†ä»¤ (Firebase Config JSON):</label>
                                <textarea 
                                    className="w-full h-32 p-3 border-2 border-kimetsu-black rounded text-xs font-mono bg-kimetsu-bg focus:ring-2 ring-kimetsu-green outline-none"
                                    placeholder='const firebaseConfig = { ... };'
                                    value={inputConfig}
                                    onChange={e => setInputConfig(e.target.value)}
                                ></textarea>
                                {error && <p className="text-kimetsu-pink text-xs mt-1 whitespace-pre-wrap font-bold">{error}</p>}
                            </div>
                            
                            <button onClick={handleSave} className="w-full py-3 bg-kimetsu-black hover:bg-slate-800 text-white rounded font-bold transition border-b-4 border-slate-900 tracking-widest">
                                å»ºç«‹é€£ç·š
                            </button>

                            <div className="relative my-4">
                                <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-300"></div></div>
                                <div className="relative flex justify-center text-sm"><span className="px-2 bg-white text-slate-500 font-bold">æˆ–</span></div>
                            </div>

                            <button onClick={onOfflineMode} className="w-full py-3 bg-kimetsu-green hover:bg-green-500 text-white rounded font-bold flex items-center justify-center gap-2 transition border-b-4 border-green-700 tracking-widest">
                                <Icons.WifiOff size={20} />
                                é›¢ç·šä¿®ç…‰ (å–®æ©Ÿ)
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Helper wrapper for Local Nezuko Box usage (My Card / Check Result) ---
        // FIX: Simplified logic to ensure defaultOpen works reliably even if isLocked is true/false elsewhere
        const LocalNezukoBox = ({ children, isLocked, defaultOpen = false }) => {
            const [isOpen, setIsOpen] = useState(defaultOpen);
            
            // Effect to force sync if defaultOpen changes (e.g. view change)
            useEffect(() => {
                if (defaultOpen) setIsOpen(true);
            }, [defaultOpen]);

            return (
                <NezukoBox 
                    isLocked={isLocked} 
                    isOpen={isOpen} 
                    onClick={() => setIsOpen(!isOpen)}
                >
                    {children}
                </NezukoBox>
            );
        };

        // --- Main App ---
        const App = () => {
            const [mode, setMode] = useState('loading'); // loading, setup, cloud, offline
            // ... (rest of App component)
            const [view, setView] = useState('home'); 
            const [users, setUsers] = useState([]);
            const [matches, setMatches] = useState({});
            const [myParticipantId, setMyParticipantId] = useState(localStorage.getItem('my_participant_id'));
            const [revealData, setRevealData] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [isAdmin, setIsAdmin] = useState(false);
            const [adminPasswordInput, setAdminPasswordInput] = useState('');
            const [userPasswordInput, setUserPasswordInput] = useState('');
            const [loginTargetUser, setLoginTargetUser] = useState(null);
            const [editData, setEditData] = useState(null); 
            const [showAdminPasswords, setShowAdminPasswords] = useState(false); 
            
            // Live Event Mode States
            // IMPORTANT: liveHistory now stores ONLY user IDs to save space and avoid 1MB limit errors
            const [liveHistory, setLiveHistory] = useState([]); 
            const [liveIndex, setLiveIndex] = useState(-1);
            const [liveShowGiver, setLiveShowGiver] = useState(false);
            const [liveBoxOpen, setLiveBoxOpen] = useState(false); // New: Sync box state
            
            // Processing Lock Ref to prevent rapid double-clicks causing skips
            const processingRef = useRef(false);

            const appRef = useRef(null);
            const authRef = useRef(null);
            const dbRef = useRef(null);
            // Use global app ID if available, otherwise default
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            // 1. Initial Config Check
            useEffect(() => {
                const initSystem = async () => {
                    const loader = document.getElementById('initial-loader');
                    if(loader) loader.classList.add('hidden-loader');

                    let config = null;
                    try {
                        if (typeof __firebase_config !== 'undefined') {
                            config = JSON.parse(__firebase_config);
                        } else {
                            const saved = localStorage.getItem('fb_config_override');
                            if(saved) config = JSON.parse(saved);
                        }

                        if (config && config.apiKey) {
                            try {
                                appRef.current = initializeApp(config);
                                authRef.current = getAuth(appRef.current);
                                dbRef.current = getFirestore(appRef.current);
                                
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    await signInWithCustomToken(authRef.current, __initial_auth_token);
                                } else {
                                    await signInAnonymously(authRef.current);
                                }
                                
                                setMode('cloud');
                            } catch (err) {
                                console.error("Firebase Init Failed", err);
                                setMode('setup'); 
                            }
                        } else {
                            setMode('setup');
                        }
                    } catch (e) {
                        console.log("Config parse error", e);
                        setMode('setup');
                    }
                };
                initSystem();
            }, []);

            // 2. Data Sync
            useEffect(() => {
                if (mode !== 'cloud' || !dbRef.current) return;

                const participantsRef = collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'participants');
                const unsubUsers = onSnapshot(participantsRef, (snapshot) => {
                    const usersList = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    usersList.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                    setUsers(usersList);
                    
                    if (localStorage.getItem('my_participant_id')) {
                         const currentMyId = localStorage.getItem('my_participant_id');
                         const exists = usersList.find(u => u.id === currentMyId);
                         if (!exists) {
                             console.log("Auto-logout: User no longer exists.");
                             localStorage.removeItem('my_participant_id');
                             setMyParticipantId(null);
                             localStorage.removeItem('my_password_backup');
                         }
                    }
                }, err => console.error(err));

                const matchesRef = collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'matches');
                const unsubMatches = onSnapshot(matchesRef, (snapshot) => {
                    const matchesMap = {};
                    snapshot.docs.forEach(d => matchesMap[d.id] = d.data().receiverId);
                    setMatches(matchesMap);
                }, err => console.error(err));

                // Add listener for Live State (for spectators and admin sync)
                // Path MUST have even number of segments: collection/doc/collection/doc...
                // Previous error was caused by stopping at 'live_status' (collection)
                const liveStateRef = doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'live_status', 'main');
                const unsubLive = onSnapshot(liveStateRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        setLiveHistory(data.history || []);
                        setLiveIndex(data.currentIndex || -1);
                        setLiveShowGiver(data.showGiver || false);
                        setLiveBoxOpen(data.boxOpen || false); // Sync Box Open State
                    } else {
                        // Reset if doc doesn't exist
                        setLiveHistory([]);
                        setLiveIndex(-1);
                        setLiveShowGiver(false);
                        setLiveBoxOpen(false);
                    }
                });

                return () => { unsubUsers(); unsubMatches(); unsubLive(); };
            }, [mode]);

            // 3. Local Data Sync
            useEffect(() => {
                if (mode !== 'offline') return;
                const savedUsers = localStorage.getItem('xmas_users');
                const savedMatches = localStorage.getItem('xmas_matches');
                if (savedUsers) setUsers(JSON.parse(savedUsers));
                if (savedMatches) setMatches(JSON.parse(savedMatches));
            }, [mode]);

            // Helper to update live state in Firestore (for Admin)
            const updateLiveState = async (newHistory, newIndex, newShowGiver, newBoxOpen) => {
                 // Optimistic update locally
                 setLiveHistory(newHistory);
                 setLiveIndex(newIndex);
                 setLiveShowGiver(newShowGiver);
                 setLiveBoxOpen(newBoxOpen);

                 if (mode === 'cloud' && dbRef.current) {
                     const liveStateRef = doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'live_status', 'main');
                     await setDoc(liveStateRef, {
                         history: newHistory,
                         currentIndex: newIndex,
                         showGiver: newShowGiver,
                         boxOpen: newBoxOpen
                     }, { merge: true });
                 }
            };

            // Handlers
            const handleOfflineMode = () => {
                setMode('offline');
                setView('home');
            };

            const handleConfigComplete = (config) => {
                window.location.reload();
            };

            const handleReset = async () => {
                if (!confirm('ã€è­¦å‘Šã€‘ç¢ºå®šè¦éŠ·æ¯€æ‰€æœ‰å·è»¸ï¼Ÿ\næ‰€æœ‰éšŠå“¡çš„ç´€éŒ„å°‡ç„¡æ³•å¾©åŸï¼')) return;
                setIsProcessing(true);
                
                if (mode === 'cloud') {
                    try {
                        const usersSnap = await getDocs(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'participants'));
                        const batch1 = writeBatch(dbRef.current);
                        usersSnap.docs.forEach((d) => batch1.delete(d.ref));
                        await batch1.commit();

                        const matchesSnap = await getDocs(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'matches'));
                        const batch2 = writeBatch(dbRef.current);
                        matchesSnap.docs.forEach((d) => batch2.delete(d.ref));
                        await batch2.commit();
                        
                        // Also clear live state
                        await deleteDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'live_status', 'main'));

                    } catch (e) { alert('é‡ç½®å¤±æ•—'); }
                } else {
                    localStorage.removeItem('xmas_users');
                    localStorage.removeItem('xmas_matches');
                    setUsers([]);
                    setMatches({});
                }
                
                localStorage.removeItem('my_participant_id');
                localStorage.removeItem('my_password_backup');
                setMyParticipantId(null);
                setRevealData(null);
                setEditData(null);
                // Reset Live State
                setLiveHistory([]);
                setLiveIndex(-1);
                setLiveShowGiver(false);
                setLiveBoxOpen(false);
                setView('home');
                setIsProcessing(false);
            };

            const handleManualLogout = () => {
                if (confirm('ç¢ºå®šè¦éš±é€€ä¸¦æ¸…é™¤ç™»å…¥ç‹€æ…‹å—ï¼Ÿ(é›²ç«¯å·è»¸ä¸æœƒæ¶ˆå¤±)')) {
                    localStorage.removeItem('my_participant_id');
                    localStorage.removeItem('my_password_backup'); 
                    setMyParticipantId(null);
                    setEditData(null);
                    setView('home');
                }
            };

            const handleLiveReset = async () => {
                if (confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹å„€å¼å—ï¼Ÿ\né€™å°‡æ¸…é™¤å·²ä¸Šå°ç´€éŒ„ï¼Œè®“æµç¨‹å›åˆ°ç¬¬ä¸€ä½ã€‚')) {
                    await updateLiveState([], -1, false, false);
                }
            };

            const startDrawing = () => {
                if (myParticipantId && users.find(u => u.id === myParticipantId)) {
                    alert('ä½ å·²ç¶“æ˜¯é¬¼æ®ºéšŠçš„ä¸€å“¡äº†ï¼');
                    return;
                }
                setEditData(null); 
                setView('draw');
            };

            const editMyCard = () => {
                 const me = users.find(u => u.id === myParticipantId);
                 if (me) {
                     if (matches[me.id]) {
                         alert('ä»»å‹™å·²ç¶“åˆ†é…ï¼Œå·è»¸ç„¡æ³•ä¿®æ”¹äº†ï¼');
                         return;
                     }
                     setEditData(me);
                     setView('draw');
                 }
            };

            const saveUser = async (name, password, drawingData, style) => {
                setIsProcessing(true);
                try {
                    // Check duplicate name
                    const isDuplicate = users.some(u => u.name.trim() === name.trim() && u.id !== myParticipantId);
                    if (isDuplicate) {
                        alert('æ­¤éšŠå“¡å§“åå·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨å…¶ä»–ä»£è™Ÿï¼');
                        setIsProcessing(false);
                        return;
                    }

                    localStorage.setItem('my_password_backup', password);

                    // Assign Rank
                    const randomRank = getRandomRank();

                    if (editData && editData.id === myParticipantId) {
                         if (mode === 'cloud') {
                            const userRef = doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'participants', myParticipantId);
                            // Preserve rank on edit, or maybe re-roll? Let's preserve.
                            await updateDoc(userRef, {
                                name, password, drawing: drawingData, style, updatedAt: serverTimestamp()
                            });
                         } else {
                             const updatedUsers = users.map(u => 
                                u.id === myParticipantId ? { ...u, name, password, drawing: drawingData, style } : u
                             );
                             setUsers(updatedUsers);
                             localStorage.setItem('xmas_users', JSON.stringify(updatedUsers));
                         }
                         alert('å·è»¸ä¿®å¾©å®Œæˆï¼');
                         setView('my_card'); 
                    } else {
                        if (mode === 'cloud') {
                            const userUid = authRef.current?.currentUser?.uid || 'anon';
                            const docRef = await addDoc(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'participants'), {
                                name, password, drawing: drawingData, style, rank: randomRank, createdAt: serverTimestamp(), uid: userUid
                            });
                            localStorage.setItem('my_participant_id', docRef.id);
                            setMyParticipantId(docRef.id);
                        } else {
                            const newUser = { id: Date.now().toString(), name, password, drawing: drawingData, style, rank: randomRank, uid: 'local' };
                            const newUsers = [...users, newUser];
                            setUsers(newUsers);
                            localStorage.setItem('xmas_users', JSON.stringify(newUsers));
                            localStorage.setItem('my_participant_id', newUser.id);
                            setMyParticipantId(newUser.id);
                        }
                        setView('home');
                    }
                } catch (e) { console.error(e); alert('å‚³é€å¤±æ•—ï¼Œé¹é´‰è¿·è·¯äº†'); }
                setIsProcessing(false);
                setEditData(null);
            };

            const performMatching = async () => {
                if (users.length < 2) { alert('éšŠå“¡äººæ•¸ä¸è¶³ï¼Œç„¡æ³•åŸ·è¡Œä»»å‹™ï¼'); return; }
                if (Object.keys(matches).length > 0 && !confirm('ä»»å‹™å·²åˆ†é…ï¼Œç¢ºå®šè¦é‡æ–°æŒ‡æ´¾å—ï¼Ÿ')) return;
                
                setIsProcessing(true);
                let giverIds = users.map(u => u.id);
                let receiverIds = [...giverIds];
                let isValid = false;

                let attempts = 0;
                while (!isValid && attempts < 100) {
                    for (let i = receiverIds.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [receiverIds[i], receiverIds[j]] = [receiverIds[j], receiverIds[i]];
                    }
                    isValid = true;
                    for (let i = 0; i < giverIds.length; i++) {
                        if (giverIds[i] === receiverIds[i]) { isValid = false; break; }
                    }
                    attempts++;
                }

                if (!isValid) {
                     const shifted = [...giverIds];
                     const first = shifted.shift();
                     shifted.push(first);
                     receiverIds = shifted;
                }

                if (mode === 'cloud') {
                    try {
                        const batch = writeBatch(dbRef.current);
                        giverIds.forEach((giverId, index) => {
                            const matchRef = doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'matches', giverId);
                            batch.set(matchRef, { receiverId: receiverIds[index] });
                        });
                        await batch.commit();
                    } catch (e) { alert('æŒ‡æ´¾å¤±æ•—: ' + e.message); }
                } else {
                    const newMatches = {};
                    giverIds.forEach((gid, i) => newMatches[gid] = receiverIds[i]);
                    setMatches(newMatches);
                    localStorage.setItem('xmas_matches', JSON.stringify(newMatches));
                }
                
                alert('ä»»å‹™æŒ‡æ´¾å®Œæˆï¼');
                setIsProcessing(false);
            };

            const handleUserLogin = () => {
                if (!loginTargetUser) return;
                if (loginTargetUser.password && loginTargetUser.password !== userPasswordInput) {
                    alert('å‘¼å¸äº‚äº†ï¼å¯†ç¢¼éŒ¯èª¤ã€‚');
                    return;
                }
                
                // Login successful
                // Update local identity
                localStorage.setItem('my_participant_id', loginTargetUser.id);
                localStorage.setItem('my_password_backup', userPasswordInput); // Also save password for auto-fill later
                setMyParticipantId(loginTargetUser.id);

                const receiverId = matches[loginTargetUser.id];
                
                if (!receiverId) {
                    // Not matched yet -> Go to My Card to allow editing
                    setView('my_card');
                } else {
                    // Matched -> Show Result
                    const receiver = users.find(u => u.id === receiverId);
                    setRevealData({ giver: loginTargetUser, receiver });
                    setLoginTargetUser(null);
                    setUserPasswordInput('');
                    setView('check_result');
                }
            }

            const promptUserLogin = (user) => {
                setLoginTargetUser(user);
                if (isMe(user.id)) {
                    const savedPwd = localStorage.getItem('my_password_backup');
                    if(savedPwd) {
                        setUserPasswordInput(savedPwd);
                    } else {
                        setUserPasswordInput('');
                    }
                } else {
                    setUserPasswordInput('');
                }
                setView('user_login');
            }

            // Live Event Functions
            const handleNextLive = async () => {
                if (processingRef.current) return; // Prevent double clicks strictly with Ref
                processingRef.current = true;
                setIsProcessing(true);

                try {
                    // 1. If browsing history, just go next
                    if (liveIndex < liveHistory.length - 1) {
                        await updateLiveState(liveHistory, liveIndex + 1, false, false);
                        return;
                    }

                    // 2. Logic to pick new user
                    // NOTE: liveHistory now contains IDs only!
                    const drawnIds = new Set(liveHistory);
                    const allReceivers = Object.values(matches);
                    // Users who haven't been on stage as receiver yet
                    const remaining = users.filter(u => !drawnIds.has(u.id));
                    
                    if (remaining.length === 0) {
                        alert('æ‰€æœ‰éšŠå“¡éƒ½å·²ä¸Šå°ï¼ä»»å‹™åœ“æ»¿é”æˆï¼');
                        return;
                    }

                    let nextUser = null;

                    // CHAIN LOGIC: Try to find the person who GAVE the gift to the current receiver
                    if (liveHistory.length > 0) {
                        const currentReceiverId = liveHistory[liveHistory.length - 1]; // This is ID now
                        // Find who gave to currentReceiver. matches structure is { giverId: receiverId }
                        // We need to find Key where Value === currentReceiverId
                        const giverId = Object.keys(matches).find(key => matches[key] === currentReceiverId);
                        
                        // If this giver hasn't been a receiver yet, they are next!
                        if (giverId && !drawnIds.has(giverId)) {
                            nextUser = users.find(u => u.id === giverId);
                        }
                    }

                    // Fallback: If no chain (first person, or chain broken/looped), pick random
                    if (!nextUser) {
                        const randomIndex = Math.floor(Math.random() * remaining.length);
                        nextUser = remaining[randomIndex];
                    }

                    if (nextUser) {
                        // Push ID only!
                        const newHistory = [...liveHistory, nextUser.id];
                        // FIX: Ensure newBoxOpen is false explicitly to reset door
                        await updateLiveState(newHistory, newHistory.length - 1, false, false);
                    }
                } finally {
                    processingRef.current = false;
                    setIsProcessing(false);
                }
            };

            const handlePrevLive = async () => {
                if (liveIndex > 0) {
                     await updateLiveState(liveHistory, liveIndex - 1, false, false);
                }
            }

            const toggleLiveReveal = async () => {
                 await updateLiveState(liveHistory, liveIndex, true, liveBoxOpen);
            }

            const toggleBoxOpen = async () => {
                // FIX: Guard clause to prevent writing invalid state if liveIndex is invalid
                if (liveIndex < 0 || liveIndex >= liveHistory.length) return;
                await updateLiveState(liveHistory, liveIndex, liveShowGiver, !liveBoxOpen);
            }

            // Derive current live receiver object from ID
            const liveReceiverId = liveIndex >= 0 && liveHistory.length > 0 ? liveHistory[liveIndex] : null;
            const liveReceiver = liveReceiverId ? users.find(u => u.id === liveReceiverId) : null;

            const isMe = (uid) => myParticipantId === uid;

            const handleAdminLogin = () => {
                if (adminPasswordInput === 'admin123') { 
                    setIsAdmin(true);
                    setView('admin_dashboard');
                    setAdminPasswordInput('');
                } else {
                    alert('æš—è™ŸéŒ¯èª¤');
                }
            };

            // Render Modes
            if (mode === 'loading') return null;
            if (mode === 'setup') return <ConfigWizard onConfigComplete={handleConfigComplete} onOfflineMode={handleOfflineMode} />;

            // --- Admin Views ---
            if (view === 'admin_login') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="bg-white p-8 rounded shadow-2xl max-w-sm w-full border-4 border-kimetsu-black relative">
                            <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-kimetsu-black tracking-widest border-b-2 border-kimetsu-green pb-2">
                                <Icons.Lock className="text-kimetsu-black"/> ä¸»å…¬å¤§äººç™»å…¥
                            </h2>
                            <p className="text-slate-600 text-sm mb-4 font-bold">è«‹è¼¸å…¥æš—è™Ÿé€²å…¥ç”¢å±‹æ•·å®…é‚¸ã€‚</p>
                            <input 
                                type="password" 
                                value={adminPasswordInput}
                                onChange={e => setAdminPasswordInput(e.target.value)}
                                className="w-full p-3 border-2 border-kimetsu-black rounded mb-4 outline-none focus:ring-2 ring-kimetsu-green bg-kimetsu-bg text-center tracking-widest font-bold"
                                placeholder="æš—è™Ÿ (é è¨­: admin123)"
                            />
                            <div className="flex gap-2">
                                <button onClick={() => setView('home')} className="flex-1 py-2 bg-slate-200 text-slate-700 rounded font-bold hover:bg-slate-300 transition">è¿”å›</button>
                                <button onClick={handleAdminLogin} className="flex-1 py-2 bg-kimetsu-black text-white rounded font-bold hover:bg-slate-800 transition border-b-4 border-slate-900">ç™»å…¥</button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Shared View for Admin and Spectator
            if (view === 'admin_live' || view === 'spectator_live') {
                const isSpectator = view === 'spectator_live';
                const giver = liveReceiver ? users.find(u => matches[u.id] === liveReceiver.id) : null;
                const isHistoryMode = liveIndex < liveHistory.length - 1;
                const style = getStyle(liveReceiver?.style || 'default');
                const rank = liveReceiver?.rank || 'ç™¸';
                
                // Determine next button label logic
                let nextButtonLabel = "éš¨æ©Ÿå¬å–š";
                if (isHistoryMode) {
                    nextButtonLabel = "ä¸‹ä¸€ä½ (æ­·å²)";
                } else {
                    if (liveReceiver) {
                         // Check if next is chained
                         const currentReceiverId = liveReceiver.id;
                         const nextGiverId = Object.keys(matches).find(key => matches[key] === currentReceiverId);
                         const drawnIds = new Set(liveHistory);
                         
                         if (nextGiverId && !drawnIds.has(nextGiverId)) {
                             nextButtonLabel = "å¬å–šé€™ä½é€ç¦®è€… (é€£é–)";
                         } else {
                             nextButtonLabel = "éš¨æ©Ÿå¬å–š (æ–°å›åˆ)";
                         }
                    } else {
                        nextButtonLabel = "éš¨æ©Ÿå¬å–šç¬¬ä¸€ä½";
                    }
                }
                
                // Use a local internal NezukoBox state for "My Card" view, but here we use the controlled prop
                return (
                    <div className="min-h-screen flex flex-col bg-kimetsu-black text-white relative overflow-hidden">
                        {/* Decorative Patterns */}
                        <div className="absolute top-0 left-0 w-full h-4 bg-kimetsu-green"></div>
                        <div className="absolute bottom-0 left-0 w-full h-4 bg-kimetsu-green"></div>
                        
                        <header className="p-4 flex justify-between items-center z-10">
                            <h1 className="text-2xl font-bold tracking-widest text-kimetsu-green border-b-2 border-white pb-1">
                                {isSpectator ? "æŸ±åˆæœƒè­°ãƒ»ç¾å ´è½‰æ’­" : "æŸ±åˆæœƒè­°ãƒ»ç¦®ç‰©äº¤ä»˜å„€å¼"}
                            </h1>
                            <div className="flex gap-2">
                                {!isSpectator && (
                                    <button onClick={handleLiveReset} className="text-sm border border-red-500 text-red-400 px-3 py-1 rounded hover:bg-red-600 hover:text-white transition font-bold flex items-center gap-1">
                                        <Icons.RotateCw size={14}/> é‡æ–°é–‹å§‹
                                    </button>
                                )}
                                <button onClick={() => setView(isSpectator ? 'home' : 'admin_dashboard')} className="text-sm border border-white px-3 py-1 rounded hover:bg-white hover:text-kimetsu-black transition">é€€å‡ºå„€å¼</button>
                            </div>
                        </header>

                        <div className="flex-1 flex flex-col items-center justify-center p-4 z-10 relative">
                            {!liveReceiver ? (
                                <div className="text-center space-y-8 animate-fade-in">
                                    <div className="text-6xl text-kimetsu-pink animate-pulse">ğŸŒ¸</div>
                                    <h2 className="text-4xl font-bold tracking-widest">
                                        {isSpectator ? "ç­‰å¾…ä¸»å…¬æŠ½ç±¤ä¸­..." : "æº–å‚™é–‹å§‹æŠ½ç±¤"}
                                    </h2>
                                    <p className="text-slate-400">ç›®å‰é‚„æœ‰ {Object.keys(matches).length - liveHistory.length} ä½éšŠå“¡ç­‰å¾…ä¸Šå°</p>
                                    {!isSpectator && (
                                        <button onClick={handleNextLive} disabled={isProcessing} className="px-8 py-4 bg-kimetsu-green text-white text-2xl font-bold rounded-lg shadow-[0_0_15px_rgba(46,204,113,0.6)] hover:scale-105 transition-transform border-2 border-white tracking-widest disabled:opacity-50 disabled:cursor-not-allowed">
                                            {isProcessing ? <Icons.Loader2 size={24} className="animate-spin"/> : nextButtonLabel}
                                        </button>
                                    )}
                                </div>
                            ) : (
                                <div className="w-full max-w-4xl flex flex-col items-center gap-6 animate-slide-up">
                                    <div className="text-center">
                                        <p className={`tracking-[0.5em] text-lg mb-2 font-bold ${style.text.replace('text-','text-kimetsu-green ')}`}>
                                            <span className="text-sm border border-white px-2 py-1 rounded mr-2">{rank}</span> 
                                            å—è´ˆè€… ({style.name})
                                        </p>
                                        <h2 className="text-5xl font-black tracking-widest mb-6 border-b-4 border-kimetsu-pink inline-block pb-2">{liveReceiver.name}</h2>
                                    </div>

                                    <div className="flex flex-col md:flex-row gap-8 items-center justify-center w-full">
                                        {/* Drawing Display via Nezuko Box */}
                                        <div className={`w-full max-w-md aspect-square flex items-center justify-center relative transform rotate-1`}>
                                            {/* NezukoBox is now controlled via props */}
                                            <NezukoBox 
                                                isLocked={false} 
                                                isOpen={liveBoxOpen} 
                                                onClick={isSpectator ? null : toggleBoxOpen}
                                            >
                                                <img src={liveReceiver.drawing} className="w-full h-full object-contain" />
                                            </NezukoBox>
                                        </div>

                                        {/* Giver Reveal Section */}
                                        <div className="flex flex-col items-center gap-6 min-w-[280px]">
                                            <div className="text-6xl text-white">â¬…ï¸</div>
                                            
                                            {!liveShowGiver ? (
                                                isSpectator ? (
                                                    <div className="w-full py-4 border-2 border-dashed border-slate-600 text-slate-400 rounded-lg font-bold text-xl text-center">
                                                        ç­‰å¾…æ­æ›‰...
                                                    </div>
                                                ) : (
                                                    <button onClick={toggleLiveReveal} className="w-full py-4 bg-kimetsu-pink hover:bg-pink-600 text-white rounded-lg font-bold text-xl shadow-lg transition-transform hover:scale-105 border-b-4 border-pink-800 tracking-widest">
                                                        æ­æ›‰é€ç¦®è€…
                                                    </button>
                                                )
                                            ) : (
                                                <div className="w-full text-center animate-fade-in">
                                                    <p className="text-sm text-slate-400 mb-1">é€ç¦®ä¹‹å‘¼å¸ãƒ»å£¹ä¹‹å‹</p>
                                                    <div className="bg-white text-kimetsu-black text-3xl font-black py-4 px-6 rounded border-4 border-kimetsu-green shadow-[0_0_20px_rgba(255,255,255,0.5)] tracking-widest">
                                                        {giver ? giver.name : "æœªçŸ¥"}
                                                    </div>
                                                </div>
                                            )}

                                            {!isSpectator && (
                                                <div className="flex gap-2 w-full mt-8">
                                                    <button 
                                                        onClick={handlePrevLive} 
                                                        disabled={liveIndex <= 0}
                                                        className={`flex-1 px-4 py-3 border-2 border-white text-white rounded font-bold flex items-center justify-center gap-2 transition ${liveIndex <= 0 ? 'opacity-30 cursor-not-allowed' : 'hover:bg-white hover:text-kimetsu-black'}`}
                                                    >
                                                        <Icons.ArrowLeft size={20}/> ä¸Šä¸€ä½
                                                    </button>
                                                    <button 
                                                        onClick={handleNextLive} 
                                                        disabled={isProcessing}
                                                        className="flex-1 px-4 py-3 border-2 border-white text-white rounded hover:bg-white hover:text-kimetsu-black transition font-bold flex items-center justify-center gap-2 disabled:opacity-50"
                                                    >
                                                        {nextButtonLabel} <Icons.ArrowRight size={20}/>
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            if (view === 'admin_dashboard') {
                return (
                    <div className="min-h-screen flex flex-col">
                         <header className="bg-kimetsu-black text-white p-4 shadow-md flex justify-between items-center sticky top-0 z-20 border-b-4 border-kimetsu-green">
                            <div className="flex items-center gap-2">
                                <Icons.Settings className="text-kimetsu-green" />
                                <h1 className="text-lg font-bold tracking-widest">é¬¼æ®ºéšŠç¸½éƒ¨å¾Œå°</h1>
                            </div>
                            <button onClick={() => { setIsAdmin(false); setView('home'); }} className="text-xs bg-slate-800 px-3 py-1.5 rounded flex items-center gap-1 hover:bg-slate-700 transition border border-slate-600 font-bold">
                                <Icons.LogOut size={14}/> é›¢é–‹
                            </button>
                        </header>
                        <div className="p-4 max-w-5xl mx-auto w-full space-y-6">
                            
                            {/* Live Event Button */}
                            <div className="bg-gradient-to-r from-kimetsu-black to-slate-800 p-6 rounded shadow-lg border-2 border-kimetsu-green relative overflow-hidden text-white flex justify-between items-center">
                                <div>
                                    <h3 className="text-2xl font-bold tracking-widest text-kimetsu-green mb-1">æŸ±åˆæœƒè­°ãƒ»ç¾å ´æ¨¡å¼</h3>
                                    <p className="text-sm text-slate-300">é–‹å•Ÿå¤§è¢å¹•ï¼Œé€²è¡Œç¾å ´éš¨æ©ŸæŠ½ç±¤èˆ‡ç¦®ç‰©äº¤ä»˜å„€å¼ã€‚</p>
                                </div>
                                <button onClick={() => setView('admin_live')} className="px-6 py-3 bg-kimetsu-pink hover:bg-pink-600 text-white font-bold rounded shadow-lg border-2 border-white flex items-center gap-2 transition-transform hover:scale-105">
                                    <Icons.Mic size={20}/> é€²å…¥æœƒå ´
                                </button>
                            </div>

                            {/* Control Panel */}
                            <div className="bg-white p-6 rounded shadow-lg border-2 border-kimetsu-black relative">
                                <h3 className="font-bold text-kimetsu-black mb-4 border-b-2 border-kimetsu-green pb-2 tracking-widest">ä»»å‹™æŒ‡æ´¾</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="space-y-2">
                                        <p className="text-sm text-slate-600 font-bold">ç•¶æ‰€æœ‰åŠå£«å®Œæˆå·è»¸å¾Œï¼Œé€²è¡Œä»»å‹™åˆ†é…ã€‚</p>
                                        <button onClick={performMatching} disabled={isProcessing} className="w-full py-3 bg-kimetsu-green hover:bg-green-600 text-white rounded font-bold shadow-md flex items-center justify-center gap-2 border-b-4 border-green-800 tracking-widest">
                                            <Icons.Shuffle size={20}/> {Object.keys(matches).length > 0 ? 'é‡æ–°æŒ‡æ´¾ä»»å‹™' : 'é–‹å§‹æŒ‡æ´¾ä»»å‹™'}
                                        </button>
                                    </div>
                                    <div className="space-y-2">
                                        <p className="text-sm text-slate-600 font-bold">æ´»å‹•çµæŸå¾Œï¼ŒéŠ·æ¯€æ‰€æœ‰å·è»¸é‡æ–°é–‹å§‹ã€‚</p>
                                        {/* Updated LongPressButton usage */}
                                        <LongPressButton 
                                            label="éŠ·æ¯€æ‰€æœ‰è³‡æ–™" 
                                            icon={Icons.Trash2} 
                                            onComplete={handleReset} 
                                            disabled={isProcessing}
                                        />
                                    </div>
                                </div>
                            </div>

                            {/* Match List */}
                            {Object.keys(matches).length > 0 && (
                                <div className="bg-white p-6 rounded shadow-lg border-2 border-kimetsu-black">
                                    <h3 className="font-bold text-kimetsu-black mb-4 border-b-2 border-kimetsu-green pb-2 tracking-widest">ä»»å‹™åå–® (åƒ…ä¸»å…¬å¯è¦‹)</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm font-bold">
                                        {users.map(u => {
                                            const recId = matches[u.id];
                                            const rec = users.find(r => r.id === recId);
                                            return (
                                                <div key={u.id} className="flex justify-between p-2 bg-kimetsu-bg rounded border border-slate-300">
                                                    <span>ğŸ—¡ï¸ <span className="text-kimetsu-dark-green">{u.name}</span></span>
                                                    <span className="text-slate-400 mx-2">âœ è´ˆèˆ‡ âœ</span>
                                                    <span><span className="text-kimetsu-black">{rec?.name}</span> ğŸ</span>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {/* Gallery */}
                            <div className="bg-white p-6 rounded shadow-lg border-2 border-kimetsu-black">
                                <div className="flex justify-between items-end mb-4 border-b-2 border-kimetsu-green pb-2">
                                    <h3 className="font-bold text-kimetsu-black tracking-widest">éšŠå“¡å·è»¸ ({users.length}äºº)</h3>
                                    <button 
                                        onClick={() => setShowAdminPasswords(!showAdminPasswords)}
                                        className={`text-xs flex items-center gap-1 px-3 py-1 rounded transition font-bold border-2 ${showAdminPasswords ? 'bg-kimetsu-pink text-white border-kimetsu-pink' : 'bg-white text-slate-500 border-slate-300'}`}
                                    >
                                        {showAdminPasswords ? <Icons.EyeOff size={14}/> : <Icons.Eye size={14}/>}
                                        {showAdminPasswords ? 'éš±è—å¯†ç¢¼' : 'é¡¯ç¤ºå¯†ç¢¼(æ•‘æ´ç”¨)'}
                                    </button>
                                </div>
                                
                                {users.length === 0 ? (
                                    <p className="text-center text-slate-400 py-8 font-bold">ç›®å‰å°šç„¡éšŠå“¡åŠ å…¥...</p>
                                ) : (
                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                        {users.map(u => {
                                            const style = getStyle(u.style || 'default');
                                            const rank = u.rank || 'ç™¸';
                                            return (
                                                <div key={u.id} className={`border-4 ${style.border} ${style.bg} rounded p-2 relative group shadow-sm transition-all`}>
                                                    <div className={`absolute top-0 right-0 p-1 text-xs font-bold ${style.text} flex items-center gap-1`}>
                                                        <span className="border border-current px-1 rounded-sm text-[10px]">{rank}</span>
                                                        {style.icon} {style.name}
                                                    </div>
                                                    <div className="aspect-square bg-white border border-slate-300 overflow-hidden mb-2 mt-6">
                                                        <img src={u.drawing} className="w-full h-full object-contain" />
                                                    </div>
                                                    <div className="flex flex-col">
                                                        <div className="flex justify-between items-center mb-1">
                                                            <span className={`font-bold text-sm truncate ${style.text}`}>{u.name}</span>
                                                            {matches[u.id] && <span className="text-[10px] bg-kimetsu-green text-white px-2 py-0.5 rounded font-bold">å·²æŒ‡æ´¾</span>}
                                                        </div>
                                                        {showAdminPasswords && (
                                                            <div className="bg-red-50 text-red-600 text-[10px] p-1 rounded font-mono break-all border border-red-200 font-bold">
                                                                {u.password}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            )
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                )
            }

            // --- User Login View ---
            if (view === 'user_login') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="bg-white p-8 rounded shadow-2xl max-w-sm w-full border-4 border-kimetsu-black relative">
                            <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-kimetsu-black tracking-widest border-b-2 border-kimetsu-green pb-2">
                                <Icons.Lock className="text-kimetsu-green"/> éšŠå“¡èº«ä»½é©—è­‰
                            </h2>
                            <p className="text-kimetsu-black font-bold mb-1">æ­¡è¿å›ä¾†ï¼Œ{loginTargetUser?.name}ï¼</p>
                            <p className="text-slate-500 text-xs mb-4">è«‹è¼¸å…¥å¯†ç¢¼ä»¥è§£é–‹å·è»¸ã€‚</p>
                            <input 
                                type="password" 
                                value={userPasswordInput}
                                onChange={e => setUserPasswordInput(e.target.value)}
                                className="w-full p-3 border-2 border-kimetsu-black rounded mb-2 outline-none focus:ring-2 ring-kimetsu-green bg-kimetsu-bg text-center font-bold tracking-widest"
                                placeholder="è¼¸å…¥å¯†ç¢¼"
                            />
                            <p className="text-center text-[10px] text-slate-400 mb-4 font-bold">è‹¥å¯†ç¢¼çœŸçš„å¿˜è¨˜äº†ï¼Œè«‹æ´½å°æ©</p>
                            <div className="flex gap-2">
                                <button onClick={() => setView('reveal')} className="flex-1 py-2 bg-slate-200 text-slate-600 rounded font-bold hover:bg-slate-300 transition">å–æ¶ˆ</button>
                                <button onClick={handleUserLogin} className="flex-1 py-2 bg-kimetsu-black text-white rounded font-bold hover:bg-slate-800 transition border-b-4 border-slate-900">è§£é–‹å·è»¸</button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Main Public App UI
            return (
                <div className="min-h-screen relative overflow-hidden flex flex-col items-center">
                    
                    <div className="relative z-10 w-full max-w-md min-h-screen bg-kimetsu-bg shadow-2xl flex flex-col border-x-4 border-kimetsu-black">
                        <header className="bg-kimetsu-black p-4 text-white shadow-md flex justify-between items-center border-b-4 border-kimetsu-green">
                            <div className="flex items-center gap-2">
                                <Icons.Sword className="text-kimetsu-green drop-shadow-md" size={28} />
                                <h1 className="text-xl font-bold tracking-widest text-kimetsu-green">é¬¼æ»…ä¹‹åˆƒäº¤æ›é“å ´</h1>
                            </div>
                            <div className="flex items-center gap-2">
                                {mode === 'cloud' && <span className="text-xs bg-slate-700 px-2 py-1 rounded flex items-center gap-1 font-bold border border-slate-500 text-kimetsu-green"><Icons.Cloud size={12}/> é€£ç·šä¸­</span>}
                            </div>
                        </header>

                        <main className="flex-1 p-6 flex flex-col relative bg-[url('https://www.transparenttextures.com/patterns/rice-paper.png')]">
                            {isProcessing && <div className="absolute inset-0 z-50 bg-white/80 flex items-center justify-center"><div className="spinner"></div></div>}

                            {view === 'home' && (
                                <div className="flex flex-col items-center justify-center h-full gap-8 animate-fade-in relative">
                                    <div className="text-center space-y-4">
                                        <div className="inline-block p-4 border-4 border-kimetsu-black bg-white shadow-lg rotate-1">
                                            <h2 className="text-3xl font-bold text-kimetsu-black tracking-widest border-2 border-kimetsu-green p-2">å…¨é›†ä¸­ãƒ»äº¤æ›ä¹‹å‘¼å¸</h2>
                                        </div>
                                        <div className="bg-white px-6 py-2 rounded border-2 border-kimetsu-black shadow-sm inline-block">
                                            <p className="text-kimetsu-black font-bold">ç¾ä»»éšŠå“¡ï¼š <span className="text-kimetsu-pink text-2xl font-black">{users.length}</span> å</p>
                                        </div>
                                    </div>
                                    <div className="w-full space-y-4 mt-4">
                                        {!myParticipantId ? (
                                            <button onClick={startDrawing} className="w-full py-4 bg-kimetsu-green hover:bg-green-500 text-white rounded shadow-lg flex items-center justify-center gap-3 text-lg font-bold active:scale-95 transition-transform border-b-4 border-green-800 tracking-widest relative overflow-hidden group">
                                                <div className="absolute inset-0 bg-white/10 translate-y-full group-hover:translate-y-0 transition-transform"></div>
                                                <Icons.PenTool size={24}/> å…¥éšŠè€ƒæ ¸ (ç¹ªè£½å·è»¸)
                                            </button>
                                        ) : (
                                            <button onClick={() => setView('my_card')} className="w-full py-4 bg-white border-4 border-kimetsu-green text-kimetsu-dark-green hover:bg-green-50 rounded flex items-center justify-center gap-2 font-bold shadow-md active:scale-95 transition-transform tracking-widest">
                                                <Icons.Image size={24}/> æŸ¥çœ‹æˆ‘çš„ä»»å‹™å·è»¸
                                            </button>
                                        )}
                                        <button onClick={() => setView('participants')} className="w-full py-4 bg-kimetsu-black border-2 border-slate-600 hover:bg-slate-800 text-white rounded shadow-lg flex items-center justify-center gap-3 text-lg font-bold transition-transform active:scale-95 tracking-widest">
                                            <Icons.Users size={24}/> æŸ¥çœ‹éšŠå“¡åå†Š
                                        </button>
                                        
                                        {/* Task Assignment Button: Always Visible if Users exist */}
                                        {users.length > 0 && (
                                            <>
                                                <button onClick={() => setView('reveal')} className={`w-full py-4 ${Object.keys(matches).length > 0 ? 'bg-kimetsu-pink hover:bg-pink-400 border-pink-600' : 'bg-kimetsu-black hover:bg-slate-800 border-slate-900'} text-white rounded shadow-lg flex items-center justify-center gap-3 text-lg font-bold mt-8 ${Object.keys(matches).length > 0 ? 'animate-pulse' : ''} border-b-4 active:scale-95 transition-transform tracking-widest`}>
                                                    {Object.keys(matches).length > 0 ? <><Icons.Eye size={24}/> ä»»å‹™ä¸‹é”ï¼ç¢ºèªç›®æ¨™</> : <><Icons.Lock size={24}/> éšŠå“¡é›†åˆï¼ç¢ºèªå·è»¸</>}
                                                </button>
                                                
                                                {/* NEW SPECTATOR BUTTON */}
                                                <button onClick={() => setView('spectator_live')} className="w-full py-4 bg-blue-600 hover:bg-blue-500 border-blue-800 text-white rounded shadow-lg flex items-center justify-center gap-3 text-lg font-bold border-b-4 active:scale-95 transition-transform tracking-widest mt-2">
                                                    <Icons.Tv size={24}/> é€²å…¥æœƒå ´ (è§€çœ‹æ¨¡å¼)
                                                </button>
                                            </>
                                        )}
                                    </div>
                                    
                                    {/* Admin & Footer Links */}
                                    <div className="mt-auto pt-8 flex flex-col items-center gap-3 w-full">
                                        {myParticipantId && (
                                            <button onClick={handleManualLogout} className="text-xs text-slate-500 hover:text-kimetsu-black flex items-center gap-1 py-2 px-4 rounded border-2 border-slate-300 hover:border-kimetsu-black transition mb-2 font-bold">
                                                <Icons.LogOut size={14}/> éš±é€€ (æ¸…é™¤ç‹€æ…‹)
                                            </button>
                                        )}
                                        <button onClick={() => setView('admin_login')} className="text-sm text-kimetsu-black hover:text-kimetsu-green flex items-center gap-2 py-2 px-4 rounded transition font-bold bg-white border border-kimetsu-black shadow-sm">
                                            <Icons.Lock size={16}/> é¬¼æ®ºéšŠç¸½éƒ¨ (Admin)
                                        </button>

                                        {mode === 'offline' && (
                                            <div className="text-xs text-slate-400 font-bold">
                                                <button onClick={()=>{localStorage.removeItem('fb_config_override');window.location.reload()}} className="underline ml-1 hover:text-kimetsu-black transition">é‡è¨­é€£ç·š</button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {view === 'draw' && <DrawingPad initialData={editData} onSave={saveUser} onCancel={() => setView(editData ? 'my_card' : 'home')} Icons={Icons} />}
                            
                            {view === 'my_card' && (
                                <div className="flex flex-col h-full animate-fade-in">
                                    <div className="flex items-center justify-center mb-4">
                                         <h2 className="text-2xl font-bold text-center text-kimetsu-black tracking-widest border-b-4 border-kimetsu-green pb-1">æˆ‘çš„ä»»å‹™å·è»¸</h2>
                                    </div>
                                    {(() => {
                                        const me = users.find(u => u.id === myParticipantId);
                                        if (!me) return (
                                            <div className="flex flex-col items-center justify-center py-10 text-slate-500 gap-4 bg-white rounded border-2 border-kimetsu-black p-8 shadow-md">
                                                <p className="font-bold text-lg">æ‰¾ä¸åˆ°å·è»¸ï¼Œå¯èƒ½å·²è¢«éŠ·æ¯€ã€‚</p>
                                                <button onClick={handleManualLogout} className="px-6 py-3 bg-kimetsu-black text-white rounded text-sm font-bold shadow-md border-b-4 border-slate-700 hover:bg-slate-800 transition">è¿”å›é¦–é </button>
                                            </div>
                                        );
                                        const isLocked = !!matches[me.id];
                                        const style = getStyle(me.style || 'default');
                                        const rank = me.rank || 'ç™¸';

                                        return (
                                            <div className="flex-1 flex flex-col items-center">
                                                <div className={`w-full p-6 rounded shadow-lg border-4 ${style.border} ${style.bg} mb-6 relative`}>
                                                    <div className={`absolute -top-3 -right-3 px-2 py-1 bg-white border-2 ${style.border} rounded text-xs font-bold`}>{style.icon} {style.name}</div>
                                                    <div className="flex justify-between items-center mb-4 border-b-2 border-slate-200 pb-2">
                                                        <span className={`text-sm font-bold ${style.text}`}>éšŠå“¡éšç´š: {rank}</span>
                                                        <span className={`font-bold text-xl ${style.text}`}>{me.name}</span>
                                                    </div>
                                                    
                                                    {/* Nezuko Box for My Card - Force unlocked so user can see their own drawing */}
                                                    <LocalNezukoBox isLocked={false} defaultOpen={true}>
                                                        <div className="w-full h-full flex items-center justify-center relative">
                                                            <img src={me.drawing} className="w-full h-full object-contain" />
                                                            <span className="absolute bottom-2 right-2 text-xs bg-black/50 text-white px-2 py-1 rounded">æ‚¨çš„ç•«ä½œ</span>
                                                        </div>
                                                    </LocalNezukoBox>
                                                </div>

                                                {isLocked ? (
                                                    <div className="w-full p-6 bg-slate-100 text-slate-600 rounded text-sm text-center mb-6 border-l-4 border-kimetsu-black shadow-md">
                                                        <p className="font-bold mb-2 text-lg text-kimetsu-black">ğŸ”’ ä»»å‹™å·²ä¸‹é”ï¼</p>
                                                        ç„¡æ³•å†ä¿®æ”¹å·è»¸å…§å®¹ï¼
                                                    </div>
                                                ) : (
                                                    <button onClick={editMyCard} className="w-full py-4 bg-kimetsu-black hover:bg-slate-800 text-white rounded shadow-md font-bold flex items-center justify-center gap-2 mb-6 border-b-4 border-slate-900 active:scale-95 transition-transform tracking-widest">
                                                        <Icons.Edit size={24}/> ä¿®æ”¹å·è»¸
                                                    </button>
                                                )}
                                                
                                                <button onClick={() => setView('home')} className="w-full py-4 bg-white text-kimetsu-black font-bold rounded mt-auto border-2 border-kimetsu-black hover:bg-slate-100 transition shadow-sm active:scale-95 tracking-widest">è¿”å›é“å ´</button>
                                            </div>
                                        );
                                    })()}
                                </div>
                            )}

                            {view === 'participants' && (
                                <div className="flex flex-col h-full">
                                    <h2 className="text-2xl font-bold mb-6 flex items-center gap-3 text-kimetsu-black border-l-4 border-kimetsu-green pl-3 tracking-widest">é¬¼æ®ºéšŠåå†Š</h2>
                                    <div className="flex-1 overflow-y-auto space-y-4 pr-2">
                                        {users.length === 0 ? <div className="text-center text-slate-500 mt-10 font-bold text-lg bg-white p-8 rounded border-2 border-slate-300">å°šç„¡éšŠå“¡å…¥éšŠ...</div> : users.map((u, idx) => {
                                            const style = getStyle(u.style || 'default');
                                            const rank = u.rank || 'ç™¸';
                                            return (
                                                <div key={u.id} className={`p-4 rounded flex justify-between items-center border-2 shadow-sm transition-transform hover:translate-x-1 ${isMe(u.id) ? `bg-green-50 border-kimetsu-green` : `${style.bg} ${style.border}`}`}>
                                                    <div className="flex items-center gap-3">
                                                        <span className={`font-bold text-lg ${style.text} font-mono`}>#{idx + 1}</span>
                                                        <span className={`font-bold text-lg ${style.text}`}>
                                                            <span className="text-xs border border-current px-1 rounded mr-1">{rank}</span>
                                                            {style.icon} {u.name}
                                                        </span>
                                                        {isMe(u.id) && <span className="text-xs bg-kimetsu-black text-white px-2 py-1 rounded font-bold">æˆ‘</span>}
                                                    </div>
                                                    <span className="text-xs text-slate-500 font-bold border border-slate-300 px-2 py-1 rounded flex items-center gap-1"><Icons.Check size={12}/> å·è»¸å®Œæˆ</span>
                                                </div>
                                            )
                                        })}
                                    </div>
                                    <button onClick={() => setView('home')} className="mt-6 w-full py-4 bg-kimetsu-black text-white font-bold rounded border-b-4 border-slate-900 hover:bg-slate-800 transition shadow-md active:scale-95 tracking-widest">è¿”å›é“å ´</button>
                                </div>
                            )}

                            {view === 'reveal' && (
                                <div className="flex flex-col h-full">
                                    <div className="text-center mb-8">
                                        <h2 className="text-3xl font-bold text-kimetsu-black tracking-widest border-b-2 border-kimetsu-green inline-block pb-2">
                                            {Object.keys(matches).length > 0 ? "ä»»å‹™ä¸‹é”" : "å·è»¸ç¢ºèª"}
                                        </h2>
                                        <p className="text-slate-600 font-bold mt-4">è«‹é»é¸ä½ çš„åå­—è§£é–‹å·è»¸</p>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4 overflow-y-auto pb-6 pr-2">
                                        {users.map((u) => {
                                            const style = getStyle(u.style || 'default');
                                            return (
                                                <button key={u.id} onClick={() => promptUserLogin(u)} className={`p-6 border-2 rounded shadow-md flex flex-col items-center justify-center aspect-square transition-all relative group active:scale-95 ${isMe(u.id) ? 'bg-green-50 border-kimetsu-green ring-2 ring-green-200' : `${style.bg} ${style.border} hover:opacity-90`}`}>
                                                    {isMe(u.id) && <div className="absolute top-2 right-2 text-white bg-kimetsu-black px-2 py-0.5 rounded text-xs font-bold">æˆ‘</div>}
                                                    <Icons.Lock size={32} className={`${isMe(u.id) ? 'text-kimetsu-green' : style.text} mb-3 group-hover:scale-110 transition-transform`} />
                                                    <span className={`font-bold ${style.text} text-lg truncate w-full text-center`}>{u.name}</span>
                                                </button>
                                            )
                                        })}
                                    </div>
                                    <button onClick={() => setView('home')} className="mt-auto w-full py-4 bg-kimetsu-black text-white font-bold rounded border-b-4 border-slate-900 hover:bg-slate-800 transition shadow-md active:scale-95 tracking-widest">è¿”å›é“å ´</button>
                                </div>
                            )}

                            {view === 'check_result' && revealData && (
                                <div className="flex flex-col h-full items-center justify-center text-center animate-fade-in">
                                    <div className="mb-8 p-4 border-y-4 border-kimetsu-green w-full bg-kimetsu-black">
                                        <span className="text-xs text-kimetsu-green uppercase tracking-widest font-bold block mb-1">TO: éšŠå“¡</span>
                                        <h2 className="text-3xl font-extrabold text-white drop-shadow-sm">{revealData.giver.name}</h2>
                                    </div>
                                    <div className="w-full bg-white p-8 rounded shadow-2xl border-4 border-kimetsu-black mb-8 relative overflow-hidden">
                                        <div className="absolute -top-10 -right-10 w-24 h-24 bg-kimetsu-pink rotate-45 opacity-50"></div>
                                        <div className="absolute -bottom-10 -left-10 w-24 h-24 bg-kimetsu-green rotate-45 opacity-50"></div>
                                        
                                        <p className="text-slate-500 mb-4 font-bold text-lg">ä½ è¦è´ˆé€ç¦®ç‰©çš„å°è±¡æ˜¯ï¼š</p>
                                        
                                        {/* Masked Name */}
                                        <div className="text-3xl font-black text-kimetsu-black mb-6 bg-kimetsu-bg py-4 px-8 rounded border-2 border-dashed border-kimetsu-black relative z-10 tracking-widest">
                                            ??? (ç¥ç§˜éšŠå“¡)
                                        </div>
                                        
                                        <div className="mb-6 bg-orange-50 border-l-4 border-orange-500 p-3 text-orange-700 font-bold text-sm text-left">
                                            <span className="block mb-1 text-lg">âš ï¸ ä¸»å…¬æŒ‡ä»¤ï¼š</span>
                                            è«‹æº–å‚™ç¬¦åˆä¸‹æ–¹å·è»¸å…§å®¹çš„ç¦®ç‰©ï¼Œä¸¦æ–¼é›†æœƒæ™‚äº¤ä»˜ï¼
                                        </div>
                                        
                                        <div className="bg-white border-4 border-double border-slate-300 rounded p-2 shadow-inner inline-block relative z-10 w-full max-w-sm aspect-square">
                                            {/* User Result Nezuko Box */}
                                            <LocalNezukoBox isLocked={false}>
                                                {revealData.receiver ? <img src={revealData.receiver.drawing} className="w-full h-full object-contain" /> : "Error"}
                                            </LocalNezukoBox>
                                        </div>
                                    </div>
                                    <button onClick={() => setView('reveal')} className="w-full py-4 bg-kimetsu-pink text-white font-bold rounded shadow-lg border-b-4 border-pink-700 hover:bg-pink-400 transition active:scale-95 tracking-widest">éµå‘½ï¼(ç™»å‡º)</button>
                                </div>
                            )}
                        </main>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
