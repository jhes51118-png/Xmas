<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聖誕一筆畫交換 (通用版)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in; }
        .animate-slide-up { animation: slideUp 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        /* Loading Spinner for initial load */
        #initial-loader { position: fixed; inset: 0; background: #f8fafc; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid #dc2626; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden-loader { opacity: 0; pointer-events: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    
    <!-- 初始載入畫面 (避免 React 載入前白屏) -->
    <div id="initial-loader">
        <div class="spinner"></div>
        <p class="mt-4 text-slate-500 font-medium">正在載入聖誕派對...</p>
        <p id="error-msg" class="mt-2 text-red-500 text-sm max-w-md text-center hidden"></p>
    </div>

    <div id="root"></div>

    <!-- Global Error Handler -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            const loader = document.getElementById('initial-loader');
            const errText = document.getElementById('error-msg');
            if (loader && errText) {
                loader.classList.remove('hidden-loader'); // Ensure loader is visible
                document.querySelector('.spinner').style.display = 'none'; // Hide spinner
                errText.classList.remove('hidden');
                errText.innerHTML = `<strong>發生錯誤：</strong><br>${msg}<br><span style="font-size:10px; color:#94a3b8">${url}:${line}</span><br><br>如果您是在電腦上直接打開 html 檔案，請確保網路連線正常。`;
            }
            return false;
        };
    </script>

    <!-- React App Script -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18?dev';
        import { createRoot } from 'https://esm.sh/react-dom@18/client?dev';
        
        // Firebase Imports (Web SDK)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, collection, addDoc, onSnapshot, 
            doc, setDoc, deleteDoc, getDocs, writeBatch, serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // --- 簡易圖示元件 (SVG) ---
        const Icon = ({ path, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );
        // 修復了 WifiOff 和 Settings 的語法錯誤 (加上了 <></>)
        const Icons = {
            Gift: (p) => <Icon {...p} path={<><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></>} />,
            PenTool: (p) => <Icon {...p} path={<><path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/></>} />,
            Users: (p) => <Icon {...p} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />,
            Shuffle: (p) => <Icon {...p} path={<><path d="M2 18h1.4c1.3 0 2.5-.6 3.3-1.7l14.2-12.6"/><path d="m22 2-5 5"/><path d="m17 2 5 5"/><path d="M2 6h1.4c1.3 0 2.5.6 3.3 1.7l14.2 12.6"/><path d="m22 22-5-5"/><path d="m17 22 5-5"/></>} />,
            Eye: (p) => <Icon {...p} path={<><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></>} />,
            Snowflake: (p) => <Icon {...p} path={<><line x1="2" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="22"/><path d="m20 20-4-4"/><path d="m4 4 4 4"/><path d="m4 20 4-4"/><path d="m20 4-4 4"/></>} />,
            RotateCcw: (p) => <Icon {...p} path={<><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></>} />,
            Save: (p) => <Icon {...p} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />,
            Check: (p) => <Icon {...p} path={<polyline points="20 6 9 17 4 12"/>} />,
            Cloud: (p) => <Icon {...p} path={<path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19 8.963 24.5 12 24.5s5.5-2.463 5.5-5.5z" />} />,
            WifiOff: (p) => <Icon {...p} path={<><line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></>} />,
            Settings: (p) => <Icon {...p} path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />,
            Loader2: (p) => <Icon {...p} className={`${p.className} animate-spin`} path={<path d="M21 12a9 9 0 1 1-6.219-8.56" />} />,
        };

        // --- Config Wizard Component ---
        const ConfigWizard = ({ onConfigComplete, onOfflineMode }) => {
            const [inputConfig, setInputConfig] = useState('');
            const [error, setError] = useState('');

            const handleSave = () => {
                try {
                    let configStr = inputConfig.trim();
                    // Remove variable declarations like "const firebaseConfig ="
                    configStr = configStr.replace(/^(const|let|var|export\s+const)\s+\w+\s*=\s*/, '');
                    // Remove trailing semicolon
                    configStr = configStr.replace(/;$/, '');
                    
                    let config;
                    try {
                        // 1. Try standard JSON first
                        config = JSON.parse(configStr);
                    } catch (e1) {
                        try {
                            // 2. If not JSON, try to treat as JS object
                            // If it doesn't start with {, assume it's a list of properties and wrap it
                            let jsStr = configStr;
                            if (!jsStr.startsWith('{')) {
                                jsStr = `{${jsStr}}`;
                            }
                            // Use Function to parse JS object literal (handles unquoted keys, single quotes, trailing commas)
                            // This avoids the regex issues with colons inside values (like in appId or URLs)
                            const fn = new Function(`return ${jsStr}`);
                            config = fn();
                        } catch (e2) {
                            throw new Error("無法解析內容，請檢查格式。");
                        }
                    }

                    if (!config || typeof config !== 'object') throw new Error("設定必須是物件格式");
                    if (!config.apiKey) throw new Error("缺少 apiKey");
                    
                    localStorage.setItem('fb_config_override', JSON.stringify(config));
                    onConfigComplete(config);
                } catch(e) {
                    setError('無法解析：' + e.message + '。建議直接從 Firebase Console 複製整段 config 物件。');
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4 bg-slate-50">
                    <div className="bg-white p-8 rounded-2xl shadow-xl max-w-lg w-full">
                        <div className="flex justify-center mb-4 text-red-600"><Icons.Settings size={48} /></div>
                        <h2 className="text-2xl font-bold text-center mb-2">設定您的交換禮物網站</h2>
                        <p className="text-slate-500 text-center mb-6">偵測不到 Firebase 設定。若要使用「雲端同步」功能，請貼上 Firebase Config；或選擇「離線模式」試玩。</p>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">貼上 Firebase Config JSON:</label>
                                <textarea 
                                    className="w-full h-32 p-3 border rounded-lg text-xs font-mono bg-slate-50 focus:ring-2 ring-red-500 outline-none"
                                    placeholder='請直接貼上 Firebase Console 裡的 config 程式碼，例如：&#10;const firebaseConfig = {&#10;  apiKey: "...",&#10;  ...&#10;};'
                                    value={inputConfig}
                                    onChange={e => setInputConfig(e.target.value)}
                                ></textarea>
                                {error && <p className="text-red-500 text-xs mt-1 whitespace-pre-wrap">{error}</p>}
                            </div>
                            
                            <button onClick={handleSave} className="w-full py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold transition">
                                儲存並連線雲端
                            </button>

                            <div className="relative my-4">
                                <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-200"></div></div>
                                <div className="relative flex justify-center text-sm"><span className="px-2 bg-white text-slate-500">或是</span></div>
                            </div>

                            <button onClick={onOfflineMode} className="w-full py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-bold flex items-center justify-center gap-2 transition">
                                <Icons.WifiOff size={20} />
                                使用離線模式 (單機試玩)
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [mode, setMode] = useState('loading'); // loading, setup, cloud, offline
            const [view, setView] = useState('home'); 
            const [users, setUsers] = useState([]);
            const [matches, setMatches] = useState({});
            const [myParticipantId, setMyParticipantId] = useState(localStorage.getItem('my_participant_id'));
            const [revealData, setRevealData] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            
            // Firebase refs
            const appRef = useRef(null);
            const authRef = useRef(null);
            const dbRef = useRef(null);
            const appId = 'default-app-id';

            // 1. Initial Config Check
            useEffect(() => {
                const initSystem = async () => {
                    // Remove Loading Spinner in DOM
                    const loader = document.getElementById('initial-loader');
                    if(loader) loader.classList.add('hidden-loader');

                    let config = null;
                    try {
                        // Priority 1: Environment Variable (Preview Mode)
                        if (typeof __firebase_config !== 'undefined') {
                            config = JSON.parse(__firebase_config);
                        } 
                        // Priority 2: LocalStorage Override (User pasted config)
                        else {
                            const saved = localStorage.getItem('fb_config_override');
                            if(saved) config = JSON.parse(saved);
                        }

                        // Check if valid config exists
                        if (config && config.apiKey) {
                            try {
                                appRef.current = initializeApp(config);
                                authRef.current = getAuth(appRef.current);
                                dbRef.current = getFirestore(appRef.current);
                                
                                // Auth
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    await signInWithCustomToken(authRef.current, __initial_auth_token);
                                } else {
                                    await signInAnonymously(authRef.current);
                                }
                                
                                setMode('cloud');
                            } catch (err) {
                                console.error("Firebase Init Failed", err);
                                // If init fails (e.g. bad key), go to setup
                                setMode('setup'); 
                            }
                        } else {
                            setMode('setup');
                        }
                    } catch (e) {
                        console.log("Config parse error", e);
                        setMode('setup');
                    }
                };
                initSystem();
            }, []);

            // 2. Data Sync (Cloud Mode Only)
            useEffect(() => {
                if (mode !== 'cloud' || !dbRef.current) return;

                const participantsRef = collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'participants');
                const unsubUsers = onSnapshot(participantsRef, (snapshot) => {
                    const usersList = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    usersList.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                    setUsers(usersList);
                }, err => console.error(err));

                const matchesRef = collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'matches');
                const unsubMatches = onSnapshot(matchesRef, (snapshot) => {
                    const matchesMap = {};
                    snapshot.docs.forEach(d => matchesMap[d.id] = d.data().receiverId);
                    setMatches(matchesMap);
                }, err => console.error(err));

                return () => { unsubUsers(); unsubMatches(); };
            }, [mode]);

            // 3. Local Data Sync (Offline Mode Only)
            useEffect(() => {
                if (mode !== 'offline') return;
                // Load initial
                const savedUsers = localStorage.getItem('xmas_users');
                const savedMatches = localStorage.getItem('xmas_matches');
                if (savedUsers) setUsers(JSON.parse(savedUsers));
                if (savedMatches) setMatches(JSON.parse(savedMatches));
            }, [mode]);

            // Handlers
            const handleOfflineMode = () => {
                setMode('offline');
                setView('home');
            };

            const handleConfigComplete = (config) => {
                // Reload to apply config cleanly
                window.location.reload();
            };

            const handleReset = async () => {
                if (!confirm('確定要刪除所有資料？這將清空所有人的進度！')) return;
                setIsProcessing(true);
                
                if (mode === 'cloud') {
                    try {
                        const usersSnap = await getDocs(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'participants'));
                        const batch1 = writeBatch(dbRef.current);
                        usersSnap.docs.forEach((d) => batch1.delete(d.ref));
                        await batch1.commit();

                        const matchesSnap = await getDocs(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'matches'));
                        const batch2 = writeBatch(dbRef.current);
                        matchesSnap.docs.forEach((d) => batch2.delete(d.ref));
                        await batch2.commit();
                    } catch (e) { alert('重置失敗'); }
                } else {
                    localStorage.removeItem('xmas_users');
                    localStorage.removeItem('xmas_matches');
                    setUsers([]);
                    setMatches({});
                }
                
                localStorage.removeItem('my_participant_id');
                setMyParticipantId(null);
                setView('home');
                setIsProcessing(false);
            };

            const startDrawing = () => {
                if (myParticipantId && users.find(u => u.id === myParticipantId)) {
                    alert('你已經參加過了喔！');
                    return;
                }
                setView('draw');
            };

            const saveUser = async (name, drawingData) => {
                setIsProcessing(true);
                try {
                    if (mode === 'cloud') {
                        const userUid = authRef.current?.currentUser?.uid || 'anon';
                        const docRef = await addDoc(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'participants'), {
                            name, drawing: drawingData, createdAt: serverTimestamp(), uid: userUid
                        });
                        localStorage.setItem('my_participant_id', docRef.id);
                        setMyParticipantId(docRef.id);
                    } else {
                        // Offline Logic
                        const newUser = { id: Date.now().toString(), name, drawing: drawingData, uid: 'local' };
                        const newUsers = [...users, newUser];
                        setUsers(newUsers);
                        localStorage.setItem('xmas_users', JSON.stringify(newUsers));
                        localStorage.setItem('my_participant_id', newUser.id);
                        setMyParticipantId(newUser.id);
                    }
                    setView('home');
                } catch (e) { console.error(e); alert('上傳失敗'); }
                setIsProcessing(false);
            };

            const performMatching = async () => {
                if (users.length < 2) { alert('至少需要兩位玩家！'); return; }
                if (Object.keys(matches).length > 0 && !confirm('已經分配過了，要重新分配嗎？')) return;
                
                setIsProcessing(true);
                let giverIds = users.map(u => u.id);
                let receiverIds = [...giverIds];
                let isValid = false;

                // Simple Derangement Shuffle
                while (!isValid) {
                    for (let i = receiverIds.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [receiverIds[i], receiverIds[j]] = [receiverIds[j], receiverIds[i]];
                    }
                    isValid = true;
                    for (let i = 0; i < giverIds.length; i++) {
                        if (giverIds[i] === receiverIds[i]) { isValid = false; break; }
                    }
                }

                if (mode === 'cloud') {
                    try {
                        const batch = writeBatch(dbRef.current);
                        giverIds.forEach((giverId, index) => {
                            const matchRef = doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'matches', giverId);
                            batch.set(matchRef, { receiverId: receiverIds[index] });
                        });
                        await batch.commit();
                        // View update handled by onSnapshot
                    } catch (e) { alert('分配失敗'); }
                } else {
                    const newMatches = {};
                    giverIds.forEach((gid, i) => newMatches[gid] = receiverIds[i]);
                    setMatches(newMatches);
                    localStorage.setItem('xmas_matches', JSON.stringify(newMatches));
                }
                setView('reveal');
                setIsProcessing(false);
            };

            const handleViewResult = (targetUser) => {
                const receiverId = matches[targetUser.id];
                if (!receiverId) return;
                const receiver = users.find(u => u.id === receiverId);
                setRevealData({ giver: targetUser, receiver });
                setView('check_result');
            };

            const isMe = (uid) => myParticipantId === uid;

            // Render Modes
            if (mode === 'loading') return null; // Handled by HTML loader
            if (mode === 'setup') return <ConfigWizard onConfigComplete={handleConfigComplete} onOfflineMode={handleOfflineMode} />;

            // Main App UI
            return (
                <div className="min-h-screen bg-slate-50 relative overflow-hidden flex flex-col items-center">
                    {/* Background */}
                    <div className="absolute inset-0 pointer-events-none opacity-20 z-0">
                        <div className="absolute top-10 left-10 text-red-600 animate-pulse"><Icons.Snowflake size={48}/></div>
                        <div className="absolute bottom-20 right-10 text-green-700 animate-bounce"><Icons.Snowflake size={32}/></div>
                    </div>

                    <div className="relative z-10 w-full max-w-md min-h-screen bg-white shadow-2xl flex flex-col">
                        <header className="bg-gradient-to-r from-red-600 to-red-700 p-4 text-white shadow-md flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <Icons.Gift className="text-yellow-300" />
                                <h1 className="text-xl font-bold">聖誕一筆畫 {mode === 'offline' ? '(離線版)' : '(雲端版)'}</h1>
                            </div>
                            <div className="flex items-center gap-2">
                                {mode === 'cloud' && <span className="text-xs bg-red-800/50 px-2 py-1 rounded flex items-center gap-1"><Icons.Cloud size={10}/> 連線中</span>}
                                {users.length > 0 && <button onClick={handleReset} className="text-xs bg-red-800 px-2 py-1 rounded hover:bg-red-900">重置</button>}
                            </div>
                        </header>

                        <main className="flex-1 p-6 flex flex-col relative">
                            {isProcessing && <div className="absolute inset-0 z-50 bg-white/80 flex items-center justify-center"><Icons.Loader2 className="text-red-600" size={48}/></div>}

                            {view === 'home' && (
                                <div className="flex flex-col items-center justify-center h-full gap-8 animate-fade-in">
                                    <div className="text-center space-y-2">
                                        <h2 className="text-2xl font-bold text-gray-800">歡迎來到交換禮物</h2>
                                        <div className="bg-slate-100 px-4 py-2 rounded-full inline-block">
                                            <p className="text-gray-500 font-medium">目前已有 <span className="text-red-600 text-xl font-bold">{users.length}</span> 位玩家</p>
                                        </div>
                                    </div>
                                    <div className="w-full space-y-4">
                                        {!myParticipantId ? (
                                            <button onClick={startDrawing} className="w-full py-4 bg-green-600 hover:bg-green-700 text-white rounded-xl shadow-lg flex items-center justify-center gap-3 text-lg font-semibold active:scale-95 transition-transform">
                                                <Icons.PenTool size={24}/> 我是新玩家 (開始畫圖)
                                            </button>
                                        ) : (
                                            <div className="w-full py-4 bg-green-50 border-2 border-green-200 text-green-800 rounded-xl flex items-center justify-center gap-2 font-medium">
                                                <Icons.Check size={20}/> 你已完成上傳，等待分配
                                            </div>
                                        )}
                                        <button onClick={() => setView('participants')} className="w-full py-4 bg-white border-2 border-slate-200 hover:bg-slate-50 text-slate-700 rounded-xl shadow-sm flex items-center justify-center gap-3 text-lg font-semibold">
                                            <Icons.Users size={24}/> 查看玩家列表
                                        </button>
                                        {Object.keys(matches).length > 0 ? (
                                            <button onClick={() => setView('reveal')} className="w-full py-4 bg-gradient-to-r from-yellow-400 to-orange-500 text-white rounded-xl shadow-lg flex items-center justify-center gap-3 text-lg font-bold mt-8 animate-pulse">
                                                <Icons.Eye size={24}/> 分配完成！查看結果
                                            </button>
                                        ) : (
                                            users.length >= 2 && (
                                                <button onClick={performMatching} className="w-full py-4 bg-slate-800 text-white rounded-xl shadow-lg flex items-center justify-center gap-3 text-lg font-bold mt-8">
                                                    <Icons.Shuffle size={24}/> 主持人：開始分配
                                                </button>
                                            )
                                        )}
                                    </div>
                                    {mode === 'offline' && (
                                        <div className="mt-8 text-xs text-slate-400 text-center">
                                            目前為單機模式，資料僅存在此設備。<br/>若要切換雲端，請重整頁面並清除設定。
                                            <button onClick={()=>{localStorage.removeItem('fb_config_override');window.location.reload()}} className="underline text-slate-500 ml-1">重設</button>
                                        </div>
                                    )}
                                </div>
                            )}

                            {view === 'draw' && <DrawingPad onSave={saveUser} onCancel={() => setView('home')} Icons={Icons} />}

                            {view === 'participants' && (
                                <div className="flex flex-col h-full">
                                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><Icons.Users className="text-red-600"/> 參賽者名單</h2>
                                    <div className="flex-1 overflow-y-auto space-y-2">
                                        {users.length === 0 ? <div className="text-center text-slate-400 mt-10">無人加入</div> : users.map((u, idx) => (
                                            <div key={u.id} className={`p-4 rounded-lg flex justify-between items-center border ${isMe(u.id) ? 'bg-red-50 border-red-200' : 'bg-slate-50 border-slate-200'}`}>
                                                <div className="flex items-center gap-2">
                                                    <span className="font-medium text-lg">#{idx + 1} {u.name}</span>
                                                    {isMe(u.id) && <span className="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-bold">我</span>}
                                                </div>
                                                <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">已畫圖</span>
                                            </div>
                                        ))}
                                    </div>
                                    <button onClick={() => setView('home')} className="mt-4 w-full py-3 bg-slate-200 text-slate-700 font-semibold rounded-lg">返回</button>
                                </div>
                            )}

                            {view === 'reveal' && (
                                <div className="flex flex-col h-full">
                                    <div className="text-center mb-6">
                                        <h2 className="text-2xl font-bold text-red-600">分配完成！</h2>
                                        <p className="text-slate-500">請點擊你的名字查看結果</p>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 overflow-y-auto pb-4">
                                        {users.map((u) => (
                                            <button key={u.id} onClick={() => handleViewResult(u)} className={`p-4 border-2 rounded-xl shadow-sm flex flex-col items-center justify-center aspect-square transition relative ${isMe(u.id) ? 'bg-red-50 border-red-400 ring-2 ring-red-200' : 'bg-white border-red-100'}`}>
                                                {isMe(u.id) && <div className="absolute top-2 right-2 text-red-500 font-bold text-xs">Me</div>}
                                                <Icons.Gift size={32} className={`${isMe(u.id) ? 'text-red-600' : 'text-red-400'} mb-2`} />
                                                <span className="font-bold text-slate-700">{u.name}</span>
                                            </button>
                                        ))}
                                    </div>
                                    <button onClick={() => setView('home')} className="mt-auto w-full py-3 bg-slate-200 text-slate-700 font-semibold rounded-lg">返回首頁</button>
                                </div>
                            )}

                            {view === 'check_result' && revealData && (
                                <div className="flex flex-col h-full items-center justify-center text-center animate-fade-in">
                                    <div className="mb-6">
                                        <span className="text-sm text-slate-400 uppercase tracking-widest">你是</span>
                                        <h2 className="text-3xl font-bold text-slate-800">{revealData.giver.name}</h2>
                                        {!isMe(revealData.giver.id) && <p className="text-xs text-orange-500 mt-1">(注意：這不是你的名字，請勿偷看！)</p>}
                                    </div>
                                    <div className="w-full bg-red-50 p-6 rounded-2xl border-2 border-red-100 mb-6 relative overflow-hidden">
                                        <p className="text-slate-500 mb-2 font-medium">你要送禮物的對象是：</p>
                                        <div className="text-2xl font-bold text-red-600 mb-6 bg-white py-2 px-4 rounded-lg shadow-sm inline-block">{revealData.receiver ? revealData.receiver.name : "系統錯誤"}</div>
                                        <p className="text-slate-500 mb-2">他許願的禮物草圖：</p>
                                        <div className="bg-white border-2 border-slate-800 rounded-lg p-2 shadow-inner inline-block relative">
                                            {revealData.receiver ? <img src={revealData.receiver.drawing} alt="Secret Sketch" className="w-64 h-64 object-contain" /> : "Error"}
                                        </div>
                                    </div>
                                    <button onClick={() => setView('reveal')} className="w-full py-3 bg-slate-800 text-white font-semibold rounded-lg hover:bg-slate-900">我看好了 (關閉)</button>
                                </div>
                            )}
                        </main>
                    </div>
                </div>
            );
        };

        const DrawingPad = ({ onSave, onCancel, Icons }) => {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);
            const [name, setName] = useState('');
            const [hasDrawn, setHasDrawn] = useState(false);

            useEffect(() => {
                const canvas = canvasRef.current;
                if(!canvas) return;
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientWidth;
                const ctx = canvas.getContext('2d');
                ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.strokeStyle = '#334155'; ctx.lineWidth = 4;
                ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            }, []);

            const getPos = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };
            const startDraw = (e) => { setIsDrawing(true); setHasDrawn(true); const pos = getPos(e); const ctx = canvasRef.current.getContext('2d'); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); };
            const draw = (e) => { if (!isDrawing) return; const pos = getPos(e); const ctx = canvasRef.current.getContext('2d'); ctx.lineTo(pos.x, pos.y); ctx.stroke(); };
            const endDraw = () => setIsDrawing(false);
            const clearCanvas = () => { const ctx = canvasRef.current.getContext('2d'); ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, canvasRef.current.width, canvasRef.current.height); setHasDrawn(false); };
            const handleSave = () => {
                if (!name.trim()) return alert('請輸入名字！');
                if (!hasDrawn) return alert('請畫圖！');
                onSave(name, canvasRef.current.toDataURL('image/png'));
            };

            return (
                <div className="flex flex-col h-full animate-slide-up">
                    <h2 className="text-xl font-bold mb-4 text-center">繪製許願卡</h2>
                    <div className="mb-4">
                        <label className="block text-sm font-medium text-slate-700 mb-1">你的名字</label>
                        <input type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="例如：小明" className="w-full p-3 border border-slate-300 rounded-lg outline-none focus:border-red-500" />
                    </div>
                    <div className="flex-1 flex flex-col items-center">
                        <div className="text-sm text-red-600 font-bold mb-2 flex items-center gap-1"><Icons.PenTool size={16}/> 挑戰一筆畫！</div>
                        <div className="w-full aspect-square border-2 border-dashed border-slate-300 rounded-xl overflow-hidden shadow-inner relative bg-white touch-none">
                            <canvas ref={canvasRef} className="cursor-crosshair w-full h-full touch-none" onMouseDown={startDraw} onMouseMove={draw} onMouseUp={endDraw} onMouseLeave={endDraw} onTouchStart={startDraw} onTouchMove={draw} onTouchEnd={endDraw} />
                        </div>
                        <div className="flex justify-end w-full mt-2"><button onClick={clearCanvas} className="text-sm text-slate-500 flex items-center gap-1"><Icons.RotateCcw size={14}/> 重畫</button></div>
                    </div>
                    <div className="mt-6 flex gap-3">
                        <button onClick={onCancel} className="flex-1 py-3 border border-slate-300 text-slate-600 rounded-xl">取消</button>
                        <button onClick={handleSave} className="flex-1 py-3 bg-red-600 text-white rounded-xl shadow-md flex justify-center items-center gap-2"><Icons.Save size={18}/> 上傳</button>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>