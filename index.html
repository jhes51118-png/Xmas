<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¬¼æ»…ä¹‹åˆƒä¸€ç­†ç•«äº¤æ›ç¦®ç‰© (ç¶“å…¸å¾©åˆ»ç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'k-green': '#2ecc71', /* äº®ç¶ è‰² (æŒ‰éˆ•/å¼·èª¿) */
                        'k-dark-green': '#006400', /* æ·±ç¶ ç·šæ¢ */
                        'k-black': '#2d3436', /* æ·±ç°/é»‘ (Header/æŒ‰éˆ•) */
                        'k-pink': '#fd79a8', /* ç¦°è±†å­ç²‰ */
                        'k-yellow': '#f1c40f', /* å–„é€¸é»ƒ */
                        'wood-dark': '#5D4037',
                        'wood-light': '#8D6E63',
                    },
                    fontFamily: {
                        'serif': ['"Noto Serif TC"', 'serif'],
                    },
                    backgroundImage: {
                        'paper': "url('https://www.transparenttextures.com/patterns/rice-paper-2.png')",
                        'wood-pattern': "repeating-linear-gradient(90deg, transparent, transparent 10px, rgba(0,0,0,0.05) 10px, rgba(0,0,0,0.05) 20px)",
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    
    <!-- Import Maps: è§£æ±º React è¼‰å…¥éŒ¯èª¤çš„æ ¸å¿ƒ -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
        }
    }
    </script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { 
            font-family: 'Noto Serif TC', serif; 
            background-color: #f5f6fa; 
            color: #2d3436;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #2ecc71; border-radius: 3px; }

        /* Loader */
        #initial-loader { position: fixed; inset: 0; background: #2d3436; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s; }
        .spinner { 
            width: 60px; height: 60px; 
            border: 6px solid #2ecc71; 
            border-top: 6px solid #fd79a8; 
            border-radius: 50%; 
            animation: spin 1s linear infinite;
            box-shadow: 0 0 15px #2ecc71;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden-loader { opacity: 0; pointer-events: none; }
        
        .noselect { user-select: none; -webkit-user-select: none; }

        /* Nezuko Box Styles (åƒ…ç”¨æ–¼ç¾å ´æ¨¡å¼) */
        .nezuko-box { perspective: 1000px; cursor: pointer; }
        .nezuko-door { transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: left; }
        .nezuko-box.open .nezuko-door { transform: rotateY(-110deg); }
        .metal-strap { background: linear-gradient(90deg, #333, #555, #333); box-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    </style>
</head>
<body class="bg-paper min-h-screen overflow-x-hidden">

    <div id="initial-loader">
        <div class="spinner"></div>
        <p class="mt-6 text-k-green font-bold text-xl tracking-[0.3em]">å…¨é›†ä¸­...é€£ç·šä¸­</p>
        <p id="error-msg" class="mt-4 text-k-pink text-xs max-w-md text-center hidden px-4"></p>
    </div>

    <div id="root"></div>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            const loader = document.getElementById('initial-loader');
            const errText = document.getElementById('error-msg');
            if (loader && errText) {
                loader.classList.remove('hidden-loader');
                document.querySelector('.spinner').style.display = 'none';
                errText.classList.remove('hidden');
                errText.innerHTML = `<strong>ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼š</strong><br>${msg}<br><span style="font-size:10px; color:#ccc">å»ºè­°é‡æ–°æ•´ç†é é¢ã€‚</span>`;
            }
            return false;
        };
        window.addEventListener('unhandledrejection', function(event) {
            console.warn('Unhandled rejection:', event.reason);
        });
    </script>

    <!-- App Logic -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, collection, addDoc, onSnapshot, 
            doc, setDoc, updateDoc, deleteDoc, getDocs, writeBatch, serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // --- Constants ---
        const RANKS = ['ç™¸', 'å£¬', 'è¾›', 'åºš', 'å·±', 'æˆŠ', 'ä¸', 'ä¸™', 'ä¹™', 'ç”²'];
        const HASHIRA_TITLES = ['æ°´æŸ±', 'èŸ²æŸ±', 'ç‚æŸ±', 'éŸ³æŸ±', 'å²©æŸ±', 'æˆ€æŸ±', 'éœæŸ±', 'è›‡æŸ±', 'é¢¨æŸ±'];

        const getRandomRank = () => {
            if (Math.random() < 0.1) return HASHIRA_TITLES[Math.floor(Math.random() * HASHIRA_TITLES.length)];
            return RANKS[Math.floor(Math.random() * 5)];
        };

        const BREATH_STYLES = {
            water: { name: 'æ°´ä¹‹å‘¼å¸', border: 'border-blue-600', bg: 'bg-blue-50', text: 'text-blue-800', icon: 'ğŸŒŠ' },
            fire: { name: 'ç‚ä¹‹å‘¼å¸', border: 'border-red-600', bg: 'bg-red-50', text: 'text-red-800', icon: 'ğŸ”¥' },
            thunder: { name: 'é›·ä¹‹å‘¼å¸', border: 'border-yellow-500', bg: 'bg-yellow-50', text: 'text-yellow-800', icon: 'âš¡' },
            beast: { name: 'ç¸ä¹‹å‘¼å¸', border: 'border-stone-600', bg: 'bg-stone-50', text: 'text-stone-800', icon: 'ğŸ—' },
            insect: { name: 'èŸ²ä¹‹å‘¼å¸', border: 'border-purple-600', bg: 'bg-purple-50', text: 'text-purple-800', icon: 'ğŸ¦‹' },
            default: { name: 'æ™®é€šéšŠå“¡', border: 'border-k-black', bg: 'bg-white', text: 'text-k-black', icon: 'âš”ï¸' }
        };

        const getStyle = (key) => BREATH_STYLES[key] || BREATH_STYLES.default;

        // --- Icons (Unified) ---
        const Icon = ({ d, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d={d} />
            </svg>
        );
        const Icons = {
            PenTool: (p) => <Icon {...p} d="M12 19l7-7 3 3-7 7-3-3z M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z M2 2l7.586 7.586" />,
            Users: (p) => <Icon {...p} d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2 M9 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z M23 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75" />,
            Eye: (p) => <Icon {...p} d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />,
            RotateCcw: (p) => <Icon {...p} d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />,
            Save: (p) => <Icon {...p} d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z M17 21v-8H7v8 M7 3v5h8" />,
            Check: (p) => <Icon {...p} d="M20 6L9 17l-5-5" />,
            Lock: (p) => <Icon {...p} d="M19 11H5a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2zm-7-4a4 4 0 0 1 4 4v4H8v-4a4 4 0 0 1 4-4z" />,
            LogOut: (p) => <Icon {...p} d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4 M16 17l5-12l-5-5 M21 12H9" />,
            Trash2: (p) => <Icon {...p} d="M3 6h18 M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6 M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />,
            Image: (p) => <Icon {...p} d="M19 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z M11 14l3 3 5-5" />,
            Edit: (p) => <Icon {...p} d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7 M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />,
            Settings: (p) => <Icon {...p} d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />,
            ArrowRight: (p) => <Icon {...p} d="M5 12h14 M12 5l7 7-7 7" />,
            ArrowLeft: (p) => <Icon {...p} d="M19 12H5 M12 19l-7-7 7-7" />,
            WifiOff: (p) => <Icon {...p} d="M1 1l22 22 M16.72 11.06A10.94 10.94 0 0 1 19 12.55 M5 12.55a10.94 10.94 0 0 1 5.17-2.39 M10.71 5.05A16 16 0 0 1 22.58 9 M1.42 9a15.91 15.91 0 0 1 4.7-2.88 M8.53 16.11a6 6 0 0 1 6.95 0 M12 20h.01" />,
            Sword: (p) => <Icon {...p} d="M14.5 17.5L3 6V3h3l11.5 11.5 M13 19l6-6 M16 16l4 4 M19 21l2-2" />,
            Shuffle: (p) => <Icon {...p} d="M16 3h5v5 M4 20L21 3 M21 16v5h-5 M15 15l6 6 M4 4l5 5" />,
            EyeOff: (p) => <Icon {...p} d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24M1 1l22 22" />,
            RotateCw: (p) => <Icon {...p} d="M23 4v6h-6 M1 20v-6h6 M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15" />,
            Monitor: (p) => <Icon {...p} d="M20 3H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z M8 21h8 M12 17v4" />,
        };

        // --- Components ---

        // Nezuko Box (Used only in Live Mode)
        const NezukoBox = ({ children, isLocked }) => {
            const [isOpen, setIsOpen] = useState(false);
            const handleToggle = () => {
                if (isLocked) { alert('å°šæœªè§£é–‹å°å°ï¼'); return; }
                setIsOpen(!isOpen);
            };
            return (
                <div className={`relative w-full h-full bg-wood-dark border-4 border-black rounded-lg shadow-2xl overflow-hidden cursor-pointer nezuko-box ${isOpen ? 'open' : ''}`} onClick={handleToggle}>
                    <div className="absolute inset-0 flex items-center justify-center bg-white">{children}</div>
                    <div className="absolute inset-0 bg-wood-light flex flex-col justify-between p-2 nezuko-door z-20 bg-cover" style={{backgroundImage: "repeating-linear-gradient(90deg, transparent, transparent 10px, rgba(0,0,0,0.05) 10px, rgba(0,0,0,0.05) 20px)"}}>
                        <div className="w-full h-4 metal-strap rounded"></div>
                        <div className="w-full h-4 metal-strap rounded"></div>
                        <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center">
                            <div className="w-16 h-16 border-4 border-black bg-k-pink rounded-full flex items-center justify-center shadow-lg">
                                <span className="text-black font-black text-2xl">ç¦°</span>
                            </div>
                            <span className="text-white bg-black px-2 py-1 text-xs mt-2 font-bold rounded">{isOpen ? 'é»æ“Šé—œé–‰' : 'é»æ“Šé–‹ç®±'}</span>
                        </div>
                        <div className="w-full h-4 metal-strap rounded"></div>
                        <div className="w-full h-4 metal-strap rounded"></div>
                    </div>
                </div>
            );
        };

        // Long Press Button
        const LongPressButton = ({ onComplete, label, icon: Icon, disabled }) => {
            const [pressing, setPressing] = useState(false);
            const [progress, setProgress] = useState(0);
            const timer = useRef(null);
            useEffect(() => {
                if (pressing && !disabled) {
                    timer.current = setInterval(() => setProgress(p => p >= 100 ? 100 : p + 4), 30);
                } else {
                    setProgress(0);
                    clearInterval(timer.current);
                }
                return () => { if (timer.current) clearInterval(timer.current); }
            }, [pressing, disabled]);
            useEffect(() => { if (progress === 100) { setPressing(false); onComplete(); } }, [progress, onComplete]);
            return (
                <button disabled={disabled} className={`w-full py-3 border-2 border-red-600 text-red-600 bg-white rounded font-bold flex items-center justify-center gap-2 shadow-sm tracking-widest relative overflow-hidden noselect transition ${disabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-red-50 cursor-pointer'}`}
                    onMouseDown={() => setPressing(true)} onMouseUp={() => setPressing(false)} onMouseLeave={() => setPressing(false)} onTouchStart={() => setPressing(true)} onTouchEnd={() => setPressing(false)}>
                    <div className="absolute inset-0 bg-red-200 transition-all duration-75 ease-linear" style={{ width: `${progress}%` }}></div>
                    <div className="relative flex items-center gap-2 z-10">{Icon && <Icon size={20}/>} {pressing ? (progress === 100 ? 'å·²ç¢ºèª' : 'è«‹é•·æŒ‰ä»¥éŠ·æ¯€...') : label}</div>
                </button>
            )
        };

        const ConfigWizard = ({ onConfigComplete, onOfflineMode }) => {
            const [val, setVal] = useState('');
            const [err, setErr] = useState('');
            const save = () => {
                try {
                    let s = val.trim().replace(/^(const|let|var|export\s+const)\s+\w+\s*=\s*/, '').replace(/;$/, '');
                    let c; try { c = JSON.parse(s); } catch { c = new Function(`return {${s}}`)(); }
                    if(!c || !c.apiKey) throw new Error("æ ¼å¼éŒ¯èª¤ï¼Œæ‰¾ä¸åˆ° apiKey");
                    localStorage.setItem('fb_config_override', JSON.stringify(c));
                    onConfigComplete(c);
                } catch(e) { setErr(e.message); }
            };
            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4 relative z-10">
                    <div className="bg-white p-8 w-full max-w-lg border-4 border-k-black relative shadow-2xl transform rotate-1">
                        <div className="flex justify-center mb-4 text-k-black"><Icons.Settings size={48} /></div>
                        <h2 className="text-2xl font-bold text-center mb-6 text-k-black tracking-widest">é¬¼æ®ºéšŠãƒ»ç¸½éƒ¨é€£ç·š</h2>
                        <textarea className="w-full h-32 p-3 border-2 border-k-black rounded text-xs font-mono bg-gray-50 focus:ring-2 ring-k-green outline-none text-black mb-4" value={val} onChange={e=>setVal(e.target.value)} placeholder="è²¼ä¸Š Firebase Config..."></textarea>
                        {err && <p className="text-red-600 text-xs mb-2">{err}</p>}
                        <div className="space-y-3">
                            <button onClick={save} className="w-full py-3 bg-k-black text-white font-bold rounded transition hover:bg-gray-800">é€£ç·š</button>
                            <button onClick={onOfflineMode} className="w-full py-3 bg-k-green text-white font-bold rounded transition hover:bg-green-600">é›¢ç·šæ¨¡å¼</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [mode, setMode] = useState('loading');
            const [view, setView] = useState('home');
            const [users, setUsers] = useState([]);
            const [matches, setMatches] = useState({});
            const [myId, setMyId] = useState(localStorage.getItem('pid'));
            const [reveal, setReveal] = useState(null);
            const [loading, setLoading] = useState(false);
            
            const [adminPwd, setAdminPwd] = useState('');
            const [userPwd, setUserPwd] = useState('');
            const [targetUser, setTargetUser] = useState(null);
            const [editData, setEditData] = useState(null);
            const [showPwd, setShowPwd] = useState(false);
            
            // Live Event State
            const [remoteLiveState, setRemoteLiveState] = useState(null);
            
            // Admin Local State (synced to remote)
            const [liveHistory, setLiveHistory] = useState([]); // Used by admin to track chain locally before push
            // Ideally, admin should just read remote state too, but for chain logic we need history.
            // Let's simplify: Admin calculates next, pushes to Firestore. Spectator just reads.

            const appRef = useRef(null);
            const dbRef = useRef(null);
            const appId = 'default-app-id';

            useEffect(() => {
                const init = async () => {
                    const l = document.getElementById('initial-loader');
                    if(l) l.classList.add('hidden-loader');
                    try {
                        let c = null;
                        if(typeof __firebase_config !== 'undefined') c = JSON.parse(__firebase_config);
                        else { const s = localStorage.getItem('fb_config_override'); if(s) c = JSON.parse(s); }
                        if(c && c.apiKey) {
                            appRef.current = initializeApp(c);
                            dbRef.current = getFirestore(appRef.current);
                            const auth = getAuth(appRef.current);
                            if(typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                            else await signInAnonymously(auth);
                            setMode('cloud');
                        } else setMode('setup');
                    } catch(e) { console.error(e); setMode('setup'); }
                };
                init();
            }, []);

            // Sync Data
            useEffect(() => {
                if(mode !== 'cloud' || !dbRef.current) return;
                
                const unsubU = onSnapshot(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'participants'), s => {
                    const list = s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(a.createdAt?.seconds||0)-(b.createdAt?.seconds||0));
                    setUsers(list);
                    if(localStorage.getItem('pid') && !list.find(u=>u.id===localStorage.getItem('pid'))) {
                        localStorage.removeItem('pid'); setMyId(null); localStorage.removeItem('pwd_bk');
                    }
                });
                
                const unsubM = onSnapshot(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'matches'), s => {
                    const m={}; s.forEach(d => m[d.id] = d.data().receiverId); setMatches(m);
                });

                // Live State Sync
                const unsubLive = onSnapshot(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'liveState', 'main'), s => {
                    if(s.exists()) setRemoteLiveState(s.data());
                    else setRemoteLiveState(null);
                });

                return () => { unsubU(); unsubM(); unsubLive(); };
            }, [mode]);

            // Local Fallback
            useEffect(() => {
                if(mode !== 'offline') return;
                const u = localStorage.getItem('xmas_users'); if(u) setUsers(JSON.parse(u));
                const m = localStorage.getItem('xmatches'); if(m) setMatches(JSON.parse(m));
            }, [mode]);

            const resetAll = async () => {
                setLoading(true);
                if(mode==='cloud') {
                    const b = writeBatch(dbRef.current);
                    const u = await getDocs(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'participants'));
                    u.forEach(d=>b.delete(d.ref));
                    const m = await getDocs(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'matches'));
                    m.forEach(d=>b.delete(d.ref));
                    // Reset Live State
                    b.set(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'liveState', 'main'), { 
                        currentReceiverId: null, 
                        showGiver: false,
                        drawnIds: []
                    });
                    await b.commit();
                } else {
                    localStorage.removeItem('xmas_users'); localStorage.removeItem('xmatches');
                    setUsers([]); setMatches({});
                }
                localStorage.removeItem('pid'); setMyId(null);
                setView('home'); setLoading(false);
            };

            const doMatch = async () => {
                if(users.length<2) return alert('äººæ•¸ä¸è¶³');
                if(Object.keys(matches).length>0 && !confirm('é‡æ–°åˆ†é…ï¼Ÿ')) return;
                setLoading(true);
                let g = users.map(u=>u.id), r = [...g], v=false;
                while(!v) {
                    for(let i=r.length-1;i>0;i--) { const j=Math.floor(Math.random()*(i+1)); [r[i],r[j]]=[r[j],r[i]]; }
                    v=true; for(let i=0;i<g.length;i++) if(g[i]===r[i]) v=false;
                }
                if(mode==='cloud') {
                    const b = writeBatch(dbRef.current);
                    g.forEach((gid,i)=>b.set(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'matches', gid), {receiverId:r[i]}));
                    await b.commit();
                } else {
                    const nm={}; g.forEach((gid,i)=>nm[gid]=r[i]);
                    setMatches(nm); localStorage.setItem('xmatches', JSON.stringify(nm));
                }
                alert('åˆ†é…å®Œæˆ'); setLoading(false);
            };

            const saveMe = async (name, pwd, img, style) => {
                setLoading(true);
                if(users.some(u => u.name.trim() === name.trim() && u.id !== myId)) {
                    alert('åç¨±é‡è¤‡'); setLoading(false); return;
                }
                localStorage.setItem('pwd_bk', pwd);
                localStorage.setItem('style_bk', style);
                const rank = getRandomRank();
                const d = { name, password: pwd, drawing: img, style, rank, uid: 'anon', createdAt: serverTimestamp() };
                
                if(myId) {
                    if(mode==='cloud') await updateDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'participants', myId), { ...d, rank: undefined });
                    else {
                        const nu = users.map(u=>u.id===myId?{...u, name, pwd, img, style}:u);
                        setUsers(nu); localStorage.setItem('xusers', JSON.stringify(nu));
                    }
                    setView('my_card');
                } else {
                    if(mode==='cloud') {
                        const ref = await addDoc(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'participants'), d);
                        localStorage.setItem('pid', ref.id); setMyId(ref.id);
                    } else {
                        const id = Date.now().toString();
                        const nu = [...users, {...d, id}];
                        setUsers(nu); localStorage.setItem('xusers', JSON.stringify(nu));
                        localStorage.setItem('pid', id); setMyId(id);
                    }
                    setView('home');
                }
                setLoading(false); setEditData(null);
            };

            const loginUser = () => {
                if(targetUser.password !== userPwd) return alert('å¯†ç¢¼éŒ¯èª¤');
                localStorage.setItem('pid', targetUser.id);
                localStorage.setItem('pwd_bk', userPwd);
                setMyId(targetUser.id);
                if(!matches[targetUser.id]) setView('my_card');
                else {
                    const r = users.find(u=>u.id===matches[targetUser.id]);
                    setReveal({g:targetUser, r});
                    setView('check_result');
                }
                setTargetUser(null);
            };

            // --- LIVE EVENT CONTROL (Admin Only) ---
            
            // Helper to update live state in Firestore
            const updateLiveState = async (receiverId, showGiver, newDrawnIds) => {
                if (mode !== 'cloud') return;
                await setDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'liveState', 'main'), {
                    currentReceiverId: receiverId,
                    showGiver: showGiver,
                    drawnIds: newDrawnIds || (remoteLiveState?.drawnIds || [])
                });
            };

            const adminNextLive = async () => {
                // Logic similar to local state but pushing to Firestore
                const drawnIds = new Set(remoteLiveState?.drawnIds || []);
                const currentId = remoteLiveState?.currentReceiverId;
                
                let nextUser = null;

                // Chain Logic
                if (currentId) {
                    // Who gave to current?
                    const giverId = Object.keys(matches).find(gid => matches[gid] === currentId);
                    if (giverId && !drawnIds.has(giverId)) {
                        nextUser = users.find(u => u.id === giverId);
                    }
                }

                // Random fallback
                if (!nextUser) {
                    const remaining = users.filter(u => !drawnIds.has(u.id));
                    if (remaining.length === 0) return alert('å…¨å“¡å·²ä¸Šå°');
                    nextUser = remaining[Math.floor(Math.random() * remaining.length)];
                }

                if (nextUser) {
                    const newDrawn = [...(remoteLiveState?.drawnIds || []), nextUser.id];
                    await updateLiveState(nextUser.id, false, newDrawn);
                }
            };

            const adminToggleReveal = async () => {
                if (!remoteLiveState) return;
                await updateLiveState(remoteLiveState.currentReceiverId, true, null);
            };
            
            const adminResetLive = async () => {
                if(confirm('é‡ç½®ç¾å ´å„€å¼ï¼Ÿ')) {
                    await updateLiveState(null, false, []);
                }
            };

            // Determine current live display based on View
            // If admin_live or spectator_live, we use remoteLiveState
            const currentLiveReceiver = remoteLiveState?.currentReceiverId ? users.find(u => u.id === remoteLiveState.currentReceiverId) : null;
            const currentLiveGiver = currentLiveReceiver ? users.find(u => matches[u.id] === currentLiveReceiver.id) : null;
            const isLiveGiverShown = remoteLiveState?.showGiver || false;


            if(mode==='loading') return null;
            if(mode==='setup') return <ConfigWizard onConfigComplete={()=>window.location.reload()} onOfflineMode={()=>{setMode('offline'); setView('home');}}/>;

            // Common wrapper for consistent styling
            const Wrapper = ({ children }) => (
                <div className="min-h-screen relative bg-[#f0f0f0] font-serif overflow-hidden text-[#2d3436]">
                    <div className="fixed inset-0 pointer-events-none opacity-50 bg-paper z-0"></div>
                    <div className="relative z-10 w-full max-w-md mx-auto min-h-screen bg-white/95 shadow-2xl flex flex-col">
                        <header className="bg-k-black text-white p-4 flex justify-between items-center shadow-md z-20">
                            <div className="flex items-center gap-2 text-k-green font-bold tracking-widest text-lg">
                                <Icons.Sword/> é¬¼æ»…ä¹‹åˆƒäº¤æ›é“å ´
                            </div>
                            <div className="flex gap-2 items-center">
                                {mode==='cloud' && <span className="text-xs border border-k-green text-k-green px-2 py-1 rounded">é€£ç·šä¸­</span>}
                            </div>
                        </header>
                        <main className="flex-1 flex flex-col relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/rice-paper.png')]">
                            {children}
                        </main>
                    </div>
                </div>
            );

            // Live View Renderer (Shared by Admin and Spectator)
            // Admin has controls, Spectator does not.
            const LiveStage = ({ isAdminControl }) => (
                <div className="min-h-screen bg-k-black text-white flex flex-col relative overflow-hidden font-serif">
                    <div className="absolute top-0 left-0 w-full h-2 bg-k-green"></div>
                    <header className="p-4 z-20 flex justify-between items-center bg-black/50 backdrop-blur">
                        <h1 className="text-2xl font-bold tracking-widest flex items-center gap-2 text-k-green"><Icons.Users/> ç¦®ç‰©äº¤ä»˜å„€å¼ {isAdminControl ? '(ä¸»æ§)' : '(è§€çœ‹)'}</h1>
                        <div className="flex gap-2">
                             {isAdminControl && <button onClick={adminResetLive} className="border border-red-500 text-red-500 px-3 py-1 rounded text-sm hover:bg-red-900 hover:text-white transition flex items-center gap-1"><Icons.RotateCcw size={14}/>é‡ç½®</button>}
                            <button onClick={()=>setView(isAdminControl ? 'admin_dash' : 'home')} className="border px-3 py-1 rounded text-sm hover:bg-white hover:text-black transition">é€€å‡º</button>
                        </div>
                    </header>
                    <div className="flex-1 flex flex-col items-center justify-center relative z-10 p-4">
                        {!currentLiveReceiver ? (
                            <div className="text-center space-y-8 animate-fade-in">
                                <div className="text-6xl text-k-pink animate-pulse">ğŸŒ¸</div>
                                <h2 className="text-4xl font-bold tracking-widest">
                                    {isAdminControl ? 'æº–å‚™é–‹å§‹æŠ½ç±¤' : 'ç­‰å¾…å„€å¼é–‹å§‹...'}
                                </h2>
                                <p className="text-slate-400">å‰©é¤˜ {users.length - (remoteLiveState?.drawnIds?.length || 0)} ä½éšŠå“¡</p>
                                {isAdminControl && (
                                    <button onClick={adminNextLive} className="px-8 py-4 bg-k-green text-white text-2xl font-bold rounded shadow-lg hover:scale-105 transition-transform border-2 border-white tracking-widest">å¬å–šç¬¬ä¸€ä½</button>
                                )}
                            </div>
                        ) : (
                            <div className="w-full max-w-6xl grid md:grid-cols-2 gap-12 items-center animate-fade-in">
                                <div className="flex flex-col items-center">
                                    <div className="text-k-green tracking-[0.5em] font-bold mb-2 text-lg bg-black/50 px-4 py-1 rounded">å—è´ˆè€…</div>
                                    <h2 className="text-5xl font-black tracking-widest mb-8 border-b-4 border-k-pink inline-block pb-2">{currentLiveReceiver.name}</h2>
                                    <div className="w-full max-w-md aspect-square relative transform rotate-1">
                                        <NezukoBox isLocked={false}><img src={currentLiveReceiver.drawing} className="w-full h-full object-contain bg-white rounded" /></NezukoBox>
                                    </div>
                                </div>
                                <div className="flex flex-col items-center justify-center bg-white/10 p-8 rounded border border-white/20 backdrop-blur-sm shadow-2xl">
                                    <p className="text-gray-300 text-lg mb-6 font-bold">é€™ä»½ç¦®ç‰©ä¾†è‡ª...</p>
                                    {!isLiveGiverShown ? (
                                        isAdminControl ? (
                                            <button onClick={adminToggleReveal} className="w-full py-6 bg-k-pink hover:bg-pink-600 text-white rounded font-bold text-xl shadow-lg transition-transform hover:scale-105 border-b-4 border-pink-800 tracking-widest">æ­æ›‰é€ç¦®è€…</button>
                                        ) : (
                                            <div className="text-2xl font-bold text-gray-400 animate-pulse">ç­‰å¾…æ­æ›‰...</div>
                                        )
                                    ) : (
                                        <div className="w-full text-center animate-fade-in">
                                            <div className="text-6xl mb-4">ğŸ‘º</div>
                                            <div className="bg-white text-k-black text-4xl font-black py-4 px-8 rounded border-4 border-k-green shadow-[0_0_20px_rgba(255,255,255,0.5)] tracking-widest">{liveGiver ? liveGiver.name : "æœªçŸ¥"}</div>
                                        </div>
                                    )}
                                    
                                    {isAdminControl && (
                                        <div className="flex w-full gap-4 mt-12 justify-center">
                                            <button onClick={adminNextLive} className="px-8 py-3 bg-k-green text-white font-bold rounded shadow-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2 border-b-4 border-green-800 active:border-b-0 active:translate-y-1">
                                                æ¥é¾ä¸‹ä¸€ä½ <Icons.ArrowRight/>
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );

            // --- View Routing ---

            if (view === 'admin_live') return <LiveStage isAdminControl={true} />;
            if (view === 'spectator_live') return <LiveStage isAdminControl={false} />;

            if(view === 'home') return (
                <Wrapper>
                    <div className="flex flex-col items-center justify-center h-full gap-6 py-12 animate-fade-in p-6">
                        <div className="bg-white border-4 border-k-black p-2 shadow-xl w-full max-w-sm transform rotate-1">
                            <div className="border-2 border-k-green p-6 text-center">
                                <h1 className="text-3xl font-black tracking-[0.2em] text-k-black">å…¨é›†ä¸­ãƒ»äº¤æ›ä¹‹å‘¼å¸</h1>
                            </div>
                        </div>
                        <div className="bg-white border-2 border-k-black px-8 py-4 shadow-md rounded">
                            <p className="font-bold text-lg text-k-black">ç¾ä»»éšŠå“¡ï¼š<span className="text-k-pink font-black text-2xl mx-1">{users.length}</span> å</p>
                        </div>
                        <div className="w-full space-y-4 mt-4">
                            {!myId ? (
                                <button onClick={()=>{setEditData(null); setView('draw');}} className="w-full py-5 bg-k-green text-white rounded shadow-lg font-bold text-xl flex items-center justify-center gap-3 border-b-4 border-green-800 active:border-b-0 active:translate-y-1 transition-all">
                                    <Icons.PenTool size={24}/> å…¥éšŠè€ƒæ ¸ (ç¹ªè£½å·è»¸)
                                </button>
                            ) : (
                                <button onClick={()=>setView('my_card')} className="w-full py-5 bg-white border-2 border-k-green text-k-green rounded font-bold text-xl flex items-center justify-center gap-3 shadow-lg hover:bg-green-50 transition-transform active:scale-95">
                                    <Icons.Image size={24}/> æŸ¥çœ‹æˆ‘çš„ä»»å‹™å·è»¸
                                </button>
                            )}
                            <button onClick={()=>setView('list')} className="w-full py-5 bg-k-black text-white rounded font-bold text-xl flex items-center justify-center gap-3 shadow-lg hover:bg-gray-800 transition-transform active:scale-95">
                                <Icons.Users size={24}/> æŸ¥çœ‹éšŠå“¡åå†Š
                            </button>
                            
                            {/* Task Button */}
                            {users.length > 0 && (
                                <div className="w-full space-y-2 mt-6">
                                    <button onClick={() => setView('reveal')} className={`w-full py-4 border-2 ${Object.keys(matches).length > 0 ? 'bg-k-pink border-pink-400 text-white' : 'bg-gray-100 border-gray-300 text-gray-500'} rounded font-bold flex justify-center gap-2 transition`}>
                                        {Object.keys(matches).length > 0 ? <><Icons.Eye size={20}/> ä»»å‹™ä¸‹é”ï¼ç¢ºèªç›®æ¨™</> : <><Icons.Lock size={20}/> éšŠå“¡é›†åˆï¼ç¢ºèªå·è»¸</>}
                                    </button>
                                    
                                    {/* Spectator Mode Button */}
                                    <button onClick={() => setView('spectator_live')} className="w-full py-3 bg-k-yellow text-k-black rounded font-bold shadow flex items-center justify-center gap-2 hover:bg-yellow-400 transition border-b-4 border-yellow-600 active:border-b-0 active:translate-y-1">
                                        <Icons.Monitor size={20}/> é€²å…¥æœƒå ´ (è§€çœ‹æ¨¡å¼)
                                    </button>
                                </div>
                            )}
                        </div>
                        <div className="mt-auto pt-8 w-full flex flex-col items-center gap-4">
                            {myId && <button onClick={()=>{if(confirm('éš±é€€?')) {localStorage.removeItem('pid'); setMyId(null);}}} className="text-xs text-gray-400 border-b border-gray-300 pb-1">è§£é™¤éšŠå“¡èº«ä»½</button>}
                            <button onClick={() => setView('admin_login')} className="bg-white border border-k-black px-6 py-2 rounded text-sm font-bold text-k-black hover:bg-gray-50 transition flex items-center gap-2 shadow-sm">
                                <Icons.Lock size={14}/> é¬¼æ®ºéšŠç¸½éƒ¨ (Admin)
                            </button>
                        </div>
                    </div>
                </Wrapper>
            );

            if(view === 'list') return (
                <Wrapper>
                    <div className="p-4 h-full flex flex-col">
                        <h2 className="text-xl font-bold mb-4 text-center border-b-2 border-k-green pb-2 inline-block mx-auto">éšŠå“¡åå†Š</h2>
                        <div className="grid grid-cols-2 gap-4 overflow-y-auto flex-1 pb-4">
                            {users.map((u,i) => {
                                const s = getStyle(u.style);
                                return (
                                    <div key={u.id} className={`p-2 rounded border-2 shadow-sm flex flex-col items-center bg-white ${s.border} relative`}>
                                        <div className="absolute top-1 left-2 text-xs font-mono text-gray-400 font-bold">#{i+1}</div>
                                        <div className="w-full aspect-square bg-gray-50 rounded mb-2 overflow-hidden border border-gray-200 mt-5">
                                            <img src={u.drawing} className="w-full h-full object-contain" />
                                        </div>
                                        <div className="text-xs text-gray-500 mb-1 flex items-center gap-1">{s.icon} {s.name}</div>
                                        <div className={`font-bold text-sm truncate w-full text-center ${s.text}`}>{u.name}</div>
                                        {u.id === myId && <span className="absolute top-1 right-1 bg-k-black text-white text-[10px] px-1.5 py-0.5 rounded">æˆ‘</span>}
                                    </div>
                                )
                            })}
                        </div>
                        <button onClick={()=>setView('home')} className="mt-4 w-full py-3 bg-white border-2 border-k-black text-k-black font-bold rounded hover:bg-gray-100">è¿”å›</button>
                    </div>
                </Wrapper>
            );

            if(view === 'draw') return (
                <Wrapper>
                    <div className="p-4 h-full flex flex-col">
                        <DrawingPad initialData={editData} onSave={saveMe} onCancel={()=>setView(editData?'my_card':'home')} />
                    </div>
                </Wrapper>
            );

            if(view === 'my_card') return (
                <Wrapper>
                    <div className="p-4 h-full flex flex-col items-center">
                        {(() => {
                            const me = users.find(u=>u.id===myId);
                            if(!me) return <div className="text-center mt-10">è³‡æ–™å·²éºå¤±</div>;
                            const isLocked = !!matches[me.id];
                            const style = getStyle(me.style);
                            return (
                                <>
                                    <h2 className="text-xl font-bold mb-4 text-k-black flex items-center gap-2">æˆ‘çš„å·è»¸</h2>
                                    <div className={`w-full p-6 mb-6 bg-white border-4 ${style.border} ${style.bg} relative rounded shadow-lg`}>
                                        <div className="flex justify-between items-center mb-4 border-b-2 border-black/10 pb-2">
                                            <span className={`text-sm font-bold ${style.text} bg-white/80 px-2 rounded border border-black/10`}>éšç´š: {me.rank}</span>
                                            <span className={`font-bold text-xl ${style.text}`}>{me.name}</span>
                                        </div>
                                        <div className={`aspect-square bg-white border-2 ${style.border} relative shadow-inner rounded overflow-hidden`}>
                                            <img src={me.drawing} className="w-full h-full object-contain"/>
                                            {isLocked && <div className="absolute inset-0 bg-black/60 flex items-center justify-center text-white font-bold text-3xl tracking-widest border-4 border-white m-4">å° å°</div>}
                                        </div>
                                    </div>
                                    {!isLocked ? (
                                        <button onClick={()=>{setEditData(me); setView('draw');}} className="w-full py-4 bg-k-black text-white font-bold rounded shadow-lg active:scale-95 transition-transform">ä¿®æ”¹å·è»¸</button>
                                    ) : (
                                        <div className="w-full p-4 bg-gray-200 text-gray-600 text-center font-bold rounded border-2 border-gray-300">ä»»å‹™å·²ä¸‹é”ï¼Œç„¡æ³•ä¿®æ”¹</div>
                                    )}
                                    <button onClick={()=>setView('home')} className="mt-auto w-full py-3 text-gray-500 font-bold hover:text-k-black">è¿”å›</button>
                                </>
                            )
                        })()}
                    </div>
                </Wrapper>
            );

            if(view === 'reveal') return (
                <Wrapper>
                    <div className="p-4 h-full flex flex-col">
                        <div className="text-center mb-6">
                            <h2 className="text-xl font-bold text-k-black tracking-widest">{Object.keys(matches).length>0?'ä»»å‹™ä¸‹é”':'å·è»¸ç¢ºèª'}</h2>
                            <p className="text-sm text-gray-500 mt-1">é»æ“Šåå­—è§£é–‹</p>
                        </div>
                        <div className="grid grid-cols-2 gap-3 overflow-y-auto pb-6 flex-1">
                            {users.map(u => {
                                const s = getStyle(u.style);
                                return (
                                    <button key={u.id} onClick={()=>{setTargetUser(u); setUserPwd(myId===u.id?localStorage.getItem('pwd_bk')||'':''); setView('login');}} 
                                        className={`relative p-4 rounded border-2 bg-white shadow-sm hover:bg-gray-50 transition-transform active:scale-95 flex flex-col items-center gap-2 aspect-square justify-center ${s.border}`}>
                                        {myId===u.id && <div className="absolute top-2 right-2 w-3 h-3 bg-k-green rounded-full border border-white"></div>}
                                        <Icons.Lock className="text-gray-300"/>
                                        <span className={`font-bold ${s.text} truncate w-full text-center`}>{u.name}</span>
                                    </button>
                                )
                            })}
                        </div>
                        <button onClick={()=>setView('home')} className="mt-auto w-full py-3 bg-white border-2 border-k-black font-bold rounded">è¿”å›</button>
                    </div>
                </Wrapper>
            );

            if(view === 'login') return (
                <Wrapper>
                    <div className="flex flex-col items-center justify-center h-full p-6">
                        <div className="p-8 w-full bg-white border-4 border-k-black rounded shadow-xl">
                            <h2 className="text-xl font-bold text-center mb-6 text-k-green">èº«åˆ†é©—è­‰</h2>
                            <p className="text-center mb-4 font-bold text-k-black">{targetUser.name}</p>
                            <input type="password" value={userPwd} onChange={e=>setUserPwd(e.target.value)} className="w-full p-3 text-center border-2 border-gray-300 rounded mb-6 tracking-[0.5em] font-bold text-xl outline-none focus:border-k-green" placeholder="â€¢â€¢â€¢â€¢"/>
                            <div className="flex gap-3">
                                <button onClick={()=>setView('reveal')} className="flex-1 py-3 bg-gray-200 font-bold rounded">å–æ¶ˆ</button>
                                <button onClick={loginUser} className="flex-1 py-3 bg-k-black text-white font-bold rounded border-b-4 border-black active:border-b-0 active:translate-y-1 transition-all">è§£é–‹</button>
                            </div>
                        </div>
                    </div>
                </Wrapper>
            );

            if(view === 'check_result' && reveal) return (
                <Wrapper>
                    <div className="flex flex-col h-full items-center justify-center animate-fade-in p-6">
                        <div className="w-full bg-k-black text-white p-4 text-center rounded-t-xl border-b-4 border-k-green">
                            <div className="text-xs text-k-green mb-1">TO: éšŠå“¡</div>
                            <div className="text-2xl font-bold">{reveal.g.name}</div>
                        </div>
                        <div className="p-8 w-full rounded-b-xl mb-6 text-center bg-white border-x-4 border-b-4 border-k-dark shadow-xl">
                            <p className="text-gray-500 mb-2 font-bold">ä½ çš„é€ç¦®å°è±¡æ˜¯</p>
                            <div className="text-3xl font-black text-k-pink mb-6 tracking-widest">{reveal.r ? "??? (ç¥ç§˜éšŠå“¡)" : "éŒ¯èª¤"}</div>
                            <div className="bg-gray-100 p-2 border-2 border-dashed border-gray-300 rounded relative">
                                {reveal.r && <img src={reveal.r.drawing} className="w-full" />}
                            </div>
                            <p className="text-xs text-gray-400 mt-2">è«‹ä¾ç…§æŒ‡ç¤ºæº–å‚™ç¦®ç‰©</p>
                        </div>
                        <button onClick={()=>setView('reveal')} className="w-full py-4 bg-k-pink text-white font-bold rounded shadow-lg hover:bg-pink-500 transition-transform">éµå‘½ (ç™»å‡º)</button>
                    </div>
                </Wrapper>
            );

            if(view === 'admin_login') return (
                <Wrapper>
                    <div className="flex flex-col items-center justify-center h-full p-6">
                        <div className="p-8 w-full bg-white border-4 border-k-black rounded shadow-xl">
                            <h2 className="text-xl font-bold text-center mb-6">ä¸»å…¬å¤§äºº</h2>
                            <input type="password" value={adminPwd} onChange={e=>setAdminPwd(e.target.value)} className="w-full p-3 text-center border-2 border-gray-300 rounded mb-6 font-bold" placeholder="æš—è™Ÿ"/>
                            <button onClick={()=>{if(adminPwd==='admin123'){setView('admin_dash');setAdminPwd('');}else alert('éŒ¯èª¤');}} className="w-full py-3 bg-k-black text-white font-bold rounded hover:bg-black">é€²å…¥</button>
                            <button onClick={()=>setView('home')} className="w-full py-3 mt-2 text-gray-400 text-sm">è¿”å›</button>
                        </div>
                    </div>
                </Wrapper>
            );

            if(view === 'admin_dash') return (
                <Wrapper>
                    <div className="flex justify-between items-center mb-6 p-4 border-b border-gray-300">
                        <h2 className="text-xl font-bold">ç¸½éƒ¨å¾Œå°</h2>
                        <button onClick={()=>setView('home')} className="text-sm bg-gray-200 px-3 py-1 rounded">é›¢é–‹</button>
                    </div>
                    <div className="space-y-6 overflow-y-auto flex-1 pb-10 px-4">
                        <div className="bg-k-black p-6 rounded shadow-lg text-white flex justify-between items-center border-l-4 border-k-green">
                            <div><h3 className="font-bold text-xl text-k-green">ç¾å ´å„€å¼</h3><p className="text-xs opacity-70">é–‹å•Ÿå¤§è¢å¹•æŠ½ç±¤</p></div>
                            <button onClick={()=>setView('admin_live')} className="px-6 py-2 bg-k-pink rounded font-bold shadow hover:bg-pink-500 text-white">é€²å…¥</button>
                        </div>
                        
                        <div className="p-6 bg-white rounded shadow-md border border-gray-200">
                            <h3 className="font-bold border-b pb-2 mb-4">ä»»å‹™æŒ‡æ´¾</h3>
                            <div className="space-y-3">
                                <button onClick={doMatch} disabled={loading} className="w-full py-3 bg-k-green text-white font-bold rounded shadow-sm hover:bg-green-600">{Object.keys(matches).length>0?'é‡æ–°åˆ†é…':'é–‹å§‹åˆ†é…'}</button>
                                <LongPressButton label="éŠ·æ¯€è³‡æ–™" icon={Icons.Trash2} onComplete={resetAll} disabled={loading}/>
                            </div>
                        </div>

                        <div className="p-6 bg-white rounded shadow-md border border-gray-200">
                            <div className="flex justify-between mb-4"><h3 className="font-bold">éšŠå“¡è³‡æ–™</h3><button onClick={()=>setShowPwd(!showPwd)} className="text-xs bg-gray-200 px-2 rounded">{showPwd?'éš±è—':'é¡¯ç¤ºå¯†ç¢¼'}</button></div>
                            <div className="grid grid-cols-2 gap-3">
                                {users.map(u=>(
                                    <div key={u.id} className="border p-2 rounded bg-white text-center">
                                        <div className="aspect-square bg-gray-50 mb-2 border border-gray-200 rounded overflow-hidden"><img src={u.drawing} className="w-full h-full object-contain"/></div>
                                        <div className="font-bold text-sm truncate">{u.name}</div>
                                        {showPwd && <div className="text-xs text-red-500">{u.password}</div>}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </Wrapper>
            );

            return null;
        };

        const DrawingPad = ({ initialData, onSave, onCancel }) => {
            const canvasRef = useRef(null);
            const [name, setName] = useState(initialData?.name||'');
            const [pwd, setPwd] = useState(initialData?.password||'');
            const [style, setStyle] = useState(() => initialData?.style || localStorage.getItem('style_bk') || 'water');
            const [isDrawn, setIsDrawn] = useState(false);
            const [isLocked, setIsLocked] = useState(false);

            useEffect(() => {
                const c = canvasRef.current;
                const ctx = c.getContext('2d');
                c.width = c.parentElement.clientWidth;
                c.height = c.parentElement.clientWidth;
                ctx.fillStyle = '#fff'; ctx.fillRect(0,0,c.width,c.height);
                ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle='#000'; ctx.lineWidth=6;
                if(initialData?.drawing) {
                    const i = new Image(); i.src = initialData.drawing;
                    i.onload = () => { ctx.drawImage(i,0,0,c.width,c.height); setIsDrawn(true); setIsLocked(true); };
                }
            }, [initialData]);

            const getPos = (e) => {
                const r = canvasRef.current.getBoundingClientRect();
                const x = (e.touches?e.touches[0].clientX:e.clientX) - r.left;
                const y = (e.touches?e.touches[0].clientY:e.clientY) - r.top;
                return {x,y};
            }
            const start = (e) => {
                if(isLocked) return;
                const ctx = canvasRef.current.getContext('2d');
                const {x,y} = getPos(e);
                ctx.beginPath(); ctx.moveTo(x,y);
                setIsDrawn(true);
            }
            const move = (e) => {
                if(isLocked || (e.buttons!==1 && !e.touches)) return;
                const ctx = canvasRef.current.getContext('2d');
                const {x,y} = getPos(e);
                ctx.lineTo(x,y); ctx.stroke();
            }
            const end = () => { if(isDrawn && !isLocked) setIsLocked(true); }
            const clear = () => {
                const c = canvasRef.current; const ctx = c.getContext('2d');
                ctx.fillRect(0,0,c.width,c.height); setIsDrawn(false); setIsLocked(false);
            }
            const save = () => {
                if(!name || !pwd) return alert('è«‹å¡«å¯«å®Œæ•´');
                if(!isDrawn) return alert('è«‹ç•«åœ–');
                onSave(name, pwd, canvasRef.current.toDataURL(), style);
            }

            const currStyle = getStyle(style);

            return (
                <div className="flex flex-col h-full animate-slide-up">
                    <h2 className="text-xl font-bold mb-4 text-center text-k-black flex items-center justify-center gap-2"><Icons.PenTool/> ç¹ªè£½å·è»¸</h2>
                    <div className="mb-4">
                        <label className="block text-xs font-bold mb-1 text-gray-500">å‘¼å¸æµæ´¾</label>
                        <div className="flex gap-1 overflow-x-auto pb-2">
                            {Object.keys(STYLES).map(k => (
                                <button key={k} onClick={()=>setStyle(k)} className={`flex-shrink-0 p-2 border-2 rounded ${style===k?'border-k-black bg-white scale-105':'border-transparent opacity-50'} transition-all`}>
                                    <div className="text-2xl">{getStyle(k).icon}</div>
                                </button>
                            ))}
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-3 mb-4">
                        <input value={name} onChange={e=>setName(e.target.value)} className={`p-2 border-2 ${currStyle.border} rounded text-center font-bold outline-none`} placeholder="éšŠå“¡å" />
                        <input value={pwd} onChange={e=>setPwd(e.target.value)} className={`p-2 border-2 ${currStyle.border} rounded text-center font-bold outline-none`} placeholder="å¯†ç¢¼" />
                    </div>
                    <div className="flex-1 flex flex-col items-center">
                        <div className={`text-sm font-bold mb-3 flex items-center gap-2 px-4 py-2 rounded border-2 shadow-sm transition-colors ${isLocked ? 'bg-red-100 text-red-600 border-red-300' : `${currStyle.bg} ${currStyle.text} ${currStyle.border}`}`}>
                            <Icons.PenTool size={18}/> 
                            {isLocked ? 'å¢¨è·¡å·²ä¹¾ï¼(ä¸€ç­†å…¥é­‚)' : 'å…¨é›†ä¸­ãƒ»ä¸€ç­†ç¹ªè£½ï¼'}
                        </div>
                        <div className={`w-full aspect-square border-4 ${currStyle.border} rounded overflow-hidden relative shadow-lg ${isLocked?'opacity-90':''}`}>
                            <canvas ref={canvasRef} className="w-full h-full touch-none cursor-crosshair" 
                                onMouseDown={start} onMouseMove={move} onMouseUp={end} onMouseLeave={end}
                                onTouchStart={start} onTouchMove={move} onTouchEnd={end}
                            />
                            {isLocked && <div className="absolute inset-0 bg-black/10 flex items-center justify-center pointer-events-none text-red-600 font-black text-2xl tracking-[1em] opacity-50">å°å°</div>}
                        </div>
                        <div className="w-full flex justify-end mt-2"><button onClick={clear} className="text-sm text-gray-500 font-bold px-3 py-1 border rounded hover:bg-gray-100 flex items-center gap-1"><Icons.RotateCcw size={14}/> é‡ç•«</button></div>
                    </div>
                    <div className="mt-4 flex gap-3">
                        <button onClick={onCancel} className="flex-1 py-3 border-2 border-gray-400 text-gray-600 font-bold rounded-lg">å–æ¶ˆ</button>
                        <button onClick={save} className="flex-1 py-3 bg-k-green text-white font-bold rounded-lg shadow-md border-b-4 border-green-900 active:translate-y-1 active:border-b-0 transition-all">å‚³é€</button>
                    </div>
                </div>
            )
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
