<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¬¼æ»…ä¹‹åˆƒ x è–èª•ä¸€ç­†ç•« (å¤§æ­£æµªæ¼«ç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'kimetsu-green': '#1b4332', /* Deep Forest Green */
                        'kimetsu-black': '#18181b',
                        'kimetsu-gold': '#d4af37', /* Metallic Gold */
                        'xmas-red': '#991b1b', /* Velvet Red */
                        'xmas-white': '#f8fafc',
                        'paper': '#fdf6e3', /* Warm Paper */
                    },
                    fontFamily: {
                        'serif': ['"Noto Serif TC"', 'serif'],
                    },
                    backgroundImage: {
                        'checkered': "repeating-linear-gradient(45deg, #0f172a 25%, transparent 25%, transparent 75%, #0f172a 75%, #0f172a), repeating-linear-gradient(45deg, #0f172a 25%, #1b4332 25%, #1b4332 75%, #0f172a 75%, #0f172a)",
                        'japanese-pattern': "url('https://www.transparenttextures.com/patterns/black-scales.png')",
                    },
                    backgroundSize: {
                        'checkered': '40px 40px'
                    },
                    animation: {
                        'snow': 'snow 15s linear infinite',
                        'breathe': 'breathe 3s ease-in-out infinite',
                    },
                    keyframes: {
                        snow: {
                            '0%': { backgroundPosition: '0 0' },
                            '100%': { backgroundPosition: '50px 500px' }
                        },
                        breathe: {
                            '0%, 100%': { boxShadow: '0 0 5px #d4af37' },
                            '50%': { boxShadow: '0 0 20px #d4af37' }
                        }
                    }
                }
            }
        }
    </script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Noto Serif TC', serif; background-color: #0f172a; color: #18181b; }
        
        /* æ²è»¸éš±è— */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1b4332; }
        ::-webkit-scrollbar-thumb { background: #d4af37; border-radius: 3px; }

        /* Loader */
        #initial-loader { position: fixed; inset: 0; background: #0f172a; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s; }
        .katana-spinner {
            width: 60px; height: 60px;
            border: 4px solid #1b4332;
            border-top-color: #991b1b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden-loader { opacity: 0; pointer-events: none; }

        /* Nezuko Box 3D */
        .nezuko-box-container { perspective: 1000px; cursor: pointer; }
        .nezuko-door { 
            transform-origin: top; 
            transition: transform 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            background: #18181b;
            border: 2px solid #d4af37;
            /* Wood grain pattern css */
            background-image: repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(255,255,255,0.05) 2px, rgba(255,255,255,0.05) 4px);
        }
        .nezuko-box-container.open .nezuko-door { transform: rotateX(120deg); opacity: 0; pointer-events: none; }
        
        .noselect { user-select: none; -webkit-user-select: none; }
        
        /* Washi Paper Texture */
        .bg-paper-texture {
            background-color: #fdf6e3;
            background-image: url("https://www.transparenttextures.com/patterns/rice-paper-2.png");
        }
    </style>
</head>
<body class="overflow-x-hidden">

    <div id="initial-loader">
        <div class="katana-spinner"></div>
        <p class="mt-6 text-kimetsu-gold font-bold text-xl tracking-[0.5em] drop-shadow-lg">å…¨é›†ä¸­...é€£ç·šä¸­</p>
        <p id="error-msg" class="mt-4 text-red-400 text-xs max-w-md text-center hidden px-4"></p>
    </div>

    <div id="root"></div>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            const loader = document.getElementById('initial-loader');
            const errText = document.getElementById('error-msg');
            if (loader && errText) {
                loader.classList.remove('hidden-loader');
                document.querySelector('.katana-spinner').style.display = 'none';
                errText.classList.remove('hidden');
                errText.innerHTML = `<strong>ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼š</strong><br>${msg}<br><span style="opacity:0.7; font-size:10px;">è«‹å˜—è©¦é‡æ–°æ•´ç†é é¢ã€‚</span>`;
            }
            return false;
        };
    </script>

    <!-- App Logic -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0?dev';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client?dev';
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, collection, addDoc, onSnapshot, 
            doc, setDoc, updateDoc, getDocs, writeBatch, serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // --- Constants & Styles ---
        const RANKS = ['ç™¸', 'å£¬', 'è¾›', 'åºš', 'å·±', 'æˆŠ', 'ä¸', 'ä¸™', 'ä¹™', 'ç”²'];
        const HASHIRA = ['æ°´æŸ±', 'èŸ²æŸ±', 'ç‚æŸ±', 'éŸ³æŸ±', 'å²©æŸ±', 'æˆ€æŸ±', 'éœæŸ±', 'è›‡æŸ±', 'é¢¨æŸ±'];

        const getRandomRank = () => {
            if (Math.random() < 0.1) return HASHIRA[Math.floor(Math.random() * HASHIRA.length)];
            return RANKS[Math.floor(Math.random() * 5)];
        };

        const STYLES = {
            water: { name: 'æ°´ä¹‹å‘¼å¸', bg: 'bg-blue-50', border: 'border-blue-800', text: 'text-blue-900', icon: 'ğŸŒŠ', accent: 'bg-blue-800' },
            fire: { name: 'ç‚ä¹‹å‘¼å¸', bg: 'bg-red-50', border: 'border-red-800', text: 'text-red-900', icon: 'ğŸ”¥', accent: 'bg-red-800' },
            thunder: { name: 'é›·ä¹‹å‘¼å¸', bg: 'bg-yellow-50', border: 'border-yellow-600', text: 'text-yellow-900', icon: 'âš¡', accent: 'bg-yellow-600' },
            beast: { name: 'ç¸ä¹‹å‘¼å¸', bg: 'bg-stone-100', border: 'border-stone-700', text: 'text-stone-800', icon: 'ğŸ—', accent: 'bg-stone-700' },
            insect: { name: 'èŸ²ä¹‹å‘¼å¸', bg: 'bg-purple-50', border: 'border-purple-800', text: 'text-purple-900', icon: 'ğŸ¦‹', accent: 'bg-purple-800' },
            default: { name: 'æ™®é€šéšŠå“¡', bg: 'bg-white', border: 'border-gray-800', text: 'text-gray-900', icon: 'âš”ï¸', accent: 'bg-gray-800' }
        };

        const getStyle = (key) => STYLES[key] || STYLES.default;

        // --- Icons (SVG) ---
        const Icon = ({ path, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );
        const Icons = {
            Pen: (p) => <Icon {...p} path={<><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></>} />,
            Users: (p) => <Icon {...p} path={<><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />,
            Eye: (p) => <Icon {...p} path={<><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></>} />,
            Rotate: (p) => <Icon {...p} path={<><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></>} />,
            Save: (p) => <Icon {...p} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />,
            Check: (p) => <Icon {...p} path={<polyline points="20 6 9 17 4 12"/>} />,
            Lock: (p) => <Icon {...p} path={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>} />,
            LogOut: (p) => <Icon {...p} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></>} />,
            Trash: (p) => <Icon {...p} path={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>} />,
            Img: (p) => <Icon {...p} path={<><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></>} />,
            Edit: (p) => <Icon {...p} path={<><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></>} />,
            Settings: (p) => <Icon {...p} path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />,
            ArrowRight: (p) => <Icon {...p} path={<><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></>} />,
            ArrowLeft: (p) => <Icon {...p} path={<><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></>} />,
            WifiOff: (p) => <Icon {...p} path={<><line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></>} />,
        };

        const ChristmasDecor = () => (
            <div className="absolute top-0 right-0 p-2 pointer-events-none opacity-80">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#c62828" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M12 2L15 8L21 9L17 14L18 20L12 17L6 20L7 14L3 9L9 8Z" fill="#fbc02d" stroke="#fbc02d"/>
                </svg>
            </div>
        );

        // --- Styled Components ---
        const KimetsuCard = ({ children, className = "", styleName="default" }) => {
            const s = getStyle(styleName);
            return (
                <div className={`bg-paper-texture rounded-xl shadow-lg border-2 ${s.border} relative overflow-hidden ${className}`}>
                    <div className={`absolute top-0 left-0 w-full h-1 ${s.accent}`}></div>
                    <ChristmasDecor />
                    {children}
                </div>
            );
        };

        const NezukoGiftBox = ({ children, isLocked }) => {
            const [isOpen, setIsOpen] = useState(false);
            const toggle = () => {
                if(isLocked) return alert("ä»»å‹™å°šæœªè§£é–ï¼");
                setIsOpen(!isOpen);
            }
            return (
                <div onClick={toggle} className={`relative w-full h-full bg-kimetsu-black border-4 border-kimetsu-gold rounded-lg shadow-2xl cursor-pointer nezuko-box-container ${isOpen?'open':''}`}>
                    <div className="absolute inset-0 bg-white flex items-center justify-center p-2">{children}</div>
                    <div className="absolute inset-0 nezuko-door flex flex-col items-center justify-center z-20">
                        {/* è£é£¾ç¶å¸¶ */}
                        <div className="absolute inset-x-0 top-1/4 h-2 bg-xmas-red opacity-80"></div>
                        <div className="absolute inset-x-0 bottom-1/4 h-2 bg-xmas-red opacity-80"></div>
                        <div className="absolute inset-y-0 left-1/4 w-2 bg-xmas-red opacity-80"></div>
                        <div className="absolute inset-y-0 right-1/4 w-2 bg-xmas-red opacity-80"></div>
                        
                        <div className="w-24 h-24 bg-paper rounded-full flex items-center justify-center border-4 border-kimetsu-gold shadow-lg transform rotate-12 relative z-30">
                            <span className="text-4xl font-black text-nezuko-pink">ç¦°</span>
                        </div>
                        <div className="mt-8 bg-black/80 text-kimetsu-gold text-sm px-4 py-1 rounded-full border border-kimetsu-gold font-bold tracking-widest relative z-30">
                            {isOpen ? 'é»æ“Šé—œé–‰' : 'é»æ“Šé–‹ç®±'}
                        </div>
                    </div>
                </div>
            )
        };

        const LongPressButton = ({ onComplete, label, icon: Icon, disabled }) => {
            const [pressing, setPressing] = useState(false);
            const [progress, setProgress] = useState(0);
            const timer = useRef(null);

            useEffect(() => {
                if(pressing && !disabled) {
                    timer.current = setInterval(() => setProgress(p => p >= 100 ? 100 : p + 4), 30);
                } else {
                    setProgress(0);
                    clearInterval(timer.current);
                }
                return () => clearInterval(timer.current);
            }, [pressing, disabled]);

            useEffect(() => { if(progress === 100) { setPressing(false); onComplete(); } }, [progress]);

            return (
                <button 
                    onMouseDown={()=>setPressing(true)} onMouseUp={()=>setPressing(false)} onMouseLeave={()=>setPressing(false)}
                    onTouchStart={()=>setPressing(true)} onTouchEnd={()=>setPressing(false)}
                    disabled={disabled}
                    className={`relative w-full py-4 border-2 border-xmas-red text-xmas-red rounded-xl font-bold overflow-hidden noselect transition-transform active:scale-95 bg-white ${disabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-red-50'}`}
                >
                    <div className="absolute inset-0 bg-xmas-red/20 transition-all ease-linear" style={{width: `${progress}%`}}></div>
                    <span className="relative z-10 flex items-center justify-center gap-2">{Icon && <Icon size={20}/>} {pressing ? (progress===100?'å·²ç¢ºèª':'é•·æŒ‰éŠ·æ¯€...') : label}</span>
                </button>
            )
        };

        const ConfigWizard = ({ onConfigComplete, onOfflineMode }) => {
            const [val, setVal] = useState('');
            const [err, setErr] = useState('');
            const save = () => {
                try {
                    let s = val.trim().replace(/^(const|let|var|export\s+const)\s+\w+\s*=\s*/, '').replace(/;$/, '');
                    let c; try { c = JSON.parse(s); } catch { c = new Function(`return {${s}}`)(); }
                    if(!c || !c.apiKey) throw new Error("æ ¼å¼éŒ¯èª¤ï¼Œæ‰¾ä¸åˆ° apiKey");
                    localStorage.setItem('fb_config_override', JSON.stringify(c));
                    onConfigComplete(c);
                } catch(e) { setErr(e.message); }
            };
            return (
                <div className="min-h-screen flex items-center justify-center p-4 relative z-10">
                    <KimetsuCard className="p-8 w-full max-w-lg bg-paper-texture">
                        <h2 className="text-2xl font-bold text-center mb-6 text-kimetsu-green flex items-center justify-center gap-2">
                            <Icons.Settings className="text-kimetsu-gold"/> ç¸½éƒ¨é€£ç·šè¨­å®š
                        </h2>
                        <textarea className="w-full h-32 p-3 border-2 border-kimetsu-green rounded-lg bg-white mb-4 font-mono text-xs focus:ring-2 ring-kimetsu-gold outline-none text-black" value={val} onChange={e=>setVal(e.target.value)} placeholder="è²¼ä¸Š Firebase Config..."></textarea>
                        {err && <p className="text-red-600 text-xs mb-2">{err}</p>}
                        <div className="space-y-3">
                            <button onClick={save} className="w-full py-3 bg-kimetsu-green text-white font-bold rounded-lg shadow-md border-b-4 border-kimetsu-dark-green hover:bg-green-800 transition">é€£ç·š</button>
                            <button onClick={onOfflineMode} className="w-full py-3 bg-kimetsu-gold text-kimetsu-black font-bold rounded-lg shadow-md border-b-4 border-yellow-700 hover:bg-yellow-500 transition">é›¢ç·šæ¨¡å¼</button>
                        </div>
                    </KimetsuCard>
                </div>
            );
        };

        const App = () => {
            const [mode, setMode] = useState('loading');
            const [view, setView] = useState('home');
            const [users, setUsers] = useState([]);
            const [matches, setMatches] = useState({});
            const [myId, setMyId] = useState(localStorage.getItem('pid'));
            const [reveal, setReveal] = useState(null);
            const [loading, setLoading] = useState(false);
            
            const [adminPwd, setAdminPwd] = useState('');
            const [userPwd, setUserPwd] = useState('');
            const [targetUser, setTargetUser] = useState(null);
            const [editData, setEditData] = useState(null);
            const [showPwd, setShowPwd] = useState(false);
            
            const [liveHistory, setLiveHistory] = useState([]);
            const [liveIdx, setLiveIdx] = useState(-1);
            const [showGiver, setShowGiver] = useState(false);

            const appRef = useRef(null);
            const dbRef = useRef(null);
            const appId = 'xmas-draw-v3';

            useEffect(() => {
                const init = async () => {
                    const l = document.getElementById('initial-loader');
                    if(l) l.classList.add('hidden-loader');
                    try {
                        let c = null;
                        if(typeof __firebase_config !== 'undefined') c = JSON.parse(__firebase_config);
                        else { const s = localStorage.getItem('fb_config_override'); if(s) c = JSON.parse(s); }
                        
                        if(c && c.apiKey) {
                            appRef.current = initializeApp(c);
                            dbRef.current = getFirestore(appRef.current);
                            const auth = getAuth(appRef.current);
                            if(typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                            else await signInAnonymously(auth);
                            setMode('cloud');
                        } else setMode('setup');
                    } catch(e) { console.error(e); setMode('setup'); }
                };
                init();
            }, []);

            useEffect(() => {
                if(mode !== 'cloud' || !dbRef.current) return;
                const unsubU = onSnapshot(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'users'), s => {
                    const list = s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(a.createdAt?.seconds||0)-(b.createdAt?.seconds||0));
                    setUsers(list);
                    if(localStorage.getItem('pid') && !list.find(u=>u.id===localStorage.getItem('pid'))) {
                        localStorage.removeItem('pid'); setMyId(null); localStorage.removeItem('pwd_bk');
                    }
                });
                const unsubM = onSnapshot(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'matches'), s => {
                    const m={}; s.forEach(d => m[d.id] = d.data().rid); setMatches(m);
                });
                return () => { unsubU(); unsubM(); };
            }, [mode]);

            useEffect(() => {
                if(mode !== 'offline') return;
                const u = localStorage.getItem('xusers'); if(u) setUsers(JSON.parse(u));
                const m = localStorage.getItem('xmatches'); if(m) setMatches(JSON.parse(m));
            }, [mode]);

            const resetAll = async () => {
                setLoading(true);
                if(mode==='cloud') {
                    const b = writeBatch(dbRef.current);
                    const u = await getDocs(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'users'));
                    u.forEach(d=>b.delete(d.ref));
                    const m = await getDocs(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'matches'));
                    m.forEach(d=>b.delete(d.ref));
                    await b.commit();
                } else {
                    localStorage.removeItem('xusers'); localStorage.removeItem('xmatches');
                    setUsers([]); setMatches({});
                }
                localStorage.removeItem('pid'); setMyId(null);
                setLiveHistory([]); setLiveIdx(-1);
                setView('home'); setLoading(false);
            };

            const doMatch = async () => {
                if(users.length<2) return alert('äººæ•¸ä¸è¶³');
                if(Object.keys(matches).length>0 && !confirm('é‡æ–°åˆ†é…ï¼Ÿ')) return;
                setLoading(true);
                let g = users.map(u=>u.id), r = [...g], v=false;
                while(!v) {
                    for(let i=r.length-1;i>0;i--) { const j=Math.floor(Math.random()*(i+1)); [r[i],r[j]]=[r[j],r[i]]; }
                    v=true; for(let i=0;i<g.length;i++) if(g[i]===r[i]) v=false;
                }
                if(mode==='cloud') {
                    const b = writeBatch(dbRef.current);
                    g.forEach((gid,i)=>b.set(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'matches', gid), {rid:r[i]}));
                    await b.commit();
                } else {
                    const nm={}; g.forEach((gid,i)=>nm[gid]=r[i]);
                    setMatches(nm); localStorage.setItem('xmatches', JSON.stringify(nm));
                }
                alert('åˆ†é…å®Œæˆ'); setLoading(false);
            };

            const saveMe = async (name, pwd, img, style) => {
                setLoading(true);
                if(users.some(u => u.name === name && u.id !== myId)) {
                    alert('åç¨±é‡è¤‡'); setLoading(false); return;
                }
                localStorage.setItem('pwd_bk', pwd);
                const rank = getRandomRank();
                const d = { name, pwd, img, style, rank, uid: 'anon', createdAt: serverTimestamp() };
                
                if(myId) {
                    if(mode==='cloud') await updateDoc(doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'users', myId), { ...d, rank: undefined });
                    else {
                        const nu = users.map(u=>u.id===myId?{...u, name, pwd, img, style}:u);
                        setUsers(nu); localStorage.setItem('xusers', JSON.stringify(nu));
                    }
                    setView('my_card');
                } else {
                    if(mode==='cloud') {
                        const ref = await addDoc(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'users'), d);
                        localStorage.setItem('pid', ref.id); setMyId(ref.id);
                    } else {
                        const id = Date.now().toString();
                        const nu = [...users, {...d, id}];
                        setUsers(nu); localStorage.setItem('xusers', JSON.stringify(nu));
                        localStorage.setItem('pid', id); setMyId(id);
                    }
                    setView('home');
                }
                setLoading(false); setEditData(null);
            };

            const loginUser = () => {
                if(targetUser.pwd !== userPwd) return alert('å¯†ç¢¼éŒ¯èª¤');
                localStorage.setItem('pid', targetUser.id);
                localStorage.setItem('pwd_bk', userPwd);
                setMyId(targetUser.id);
                if(!matches[targetUser.id]) setView('my_card');
                else {
                    const r = users.find(u=>u.id===matches[targetUser.id]);
                    setReveal({g:targetUser, r});
                    setView('check_result');
                }
                setTargetUser(null);
            };

            // --- CHAIN LOGIC: GIVER BECOMES NEXT RECEIVER ---
            const nextLive = () => {
                if(liveIdx < liveHistory.length - 1) {
                    setLiveIdx(p=>p+1); setShowGiver(false); return;
                }
                
                const drawn = new Set(liveHistory.map(u=>u.id));
                let next = null;

                // Chain Strategy
                if(liveHistory.length > 0) {
                    const currentReceiver = liveHistory[liveHistory.length-1];
                    // Find who gave to 'currentReceiver'. That person is on stage now, so they become the next receiver.
                    // matches: Giver -> Receiver. So find GID where matches[GID] == currentReceiver.id
                    const giverId = Object.keys(matches).find(gid => matches[gid] === currentReceiver.id);
                    
                    if(giverId && !drawn.has(giverId)) {
                        next = users.find(u=>u.id===giverId);
                    }
                }

                // If chain breaks (or start), pick random
                if(!next) {
                    const rem = users.filter(u=>!drawn.has(u.id));
                    if(rem.length===0) return alert('å…¨å“¡å·²ä¸Šå°');
                    next = rem[Math.floor(Math.random()*rem.length)];
                }

                const nh = [...liveHistory, next];
                setLiveHistory(nh); setLiveIdx(nh.length-1); setShowGiver(false);
            };

            const currLive = liveIdx>=0 ? liveHistory[liveIdx] : null;
            // liveGiver: The person who gave the gift TO currLive
            const liveGiver = currLive ? users.find(u=>matches[u.id]===currLive.id) : null;

            if(mode==='loading') return null;
            if(mode==='setup') return <ConfigWizard onConfigComplete={()=>window.location.reload()} onOfflineMode={()=>{setMode('offline'); setView('home');}}/>;

            // Wrapper with Christmas x Demon Slayer Atmosphere
            const Wrapper = ({ children }) => (
                <div className="min-h-screen relative bg-kimetsu-black overflow-hidden font-serif">
                    {/* Background */}
                    <div className="fixed inset-0 pointer-events-none opacity-20 bg-checkered z-0"></div>
                    <div className="fixed inset-0 pointer-events-none z-0 bg-[url('https://www.transparenttextures.com/patterns/snow.png')] opacity-20 animate-snow"></div>
                    
                    <div className="relative z-10 w-full max-w-md mx-auto min-h-screen bg-paper-texture shadow-2xl flex flex-col border-x-8 border-kimetsu-green">
                        <header className="bg-kimetsu-black text-white p-4 flex justify-between items-center border-b-4 border-xmas-gold sticky top-0 z-50 shadow-md">
                            <div className="flex items-center gap-2">
                                <span className="text-2xl">ğŸ‘º</span>
                                <h1 className="text-lg font-bold tracking-widest text-xmas-gold">è–èª•æŸ±åˆæœƒè­°</h1>
                            </div>
                            <div className="flex gap-2">
                                {users.length > 0 && <button onClick={()=>setView('reveal')} className="text-xs bg-xmas-red px-2 py-1 rounded font-bold border border-red-400 hover:bg-red-800 transition shadow">ä»»å‹™</button>}
                                <button onClick={()=>setView('admin_login')} className="text-xs border border-gray-500 px-2 py-1 rounded text-gray-400 hover:text-white">å¾Œå°</button>
                            </div>
                        </header>
                        <main className="flex-1 p-4 flex flex-col relative">
                            {children}
                        </main>
                    </div>
                </div>
            );

            // --- Admin Live View (Big Screen) ---
            if(view === 'admin_live') return (
                <div className="min-h-screen bg-kimetsu-black text-white flex flex-col relative overflow-hidden font-serif">
                    <div className="absolute top-0 w-full h-2 bg-gradient-to-r from-kimetsu-green via-xmas-red to-kimetsu-green"></div>
                    <div className="fixed inset-0 pointer-events-none opacity-30 bg-[url('https://www.transparenttextures.com/patterns/snow.png')] animate-snow"></div>
                    
                    <header className="p-4 z-20 flex justify-between items-center bg-black/60 backdrop-blur border-b border-white/10">
                        <h1 className="text-2xl font-bold text-xmas-gold tracking-widest flex items-center gap-2"><Icons.Users/> ç¦®ç‰©äº¤ä»˜å„€å¼ (æ¥é¾æ¨¡å¼)</h1>
                        <div className="flex gap-2">
                            <button onClick={()=>{if(confirm('é‡ç½®?')) {setLiveHistory([]); setLiveIdx(-1);}}} className="border border-red-500 text-red-500 px-3 py-1 rounded text-sm hover:bg-red-900">é‡ç½®</button>
                            <button onClick={()=>setView('admin_dash')} className="border px-3 py-1 rounded text-sm hover:bg-white hover:text-black">é€€å‡º</button>
                        </div>
                    </header>

                    <div className="flex-1 flex flex-col items-center justify-center relative z-10 p-4">
                        {!currLive ? (
                            <div className="text-center space-y-6 animate-fade-in bg-black/40 p-10 rounded-2xl border-2 border-kimetsu-green">
                                <div className="text-7xl animate-bounce">ğŸ</div>
                                <h2 className="text-4xl font-bold tracking-widest text-kimetsu-green">å„€å¼é–‹å§‹</h2>
                                <p className="text-gray-400 font-bold">å‰©é¤˜ {users.length - liveHistory.length} äºº</p>
                                <button onClick={nextLive} className="px-10 py-4 bg-gradient-to-r from-xmas-red to-red-900 rounded-lg text-2xl font-bold shadow-lg border-2 border-xmas-gold hover:scale-105 transition-transform">å¬å–šç¬¬ä¸€ä½</button>
                            </div>
                        ) : (
                            <div className="w-full max-w-6xl grid md:grid-cols-2 gap-12 items-center animate-fade-in">
                                <div className="flex flex-col items-center">
                                    <div className="text-xmas-gold tracking-[0.3em] font-bold mb-2 text-xl bg-black/50 px-4 py-1 rounded-full">å—è´ˆè€…</div>
                                    <h2 className="text-6xl font-black text-white mb-8 border-b-4 border-xmas-red pb-2 shadow-black drop-shadow-lg">{currLive.name}</h2>
                                    <div className="w-full aspect-square max-w-md relative transform -rotate-1">
                                        <NezukoGiftBox isLocked={false}>
                                            <img src={currLive.img} className="w-full h-full object-contain bg-white rounded" />
                                        </NezukoGiftBox>
                                    </div>
                                </div>

                                <div className="flex flex-col items-center justify-center bg-white/10 p-10 rounded-3xl border-2 border-white/20 backdrop-blur-md shadow-2xl relative">
                                    <div className="absolute -top-6 -right-6 text-5xl">ğŸ„</div>
                                    <p className="text-gray-200 text-xl mb-6 font-bold">é€™ä»½ç¦®ç‰©ä¾†è‡ª...</p>
                                    {!showGiver ? (
                                        <button onClick={()=>setShowGiver(true)} className="w-full py-8 bg-xmas-gold text-black font-black text-3xl rounded-2xl shadow-xl hover:bg-yellow-400 transition-colors border-b-8 border-yellow-700 active:border-b-0 active:translate-y-2">
                                            æ­æ›‰é€ç¦®è€…
                                        </button>
                                    ) : (
                                        <div className="text-center animate-fade-in w-full">
                                            <div className="text-7xl mb-4">ğŸ…</div>
                                            <div className="bg-white text-black text-5xl font-black py-6 px-10 rounded-2xl border-4 border-kimetsu-green shadow-[0_0_40px_rgba(16,185,129,0.6)]">
                                                {liveGiver ? liveGiver.name : "æœªçŸ¥"}
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div className="flex w-full gap-4 mt-12">
                                        <button onClick={()=>{if(liveIdx>0){setLiveIdx(p=>p-1);setShowGiver(false);}}} disabled={liveIdx<=0} className={`flex-1 py-4 border-2 border-white/30 rounded-xl text-lg font-bold hover:bg-white/10 ${liveIdx<=0?'opacity-30':''}`}>ä¸Šä¸€å€‹</button>
                                        <button onClick={nextLive} className="flex-[2] py-4 bg-kimetsu-green text-white font-bold rounded-xl shadow-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2 border-b-4 border-green-900 active:border-b-0 active:translate-y-1 text-lg">
                                            {liveIdx < liveHistory.length-1 ? 'ä¸‹ä¸€ä½ (æ­·å²)' : 'æ¥é¾ä¸‹ä¸€ä½'} <Icons.ArrowRight size={24}/>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );

            // --- Home View ---
            if(view === 'home') return (
                <Wrapper>
                    <div className="flex flex-col items-center justify-center h-full gap-8 py-8 animate-fade-in">
                        <div className="text-center w-full transform rotate-1 bg-white p-8 rounded-lg border-4 border-kimetsu-black shadow-xl relative">
                            <div className="absolute -top-5 -left-5 text-4xl transform -rotate-12">ğŸ‘º</div>
                            <div className="absolute -bottom-5 -right-5 text-4xl transform rotate-12">ğŸ„</div>
                            <h2 className="text-3xl font-black text-kimetsu-green mb-2 tracking-[0.2em]">å…¨é›†ä¸­</h2>
                            <h3 className="text-5xl font-black text-xmas-red mb-6 tracking-widest border-b-4 border-xmas-gold inline-block pb-2">è–èª•å‘¼å¸</h3>
                            <div className="bg-gray-100 py-3 rounded-lg border-2 border-dashed border-gray-300">
                                <p className="text-gray-700 font-bold text-lg">ç¾ä»»éšŠå“¡ï¼š<span className="text-xmas-red text-4xl font-black mx-2">{users.length}</span>å</p>
                            </div>
                        </div>

                        <div className="w-full space-y-4">
                            {!myId ? (
                                <button onClick={()=>{setEditData(null); setView('draw');}} className="w-full py-5 bg-kimetsu-green text-white rounded-xl shadow-lg font-bold text-xl flex items-center justify-center gap-3 border-b-4 border-green-900 active:border-b-0 active:translate-y-1 transition-all">
                                    <Icons.PenTool size={24}/> å…¥éšŠè€ƒæ ¸ (ç¹ªè£½)
                                </button>
                            ) : (
                                <button onClick={()=>setView('my_card')} className="w-full py-5 bg-white border-4 border-kimetsu-green text-kimetsu-green rounded-xl shadow-md font-bold text-xl flex items-center justify-center gap-3 hover:bg-green-50 active:scale-95 transition-all">
                                    <Icons.Img size={24}/> æˆ‘çš„ä»»å‹™å·è»¸
                                </button>
                            )}
                            <button onClick={()=>setView('list')} className="w-full py-4 bg-kimetsu-black text-white rounded-xl font-bold text-lg border-b-4 border-black hover:bg-gray-800 transition-colors flex items-center justify-center gap-2">
                                <Icons.Users/> éšŠå“¡åå†Š (å…¬é–‹)
                            </button>
                        </div>
                        {myId && <button onClick={()=>{if(confirm('éš±é€€?')) {localStorage.removeItem('pid'); setMyId(null);}}} className="mt-auto text-xs text-gray-400 border-b border-gray-300 pb-1">è§£é™¤éšŠå“¡èº«ä»½</button>}
                    </div>
                </Wrapper>
            );

            // --- List View (Updated: No Nezuko Box, Direct Grid) ---
            if(view === 'list') return (
                <Wrapper>
                    <h2 className="text-2xl font-bold mb-6 text-kimetsu-black text-center border-b-4 border-xmas-gold pb-2 inline-block mx-auto flex items-center gap-2">
                        <Icons.Users/> éšŠå“¡åå†Š
                    </h2>
                    <div className="grid grid-cols-2 gap-4 overflow-y-auto pb-4">
                        {users.map((u,i) => {
                            const s = getStyle(u.style);
                            return (
                                <div key={u.id} className={`p-2 rounded-lg border-2 shadow-sm flex flex-col items-center bg-white ${s.border} relative transition-transform hover:scale-[1.02]`}>
                                    <div className="absolute top-1 left-2 text-xs font-mono text-gray-400 font-bold">#{i+1}</div>
                                    <div className="w-full aspect-square bg-gray-50 rounded mb-2 overflow-hidden border border-gray-200 mt-5">
                                        <img src={u.img} className="w-full h-full object-contain" />
                                    </div>
                                    <div className="text-xs text-gray-500 mb-1 flex items-center gap-1">{s.icon} {s.name}</div>
                                    <div className={`font-bold text-sm truncate w-full text-center ${s.text}`}>{u.name}</div>
                                    {u.id === myId && <span className="absolute top-1 right-1 bg-kimetsu-black text-white text-[10px] px-1.5 py-0.5 rounded">æˆ‘</span>}
                                </div>
                            )
                        })}
                    </div>
                    <button onClick={()=>setView('home')} className="mt-auto w-full py-4 bg-white border-2 border-kimetsu-black font-bold rounded-xl hover:bg-gray-100">è¿”å›</button>
                </Wrapper>
            );

            // --- Draw View ---
            if(view === 'draw') return (
                <Wrapper>
                    <DrawingPad initialData={editData} onSave={saveMe} onCancel={()=>setView(editData?'my_card':'home')} />
                </Wrapper>
            );

            // --- My Card View ---
            if(view === 'my_card') return (
                <Wrapper>
                    {(() => {
                        const me = users.find(u=>u.id===myId);
                        if(!me) return <div className="text-center mt-10">è³‡æ–™å·²éºå¤±</div>;
                        const isLocked = !!matches[me.id];
                        const style = getStyle(me.style);
                        return (
                            <div className="flex flex-col h-full animate-fade-in items-center">
                                <h2 className="text-2xl font-bold mb-4 text-kimetsu-black flex items-center gap-2">æˆ‘çš„å·è»¸</h2>
                                <KimetsuCard className={`w-full p-6 mb-6 ${style.bg} border-4`}>
                                    <div className="flex justify-between items-center mb-4 border-b-2 border-black/10 pb-2">
                                        <span className={`text-sm font-bold ${style.text} bg-white/80 px-2 rounded border border-black/10`}>éšç´š: {me.rank}</span>
                                        <span className={`font-bold text-xl ${style.text}`}>{me.name}</span>
                                    </div>
                                    <div className={`aspect-square bg-white border-4 ${style.border} relative shadow-inner rounded-lg overflow-hidden`}>
                                        <img src={me.img} className="w-full h-full object-contain"/>
                                        {isLocked && <div className="absolute inset-0 bg-black/60 flex items-center justify-center text-white font-bold text-3xl tracking-widest border-4 border-white m-4">å° å°</div>}
                                    </div>
                                </KimetsuCard>
                                {!isLocked ? (
                                    <button onClick={()=>{setEditData(me); setView('draw');}} className="w-full py-4 bg-kimetsu-black text-white font-bold rounded-xl shadow-lg border-b-4 border-black active:border-b-0 active:translate-y-1 transition-all"><Icons.Edit/> ä¿®æ”¹å·è»¸</button>
                                ) : (
                                    <div className="w-full p-4 bg-gray-200 text-gray-600 text-center font-bold rounded-xl border-2 border-gray-300">ä»»å‹™å·²ä¸‹é”ï¼Œç„¡æ³•ä¿®æ”¹</div>
                                )}
                                <button onClick={()=>setView('home')} className="mt-auto w-full py-3 text-gray-500 font-bold hover:text-kimetsu-black">è¿”å›</button>
                            </div>
                        )
                    })()}
                </Wrapper>
            );

            if(view === 'reveal') return (
                <Wrapper>
                    <div className="text-center mb-6">
                        <h2 className="text-2xl font-bold text-kimetsu-black tracking-widest">{Object.keys(matches).length>0?'ä»»å‹™ä¸‹é”':'å·è»¸ç¢ºèª'}</h2>
                        <p className="text-sm text-gray-500 mt-1">é»æ“Šåå­—è§£é–‹</p>
                    </div>
                    <div className="grid grid-cols-2 gap-3 overflow-y-auto pb-6">
                        {users.map(u => {
                            const s = getStyle(u.style);
                            return (
                                <button key={u.id} onClick={()=>{setTargetUser(u); setUserPwd(myId===u.id?localStorage.getItem('pwd_bk')||'':''); setView('login');}} 
                                    className={`relative p-4 rounded-xl border-2 bg-white shadow-sm hover:bg-gray-50 transition-transform active:scale-95 flex flex-col items-center gap-2 aspect-square justify-center ${s.border}`}>
                                    {myId===u.id && <div className="absolute top-2 right-2 w-3 h-3 bg-kimetsu-green rounded-full border border-white"></div>}
                                    <Icons.Lock className="text-gray-300"/>
                                    <span className={`font-bold ${s.text} truncate w-full text-center`}>{u.name}</span>
                                </button>
                            )
                        })}
                    </div>
                    <button onClick={()=>setView('home')} className="mt-auto w-full py-4 bg-white border-2 border-kimetsu-black font-bold rounded-xl">è¿”å›</button>
                </Wrapper>
            );

            if(view === 'login') return (
                <Wrapper>
                    <div className="flex flex-col items-center justify-center h-full">
                        <KimetsuCard className="p-8 w-full bg-white">
                            <h2 className="text-xl font-bold text-center mb-6">èº«åˆ†é©—è­‰</h2>
                            <p className="text-center mb-4 font-bold text-kimetsu-black">{targetUser.name}</p>
                            <input type="password" value={userPwd} onChange={e=>setUserPwd(e.target.value)} className="w-full p-3 text-center border-2 border-gray-300 rounded-lg mb-6 tracking-[0.5em] font-bold text-xl outline-none focus:border-xmas-gold" placeholder="â€¢â€¢â€¢â€¢"/>
                            <div className="flex gap-3">
                                <button onClick={()=>setView('reveal')} className="flex-1 py-3 bg-gray-200 font-bold rounded-lg">å–æ¶ˆ</button>
                                <button onClick={loginUser} className="flex-1 py-3 bg-kimetsu-black text-white font-bold rounded-lg border-b-4 border-black active:border-b-0 active:translate-y-1 transition-all">è§£é–‹</button>
                            </div>
                        </KimetsuCard>
                    </div>
                </Wrapper>
            );

            if(view === 'check_result' && reveal) return (
                <Wrapper>
                    <div className="flex flex-col h-full items-center justify-center animate-fade-in">
                        <div className="w-full bg-kimetsu-black text-white p-4 text-center rounded-t-xl border-b-4 border-xmas-gold">
                            <div className="text-xs text-kimetsu-green mb-1">TO: éšŠå“¡</div>
                            <div className="text-2xl font-bold">{reveal.g.name}</div>
                        </div>
                        <KimetsuCard className="p-8 w-full rounded-t-none mb-6 text-center bg-white">
                            <p className="text-gray-500 mb-2 font-bold">ä½ çš„é€ç¦®å°è±¡æ˜¯</p>
                            <div className="text-3xl font-black text-xmas-red mb-6 tracking-widest">{reveal.r ? "??? (ç¥ç§˜éšŠå“¡)" : "éŒ¯èª¤"}</div>
                            <div className="bg-gray-100 p-2 border-2 border-dashed border-gray-300 rounded-lg relative">
                                {reveal.r && <img src={reveal.r.img} className="w-full" />}
                            </div>
                            <p className="text-xs text-gray-400 mt-2">è«‹ä¾ç…§æŒ‡ç¤ºæº–å‚™ç¦®ç‰©</p>
                        </KimetsuCard>
                        <button onClick={()=>setView('reveal')} className="w-full py-4 bg-xmas-red text-white font-bold rounded-xl shadow-lg border-b-4 border-red-900 active:scale-95 transition-transform">éµå‘½ (ç™»å‡º)</button>
                    </div>
                </Wrapper>
            );

            if(view === 'admin_login') return (
                <Wrapper>
                    <div className="flex flex-col items-center justify-center h-full">
                        <KimetsuCard className="p-8 w-full bg-white">
                            <h2 className="text-xl font-bold text-center mb-6">ä¸»å…¬å¤§äºº</h2>
                            <input type="password" value={adminPwd} onChange={e=>setAdminPwd(e.target.value)} className="w-full p-3 text-center border-2 border-gray-300 rounded-lg mb-6 font-bold" placeholder="æš—è™Ÿ"/>
                            <button onClick={()=>{if(adminPwd==='admin123'){setView('admin_dash');setAdminPwd('');}else alert('éŒ¯èª¤');}} className="w-full py-3 bg-kimetsu-black text-white font-bold rounded-lg border-b-4 border-black active:border-b-0 active:translate-y-1">é€²å…¥</button>
                            <button onClick={()=>setView('home')} className="w-full py-3 mt-2 text-gray-400 text-sm">è¿”å›</button>
                        </KimetsuCard>
                    </div>
                </Wrapper>
            );

            if(view === 'admin_dash') return (
                <Wrapper>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold">ç¸½éƒ¨å¾Œå°</h2>
                        <button onClick={()=>setView('home')} className="text-sm bg-gray-200 px-3 py-1 rounded">é›¢é–‹</button>
                    </div>
                    <div className="space-y-6 overflow-y-auto flex-1 pb-10">
                        <div className="bg-gradient-to-r from-kimetsu-black to-gray-800 p-6 rounded-xl shadow-lg text-white flex justify-between items-center border-2 border-xmas-gold">
                            <div><h3 className="font-bold text-xl text-kimetsu-green">ç¾å ´å„€å¼</h3><p className="text-xs opacity-70">é–‹å•Ÿå¤§è¢å¹•æŠ½ç±¤</p></div>
                            <button onClick={()=>setView('admin_live')} className="px-6 py-2 bg-xmas-red rounded-lg font-bold shadow border border-white hover:bg-red-700">é€²å…¥</button>
                        </div>
                        
                        <KimetsuCard className="p-6 bg-white">
                            <h3 className="font-bold border-b pb-2 mb-4">ä»»å‹™æŒ‡æ´¾</h3>
                            <div className="space-y-3">
                                <button onClick={doMatch} disabled={loading} className="w-full py-3 bg-kimetsu-green text-white font-bold rounded-lg shadow-sm border-b-4 border-green-800 active:border-b-0 active:translate-y-1">{Object.keys(matches).length>0?'é‡æ–°åˆ†é…':'é–‹å§‹åˆ†é…'}</button>
                                <LongPressButton label="éŠ·æ¯€è³‡æ–™" icon={Icons.Trash} onComplete={resetAll} disabled={loading}/>
                            </div>
                        </KimetsuCard>

                        <KimetsuCard className="p-6 bg-white">
                            <div className="flex justify-between mb-4"><h3 className="font-bold">éšŠå“¡è³‡æ–™</h3><button onClick={()=>setShowPwd(!showPwd)} className="text-xs bg-gray-200 px-2 rounded">{showPwd?'éš±è—':'é¡¯ç¤ºå¯†ç¢¼'}</button></div>
                            <div className="grid grid-cols-2 gap-3">
                                {users.map(u=>(
                                    <div key={u.id} className="border p-2 rounded bg-white text-center">
                                        <div className="aspect-square bg-gray-50 mb-2 border border-gray-200 rounded overflow-hidden"><img src={u.img} className="w-full h-full object-contain"/></div>
                                        <div className="font-bold text-sm truncate">{u.name}</div>
                                        {showPwd && <div className="text-xs text-red-500">{u.pwd}</div>}
                                    </div>
                                ))}
                            </div>
                        </KimetsuCard>
                    </div>
                </Wrapper>
            );

            return null;
        };

        const DrawingPad = ({ initialData, onSave, onCancel }) => {
            const canvasRef = useRef(null);
            const [name, setName] = useState(initialData?.name||'');
            const [pwd, setPwd] = useState(initialData?.pwd||'');
            const [style, setStyle] = useState(initialData?.style||'water');
            const [isDrawn, setIsDrawn] = useState(false);
            const [isLocked, setIsLocked] = useState(false);

            useEffect(() => {
                const c = canvasRef.current;
                const ctx = c.getContext('2d');
                c.width = c.parentElement.clientWidth;
                c.height = c.parentElement.clientWidth;
                ctx.fillStyle = '#fff'; ctx.fillRect(0,0,c.width,c.height);
                ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle='#000'; ctx.lineWidth=6;
                if(initialData?.img) {
                    const i = new Image(); i.src = initialData.img;
                    i.onload = () => { ctx.drawImage(i,0,0,c.width,c.height); setIsDrawn(true); setIsLocked(true); };
                }
            }, [initialData]);

            const getPos = (e) => {
                const r = canvasRef.current.getBoundingClientRect();
                const x = (e.touches?e.touches[0].clientX:e.clientX) - r.left;
                const y = (e.touches?e.touches[0].clientY:e.clientY) - r.top;
                return {x,y};
            }
            const start = (e) => {
                if(isLocked) return;
                const ctx = canvasRef.current.getContext('2d');
                const {x,y} = getPos(e);
                ctx.beginPath(); ctx.moveTo(x,y);
                setIsDrawn(true);
            }
            const move = (e) => {
                if(isLocked || (e.buttons!==1 && !e.touches)) return;
                const ctx = canvasRef.current.getContext('2d');
                const {x,y} = getPos(e);
                ctx.lineTo(x,y); ctx.stroke();
            }
            const end = () => { if(isDrawn && !isLocked) setIsLocked(true); }
            const clear = () => {
                const c = canvasRef.current; const ctx = c.getContext('2d');
                ctx.fillRect(0,0,c.width,c.height); setIsDrawn(false); setIsLocked(false);
            }
            const save = () => {
                if(!name || !pwd) return alert('è«‹å¡«å¯«å®Œæ•´');
                if(!isDrawn) return alert('è«‹ç•«åœ–');
                onSave(name, pwd, canvasRef.current.toDataURL(), style);
            }

            const currStyle = getStyle(style);

            return (
                <div className="flex flex-col h-full animate-slide-up">
                    <h2 className="text-xl font-bold mb-4 text-center text-kimetsu-black flex items-center justify-center gap-2"><Icons.Pen/> ç¹ªè£½å·è»¸</h2>
                    <div className="mb-4">
                        <label className="block text-xs font-bold mb-1 text-gray-500">å‘¼å¸æµæ´¾</label>
                        <div className="flex gap-1 overflow-x-auto pb-2">
                            {Object.keys(STYLES).map(k => (
                                <button key={k} onClick={()=>setStyle(k)} className={`flex-shrink-0 p-2 border-2 rounded-lg ${style===k?'border-kimetsu-black bg-white scale-105':'border-transparent opacity-50'} transition-all`}>
                                    <div className="text-2xl">{getStyle(k).icon}</div>
                                </button>
                            ))}
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-3 mb-4">
                        <input value={name} onChange={e=>setName(e.target.value)} className={`p-2 border-2 ${currStyle.border} rounded text-center font-bold outline-none`} placeholder="éšŠå“¡å" />
                        <input value={pwd} onChange={e=>setPwd(e.target.value)} className={`p-2 border-2 ${currStyle.border} rounded text-center font-bold outline-none`} placeholder="å¯†ç¢¼" />
                    </div>
                    <div className="flex-1 flex flex-col items-center">
                        <div className={`w-full aspect-square border-4 ${currStyle.border} rounded-xl overflow-hidden relative shadow-lg ${isLocked?'opacity-90':''}`}>
                            <canvas ref={canvasRef} className="w-full h-full touch-none" 
                                onMouseDown={start} onMouseMove={move} onMouseUp={end} onMouseLeave={end}
                                onTouchStart={start} onTouchMove={move} onTouchEnd={end}
                            />
                            {isLocked && <div className="absolute inset-0 bg-black/10 flex items-center justify-center pointer-events-none text-red-600 font-black text-2xl tracking-[1em] opacity-30">å°å°</div>}
                        </div>
                        <div className="w-full flex justify-end mt-2"><button onClick={clear} className="text-sm text-gray-500 font-bold px-3 py-1 border rounded hover:bg-gray-100"><Icons.RotateCcw size={14}/> é‡ç•«</button></div>
                    </div>
                    <div className="mt-4 flex gap-3">
                        <button onClick={onCancel} className="flex-1 py-3 border-2 border-gray-400 text-gray-600 font-bold rounded-lg">å–æ¶ˆ</button>
                        <button onClick={save} className="flex-1 py-3 bg-kimetsu-green text-white font-bold rounded-lg shadow-md border-b-4 border-green-900 active:translate-y-1 active:border-b-0 transition-all">å‚³é€</button>
                    </div>
                </div>
            )
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
