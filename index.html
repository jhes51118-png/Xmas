<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¶å¯å¤¢ä¸€ç­†ç•«äº¤æ›ç¦®ç‰© (é€šç”¨ç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'poke-yellow': '#FFCB05',
                        'poke-blue': '#3466AF',
                        'poke-red': '#FB1B1B',
                        'poke-cream': '#FFFFFA',
                        'poke-light-yellow': '#FFF9D7',
                    },
                    fontFamily: {
                        'poke': ['"Comic Sans MS"', '"Chalkboard SE"', 'sans-serif'] // æ›¿æ›ç‚ºæ›´å¯æ„›çš„å­—é«”
                    }
                }
            }
        }
    </script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in; }
        .animate-slide-up { animation: slideUp 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        /* Loading Spinner for initial load */
        #initial-loader { position: fixed; inset: 0; background: #FFF9D7; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s; }
        .spinner { width: 50px; height: 50px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cg%3E%3Ccircle cx='50' cy='50' r='45' fill='%23FB1B1B' stroke='%23333' stroke-width='5'/%3E%3Cpath d='M5,50 a45,45 0 0,0 90,0' fill='white' stroke='%23333' stroke-width='5'/%3E%3Ccircle cx='50' cy='50' r='12' fill='white' stroke='%23333' stroke-width='5'/%3E%3Ccircle cx='50' cy='50' r='6' fill='white' stroke='%23333' stroke-width='2'/%3E%3Cpath d='M95,50 L5,50' stroke='%23333' stroke-width='5'/%3E%3C/g%3E%3C/svg%3E"); background-size: contain; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden-loader { opacity: 0; pointer-events: none; }
        /* Pokemon Background Pattern */
        .bg-pokemon-pattern {
            background-color: #FFF9D7;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60' viewBox='0 0 100 100' opacity='0.1'%3E%3Cg fill='%23FFCB05'%3E%3Ccircle cx='25' cy='25' r='5'/%3E%3Ccircle cx='75' cy='75' r='5'/%3E%3Ccircle cx='25' cy='75' r='5'/%3E%3Ccircle cx='75' cy='25' r='5'/%3E%3Cpath d='M50 15 L60 35 L40 35 Z' /%3E%3Cpath d='M50 85 L60 65 L40 65 Z' /%3E%3C/g%3E%3C/svg%3E");
        }
    </style>
</head>
<body class="bg-pokemon-pattern text-slate-800 font-poke">
    
    <!-- åˆå§‹è¼‰å…¥ç•«é¢ (é¿å… React è¼‰å…¥å‰ç™½å±) -->
    <div id="initial-loader">
        <div class="spinner"></div>
        <p class="mt-4 text-poke-blue font-bold text-lg">æ­£åœ¨å‰å¾€å¯¶å¯å¤¢ä¸­å¿ƒ...</p>
        <p id="error-msg" class="mt-2 text-poke-red text-sm max-w-md text-center hidden"></p>
    </div>

    <div id="root"></div>

    <!-- Global Error Handler -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            const loader = document.getElementById('initial-loader');
            const errText = document.getElementById('error-msg');
            if (loader && errText) {
                loader.classList.remove('hidden-loader'); // Ensure loader is visible
                document.querySelector('.spinner').style.display = 'none'; // Hide spinner
                errText.classList.remove('hidden');
                errText.innerHTML = `<strong>ç™¼ç”ŸéŒ¯èª¤ï¼š</strong><br>${msg}<br><span style="font-size:10px; color:#94a3b8">${url}:${line}</span><br><br>å¦‚æœæ‚¨æ˜¯åœ¨é›»è…¦ä¸Šç›´æ¥æ‰“é–‹ html æª”æ¡ˆï¼Œè«‹ç¢ºä¿ç¶²è·¯é€£ç·šæ­£å¸¸ã€‚`;
            }
            return false;
        };
    </script>

    <!-- React App Script -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18?dev';
        import { createRoot } from 'https://esm.sh/react-dom@18/client?dev';
        
        // Firebase Imports (Web SDK)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, collection, addDoc, onSnapshot, 
            doc, setDoc, updateDoc, deleteDoc, getDocs, writeBatch, serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // --- ç°¡æ˜“åœ–ç¤ºå…ƒä»¶ (SVG) ---
        const Icon = ({ path, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        // ä½¿ç”¨ PokÃ© Ball ä½œç‚ºåœ–ç¤º
        const PokeBallIcon = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 100 100" className={className}>
                <g>
                    <circle cx="50" cy="50" r="45" fill="#FB1B1B" stroke="#333" strokeWidth="5"/>
                    <path d="M5,50 a45,45 0 0,0 90,0" fill="white" stroke="#333" strokeWidth="5"/>
                    <circle cx="50" cy="50" r="12" fill="white" stroke="#333" strokeWidth="5"/>
                    <circle cx="50" cy="50" r="6" fill="white" stroke="#333" strokeWidth="2"/>
                    <path d="M95,50 L5,50" stroke="#333" strokeWidth="5"/>
                </g>
            </svg>
        );
        
        const Icons = {
            Gift: (p) => <PokeBallIcon {...p} className="text-poke-red" />, // ä½¿ç”¨ PokÃ© Ball ä»£æ›¿ç¦®ç‰©
            PenTool: (p) => <Icon {...p} path={<><path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/></>} />,
            Users: (p) => <Icon {...p} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />,
            Shuffle: (p) => <Icon {...p} path={<><path d="M2 18h1.4c1.3 0 2.5-.6 3.3-1.7l14.2-12.6"/><path d="m22 2-5 5"/><path d="m17 2 5 5"/><path d="M2 6h1.4c1.3 0 2.5.6 3.3 1.7l14.2 12.6"/><path d="m22 22-5-5"/><path d="m17 22 5-5"/></>} />,
            Eye: (p) => <Icon {...p} path={<><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></>} />,
            Snowflake: (p) => <Icon {...p} path={<><path d="M12 2L12 22"/><path d="M2 12L22 12"/><path d="M19.07 4.93L4.93 19.07"/><path d="M4.93 4.93L19.07 19.07"/></>} />, // ç°¡åŒ–ç‚ºåå­—æ˜Ÿ
            RotateCcw: (p) => <Icon {...p} path={<><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></>} />,
            Save: (p) => <Icon {...p} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />,
            Check: (p) => <Icon {...p} path={<polyline points="20 6 9 17 4 12"/>} />,
            Cloud: (p) => <Icon {...p} path={<path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19 8.963 24.5 12 24.5s5.5-2.463 5.5-5.5z" />} />,
            WifiOff: (p) => <Icon {...p} path={<><line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></>} />,
            Settings: (p) => <Icon {...p} path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />,
            Loader2: (p) => <PokeBallIcon {...p} className={`${p.className} animate-spin`} />, // æ›¿æ›ç‚ºæ—‹è½‰çš„ PokÃ© Ball
            Lock: (p) => <Icon {...p} path={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>} />,
            LogOut: (p) => <Icon {...p} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></>} />,
            Trash2: (p) => <Icon {...p} path={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>} />,
            Key: (p) => <Icon {...p} path={<><path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/></>} />,
            Image: (p) => <Icon {...p} path={<><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></>} />,
            Edit: (p) => <Icon {...p} path={<><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></>} />,
            EyeOff: (p) => <Icon {...p} path={<><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></>} />,
        };

        // --- Config Wizard Component ---
        const ConfigWizard = ({ onConfigComplete, onOfflineMode }) => {
            const [inputConfig, setInputConfig] = useState('');
            const [error, setError] = useState('');

            const handleSave = () => {
                try {
                    let configStr = inputConfig.trim();
                    configStr = configStr.replace(/^(const|let|var|export\s+const)\s+\w+\s*=\s*/, '');
                    configStr = configStr.replace(/;$/, '');
                    
                    let config;
                    try {
                        config = JSON.parse(configStr);
                    } catch (e1) {
                        try {
                            let jsStr = configStr;
                            if (!jsStr.startsWith('{')) {
                                jsStr = `{${jsStr}}`;
                            }
                            const fn = new Function(`return ${jsStr}`);
                            config = fn();
                        } catch (e2) {
                            throw new Error("ç„¡æ³•è§£æå…§å®¹ï¼Œè«‹æª¢æŸ¥æ ¼å¼ã€‚");
                        }
                    }

                    if (!config || typeof config !== 'object') throw new Error("è¨­å®šå¿…é ˆæ˜¯ç‰©ä»¶æ ¼å¼");
                    if (!config.apiKey) throw new Error("ç¼ºå°‘ apiKey");
                    
                    localStorage.setItem('fb_config_override', JSON.stringify(config));
                    onConfigComplete(config);
                } catch(e) {
                    setError('ç„¡æ³•è§£æï¼š' + e.message + 'ã€‚å»ºè­°ç›´æ¥å¾ Firebase Console è¤‡è£½æ•´æ®µ config ç‰©ä»¶ã€‚');
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4">
                    <div className="bg-poke-cream p-8 rounded-3xl shadow-xl max-w-lg w-full border-4 border-poke-yellow">
                        <div className="flex justify-center mb-4 text-poke-blue"><Icons.Settings size={48} /></div>
                        <h2 className="text-2xl font-bold text-center mb-2 text-poke-blue font-poke">è¨­å®šæ‚¨çš„å¯¶å¯å¤¢äº¤æ›ä¸­å¿ƒ</h2>
                        <p className="text-slate-500 text-center mb-6 font-poke">åµæ¸¬ä¸åˆ° Firebase è¨­å®šã€‚è‹¥è¦ä½¿ç”¨ã€Œé›²ç«¯é€£ç·šã€ï¼Œè«‹è²¼ä¸Š Firebase Configï¼›æˆ–é¸æ“‡ã€Œé›¢ç·šæ¨¡å¼ã€è©¦ç©ã€‚</p>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-poke-blue mb-1 font-poke">è²¼ä¸Š Firebase Config JSON:</label>
                                <textarea 
                                    className="w-full h-32 p-3 border-2 border-poke-blue rounded-lg text-xs font-mono bg-poke-light-yellow focus:ring-2 ring-poke-yellow outline-none"
                                    placeholder='è«‹ç›´æ¥è²¼ä¸Š Firebase Console è£¡çš„ config ç¨‹å¼ç¢¼ï¼Œä¾‹å¦‚ï¼š&#10;const firebaseConfig = {&#10;  apiKey: "...",&#10;  ...&#10;};'
                                    value={inputConfig}
                                    onChange={e => setInputConfig(e.target.value)}
                                ></textarea>
                                {error && <p className="text-poke-red text-xs mt-1 whitespace-pre-wrap font-poke">{error}</p>}
                            </div>
                            
                            <button onClick={handleSave} className="w-full py-3 bg-poke-blue hover:bg-blue-700 text-white rounded-xl font-bold transition shadow-md border-b-4 border-blue-800 font-poke">
                                å„²å­˜ä¸¦é€£ç·šé›²ç«¯
                            </button>

                            <div className="relative my-4">
                                <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-poke-yellow"></div></div>
                                <div className="relative flex justify-center text-sm"><span className="px-2 bg-poke-cream text-slate-500 font-poke">æˆ–æ˜¯</span></div>
                            </div>

                            <button onClick={onOfflineMode} className="w-full py-3 bg-poke-yellow hover:bg-yellow-400 text-poke-blue rounded-xl font-bold flex items-center justify-center gap-2 transition shadow-md border-b-4 border-yellow-600 font-poke">
                                <Icons.WifiOff size={20} />
                                ä½¿ç”¨é›¢ç·šæ¨¡å¼ (å–®æ©Ÿè©¦ç©)
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [mode, setMode] = useState('loading'); // loading, setup, cloud, offline
            const [view, setView] = useState('home'); 
            const [users, setUsers] = useState([]);
            const [matches, setMatches] = useState({});
            const [myParticipantId, setMyParticipantId] = useState(localStorage.getItem('my_participant_id'));
            const [revealData, setRevealData] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [isAdmin, setIsAdmin] = useState(false);
            const [adminPasswordInput, setAdminPasswordInput] = useState('');
            const [userPasswordInput, setUserPasswordInput] = useState('');
            const [loginTargetUser, setLoginTargetUser] = useState(null);
            const [editData, setEditData] = useState(null); // Data for editing
            const [showAdminPasswords, setShowAdminPasswords] = useState(false); // Admin toggle to show user passwords
            
            // Firebase refs
            const appRef = useRef(null);
            const authRef = useRef(null);
            const dbRef = useRef(null);
            const appId = 'default-app-id';

            // 1. Initial Config Check
            useEffect(() => {
                const initSystem = async () => {
                    // Remove Loading Spinner in DOM
                    const loader = document.getElementById('initial-loader');
                    if(loader) loader.classList.add('hidden-loader');

                    let config = null;
                    try {
                        if (typeof __firebase_config !== 'undefined') {
                            config = JSON.parse(__firebase_config);
                        } else {
                            const saved = localStorage.getItem('fb_config_override');
                            if(saved) config = JSON.parse(saved);
                        }

                        if (config && config.apiKey) {
                            try {
                                appRef.current = initializeApp(config);
                                authRef.current = getAuth(appRef.current);
                                dbRef.current = getFirestore(appRef.current);
                                
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    await signInWithCustomToken(authRef.current, __initial_auth_token);
                                } else {
                                    await signInAnonymously(authRef.current);
                                }
                                
                                setMode('cloud');
                            } catch (err) {
                                console.error("Firebase Init Failed", err);
                                setMode('setup'); 
                            }
                        } else {
                            setMode('setup');
                        }
                    } catch (e) {
                        console.log("Config parse error", e);
                        setMode('setup');
                    }
                };
                initSystem();
            }, []);

            // 2. Data Sync (Cloud Mode Only)
            useEffect(() => {
                if (mode !== 'cloud' || !dbRef.current) return;

                const participantsRef = collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'participants');
                const unsubUsers = onSnapshot(participantsRef, (snapshot) => {
                    const usersList = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    usersList.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                    setUsers(usersList);
                    
                    // --- AUTO-LOGOUT FIX ---
                    if (localStorage.getItem('my_participant_id')) {
                         const currentMyId = localStorage.getItem('my_participant_id');
                         const exists = usersList.find(u => u.id === currentMyId);
                         if (!exists) {
                             console.log("Auto-logout: User no longer exists on server.");
                             localStorage.removeItem('my_participant_id');
                             setMyParticipantId(null);
                             // Clear saved password too
                             localStorage.removeItem('my_password_backup');
                         }
                    }
                }, err => console.error(err));

                const matchesRef = collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'matches');
                const unsubMatches = onSnapshot(matchesRef, (snapshot) => {
                    const matchesMap = {};
                    snapshot.docs.forEach(d => matchesMap[d.id] = d.data().receiverId);
                    setMatches(matchesMap);
                }, err => console.error(err));

                return () => { unsubUsers(); unsubMatches(); };
            }, [mode]);

            // 3. Local Data Sync (Offline Mode Only)
            useEffect(() => {
                if (mode !== 'offline') return;
                const savedUsers = localStorage.getItem('xmas_users');
                const savedMatches = localStorage.getItem('xmas_matches');
                if (savedUsers) setUsers(JSON.parse(savedUsers));
                if (savedMatches) setMatches(JSON.parse(savedMatches));
            }, [mode]);

            // Handlers
            const handleOfflineMode = () => {
                setMode('offline');
                setView('home');
            };

            const handleConfigComplete = (config) => {
                window.location.reload();
            };

            const handleReset = async () => {
                if (!confirm('ã€è­¦å‘Šã€‘ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ\né€™å°‡æ¸…ç©ºæ‰€æœ‰äººçš„ç¹ªåœ–å’Œåˆ†é…çµæœï¼æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;
                setIsProcessing(true);
                
                if (mode === 'cloud') {
                    try {
                        const usersSnap = await getDocs(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'participants'));
                        const batch1 = writeBatch(dbRef.current);
                        usersSnap.docs.forEach((d) => batch1.delete(d.ref));
                        await batch1.commit();

                        const matchesSnap = await getDocs(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'matches'));
                        const batch2 = writeBatch(dbRef.current);
                        matchesSnap.docs.forEach((d) => batch2.delete(d.ref));
                        await batch2.commit();
                    } catch (e) { alert('é‡ç½®å¤±æ•—'); }
                } else {
                    localStorage.removeItem('xmas_users');
                    localStorage.removeItem('xmas_matches');
                    setUsers([]);
                    setMatches({});
                }
                
                localStorage.removeItem('my_participant_id');
                localStorage.removeItem('my_password_backup'); // Clear saved password
                setMyParticipantId(null);
                setRevealData(null);
                setEditData(null);
                setView('home'); // Reset goes to home
                setIsProcessing(false);
            };

            const handleManualLogout = () => {
                if (confirm('ç¢ºå®šè¦æ¸…é™¤æœ¬æ©Ÿçš„ç™»å…¥ç‹€æ…‹å—ï¼Ÿ(ä¸æœƒåˆªé™¤é›²ç«¯è³‡æ–™)')) {
                    localStorage.removeItem('my_participant_id');
                    localStorage.removeItem('my_password_backup'); // Clear saved password
                    setMyParticipantId(null);
                    setEditData(null);
                    setView('home');
                }
            };

            const startDrawing = () => {
                if (myParticipantId && users.find(u => u.id === myParticipantId)) {
                    alert('ä½ å·²ç¶“åƒåŠ éäº†å–”ï¼');
                    return;
                }
                setEditData(null); 
                setView('draw');
            };

            const editMyCard = () => {
                 const me = users.find(u => u.id === myParticipantId);
                 if (me) {
                     if (matches[me.id]) {
                         alert('æ´»å‹•å·²ç¶“é–‹å§‹åˆ†é…ç¦®ç‰©ï¼Œç„¡æ³•ä¿®æ”¹äº†ï¼');
                         return;
                     }
                     setEditData(me);
                     setView('draw');
                 }
            };

            const saveUser = async (name, password, drawingData) => {
                setIsProcessing(true);
                try {
                    // Auto-remember password for this user
                    localStorage.setItem('my_password_backup', password);

                    // Check if update or create
                    if (editData && editData.id === myParticipantId) {
                         // --- UPDATE MODE ---
                         if (mode === 'cloud') {
                            const userRef = doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'participants', myParticipantId);
                            await updateDoc(userRef, {
                                name, password, drawing: drawingData, updatedAt: serverTimestamp()
                            });
                         } else {
                             const updatedUsers = users.map(u => 
                                u.id === myParticipantId ? { ...u, name, password, drawing: drawingData } : u
                             );
                             setUsers(updatedUsers);
                             localStorage.setItem('xmas_users', JSON.stringify(updatedUsers));
                         }
                         alert('ä¿®æ”¹æˆåŠŸï¼');
                         setView('my_card'); 
                    } else {
                        // --- CREATE MODE ---
                        if (mode === 'cloud') {
                            const userUid = authRef.current?.currentUser?.uid || 'anon';
                            const docRef = await addDoc(collection(dbRef.current, 'artifacts', appId, 'public', 'data', 'participants'), {
                                name, password, drawing: drawingData, createdAt: serverTimestamp(), uid: userUid
                            });
                            localStorage.setItem('my_participant_id', docRef.id);
                            setMyParticipantId(docRef.id);
                        } else {
                            const newUser = { id: Date.now().toString(), name, password, drawing: drawingData, uid: 'local' };
                            const newUsers = [...users, newUser];
                            setUsers(newUsers);
                            localStorage.setItem('xmas_users', JSON.stringify(newUsers));
                            localStorage.setItem('my_participant_id', newUser.id);
                            setMyParticipantId(newUser.id);
                        }
                        setView('home');
                    }
                } catch (e) { console.error(e); alert('ä¸Šå‚³å¤±æ•—'); }
                setIsProcessing(false);
                setEditData(null);
            };

            const performMatching = async () => {
                if (users.length < 2) { alert('è‡³å°‘éœ€è¦å…©ä½ç©å®¶æ‰èƒ½åˆ†é…ï¼'); return; }
                if (Object.keys(matches).length > 0 && !confirm('å·²ç¶“åˆ†é…éäº†ï¼Œè¦é‡æ–°åˆ†é…å—ï¼Ÿé€™æœƒæ‰“äº‚ç¾æœ‰çš„çµæœã€‚')) return;
                
                setIsProcessing(true);
                let giverIds = users.map(u => u.id);
                let receiverIds = [...giverIds];
                let isValid = false;

                // Simple Derangement Shuffle
                let attempts = 0;
                while (!isValid && attempts < 100) {
                    for (let i = receiverIds.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [receiverIds[i], receiverIds[j]] = [receiverIds[j], receiverIds[i]];
                    }
                    isValid = true;
                    for (let i = 0; i < giverIds.length; i++) {
                        if (giverIds[i] === receiverIds[i]) { isValid = false; break; }
                    }
                    attempts++;
                }

                if (!isValid) {
                     const shifted = [...giverIds];
                     const first = shifted.shift();
                     shifted.push(first);
                     receiverIds = shifted;
                }

                if (mode === 'cloud') {
                    try {
                        const batch = writeBatch(dbRef.current);
                        giverIds.forEach((giverId, index) => {
                            const matchRef = doc(dbRef.current, 'artifacts', appId, 'public', 'data', 'matches', giverId);
                            batch.set(matchRef, { receiverId: receiverIds[index] });
                        });
                        await batch.commit();
                    } catch (e) { alert('åˆ†é…å¤±æ•—: ' + e.message); }
                } else {
                    const newMatches = {};
                    giverIds.forEach((gid, i) => newMatches[gid] = receiverIds[i]);
                    setMatches(newMatches);
                    localStorage.setItem('xmas_matches', JSON.stringify(newMatches));
                }
                
                alert('åˆ†é…å®Œæˆï¼');
                setIsProcessing(false);
            };

            const handleUserLogin = () => {
                if (!loginTargetUser) return;
                if (loginTargetUser.password && loginTargetUser.password !== userPasswordInput) {
                    alert('å¯†ç¢¼éŒ¯èª¤ï¼è«‹è¼¸å…¥æ‚¨ç•¶åˆè¨­å®šçš„å¯†ç¢¼ã€‚');
                    return;
                }
                const receiverId = matches[loginTargetUser.id];
                if (!receiverId) return alert('å°šæœªåˆ†é…ç¦®ç‰©');
                
                const receiver = users.find(u => u.id === receiverId);
                setRevealData({ giver: loginTargetUser, receiver });
                setLoginTargetUser(null);
                setUserPasswordInput('');
                setView('check_result');
            }

            const promptUserLogin = (user) => {
                setLoginTargetUser(user);
                // Auto-fill password if I am this user and I have saved password locally
                if (isMe(user.id)) {
                    const savedPwd = localStorage.getItem('my_password_backup');
                    if(savedPwd) {
                        setUserPasswordInput(savedPwd);
                    } else {
                        setUserPasswordInput('');
                    }
                } else {
                    setUserPasswordInput('');
                }
                setView('user_login');
            }

            const isMe = (uid) => myParticipantId === uid;

            const handleAdminLogin = () => {
                if (adminPasswordInput === 'admin123') { 
                    setIsAdmin(true);
                    setView('admin_dashboard');
                    setAdminPasswordInput('');
                } else {
                    alert('å¯†ç¢¼éŒ¯èª¤');
                }
            };

            // Render Modes
            if (mode === 'loading') return null;
            if (mode === 'setup') return <ConfigWizard onConfigComplete={handleConfigComplete} onOfflineMode={handleOfflineMode} />;

            // --- Admin Views ---
            if (view === 'admin_login') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 font-poke">
                        <div className="bg-poke-cream p-8 rounded-3xl shadow-xl max-w-sm w-full border-4 border-poke-blue">
                            <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-poke-blue">
                                <Icons.Lock className="text-poke-red"/> å¯¶å¯å¤¢ä¸­å¿ƒç®¡ç†å“¡ç™»å…¥
                            </h2>
                            <p className="text-slate-500 text-sm mb-4">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ä»¥é€²å…¥å¾Œå°ã€‚</p>
                            <input 
                                type="password" 
                                value={adminPasswordInput}
                                onChange={e => setAdminPasswordInput(e.target.value)}
                                className="w-full p-3 border-2 border-poke-blue rounded-lg mb-4 outline-none focus:ring-2 ring-poke-yellow bg-poke-light-yellow"
                                placeholder="å¯†ç¢¼ (é è¨­: admin123)"
                            />
                            <div className="flex gap-2">
                                <button onClick={() => setView('home')} className="flex-1 py-2 bg-slate-200 text-slate-600 rounded-xl hover:bg-slate-300 transition font-bold">å–æ¶ˆ</button>
                                <button onClick={handleAdminLogin} className="flex-1 py-2 bg-poke-blue text-white rounded-xl font-bold hover:bg-blue-700 transition shadow-md border-b-4 border-blue-800">ç™»å…¥</button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'admin_dashboard') {
                return (
                    <div className="min-h-screen flex flex-col font-poke">
                         <header className="bg-poke-blue text-white p-4 shadow-md flex justify-between items-center sticky top-0 z-20 border-b-4 border-blue-800">
                            <div className="flex items-center gap-2">
                                <Icons.Settings className="text-poke-yellow" />
                                <h1 className="text-lg font-bold">å¯¶å¯å¤¢ä¸­å¿ƒå¾Œå°</h1>
                            </div>
                            <button onClick={() => { setIsAdmin(false); setView('home'); }} className="text-xs bg-blue-700 px-3 py-1.5 rounded flex items-center gap-1 hover:bg-blue-600 transition border-b-2 border-blue-900 font-bold">
                                <Icons.LogOut size={14}/> é›¢é–‹å¾Œå°
                            </button>
                        </header>
                        <div className="p-4 max-w-5xl mx-auto w-full space-y-6">
                            
                            {/* Control Panel */}
                            <div className="bg-poke-cream p-6 rounded-3xl shadow-sm border-4 border-poke-yellow">
                                <h3 className="font-bold text-poke-blue mb-4 border-b-2 border-poke-yellow pb-2">æ´»å‹•æ§åˆ¶</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="space-y-2">
                                        <p className="text-sm text-slate-500">ç•¶æ‰€æœ‰è¨“ç·´å®¶éƒ½å®Œæˆç¹ªåœ–å¾Œï¼Œé»æ“ŠæŒ‰éˆ•é€²è¡Œéš¨æ©Ÿé…å°ã€‚</p>
                                        <button onClick={performMatching} disabled={isProcessing} className="w-full py-3 bg-poke-red hover:bg-red-700 text-white rounded-xl font-bold shadow-md flex items-center justify-center gap-2 border-b-4 border-red-800">
                                            <Icons.Shuffle size={20}/> {Object.keys(matches).length > 0 ? 'é‡æ–°åˆ†é…å¯¶å¯å¤¢' : 'é–‹å§‹åˆ†é…å¯¶å¯å¤¢'}
                                        </button>
                                    </div>
                                    <div className="space-y-2">
                                        <p className="text-sm text-slate-500">æ´»å‹•çµæŸå¾Œï¼Œå¯æ¸…ç©ºè³‡æ–™é‡æ–°é–‹å§‹ã€‚</p>
                                        <button onClick={handleReset} disabled={isProcessing} className="w-full py-3 bg-poke-cream border-2 border-poke-red hover:bg-red-50 text-poke-red rounded-xl font-bold flex items-center justify-center gap-2 shadow-sm">
                                            <Icons.Trash2 size={20}/> æ¸…é™¤æ‰€æœ‰è³‡æ–™
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Match List (New) */}
                            {Object.keys(matches).length > 0 && (
                                <div className="bg-poke-cream p-6 rounded-3xl shadow-sm border-4 border-poke-blue">
                                    <h3 className="font-bold text-poke-blue mb-4 border-b-2 border-poke-blue pb-2">é…å°åå–® (åƒ…å¾Œå°å¯è¦‹)</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                                        {users.map(u => {
                                            const recId = matches[u.id];
                                            const rec = users.find(r => r.id === recId);
                                            return (
                                                <div key={u.id} className="flex justify-between p-2 bg-poke-light-yellow rounded-xl border-2 border-poke-yellow">
                                                    <span>ğŸ <strong>{u.name}</strong></span>
                                                    <span className="text-poke-blue mx-2">âœ é€çµ¦ âœ</span>
                                                    <span><strong>{rec?.name}</strong> ğŸ§‘â€ğŸ„</span>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {/* Gallery */}
                            <div className="bg-poke-cream p-6 rounded-3xl shadow-sm border-4 border-poke-yellow">
                                <div className="flex justify-between items-end mb-4 border-b-2 border-poke-yellow pb-2">
                                    <h3 className="font-bold text-poke-blue">è¨“ç·´å®¶ç•«å»Š ({users.length}äºº)</h3>
                                    <button 
                                        onClick={() => setShowAdminPasswords(!showAdminPasswords)}
                                        className={`text-xs flex items-center gap-1 px-2 py-1 rounded-lg transition font-bold ${showAdminPasswords ? 'bg-orange-100 text-orange-700 border-2 border-orange-300' : 'bg-slate-100 text-slate-500 hover:bg-slate-200 border-2 border-slate-300'}`}
                                    >
                                        {showAdminPasswords ? <Icons.EyeOff size={14}/> : <Icons.Eye size={14}/>}
                                        {showAdminPasswords ? 'éš±è—å¯†ç¢¼' : 'é¡¯ç¤ºå¯†ç¢¼(æ•‘æ´ç”¨)'}
                                    </button>
                                </div>
                                
                                {users.length === 0 ? (
                                    <p className="text-center text-slate-400 py-8">ç›®å‰é‚„æ²’æœ‰äººåŠ å…¥...</p>
                                ) : (
                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                        {users.map(u => (
                                            <div key={u.id} className="border-2 border-poke-yellow rounded-2xl p-2 bg-poke-light-yellow relative group shadow-sm">
                                                <div className="aspect-square bg-white rounded-xl border-2 border-poke-yellow overflow-hidden mb-2">
                                                    <img src={u.drawing} className="w-full h-full object-contain" />
                                                </div>
                                                <div className="flex flex-col">
                                                    <div className="flex justify-between items-center mb-1">
                                                        <span className="font-bold text-sm truncate text-poke-blue">{u.name}</span>
                                                        {matches[u.id] && <span className="text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded-full font-bold border border-green-300">å·²é…å°</span>}
                                                    </div>
                                                    {showAdminPasswords && (
                                                        <div className="bg-orange-50 text-orange-600 text-[10px] p-1 rounded font-mono break-all border border-orange-200 font-bold">
                                                            å¯†ç¢¼: {u.password}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                )
            }

            // --- User Login View (New) ---
            if (view === 'user_login') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 font-poke">
                        <div className="bg-poke-cream p-8 rounded-3xl shadow-xl max-w-sm w-full border-4 border-poke-blue">
                            <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-poke-blue">
                                <Icons.Lock className="text-poke-yellow"/> è¨“ç·´å®¶é©—è­‰
                            </h2>
                            <p className="text-poke-blue font-bold mb-1">æ­¡è¿å›ä¾†ï¼Œ{loginTargetUser?.name}ï¼</p>
                            <p className="text-slate-500 text-xs mb-4">è«‹è¼¸å…¥æ‚¨ç•¶åˆè¨­å®šçš„å¯†ç¢¼ä»¥æŸ¥çœ‹çµæœã€‚</p>
                            <input 
                                type="password" 
                                value={userPasswordInput}
                                onChange={e => setUserPasswordInput(e.target.value)}
                                className="w-full p-3 border-2 border-poke-blue rounded-lg mb-4 outline-none focus:ring-2 ring-poke-yellow bg-poke-light-yellow"
                                placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
                            />
                            <div className="flex gap-2">
                                <button onClick={() => setView('reveal')} className="flex-1 py-2 bg-slate-200 text-slate-600 rounded-xl hover:bg-slate-300 transition font-bold">å–æ¶ˆ</button>
                                <button onClick={handleUserLogin} className="flex-1 py-2 bg-poke-blue text-white rounded-xl font-bold hover:bg-blue-700 transition shadow-md border-b-4 border-blue-800">æŸ¥çœ‹çµæœ</button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Main Public App UI
            return (
                <div className="min-h-screen relative overflow-hidden flex flex-col items-center font-poke">
                    {/* Background */}
                    <div className="absolute inset-0 pointer-events-none opacity-10 z-0" style={{
                        backgroundImage: `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60' viewBox='0 0 100 100'%3E%3Cg fill='%23FFCB05'%3E%3Ccircle cx='25' cy='25' r='5'/%3E%3Ccircle cx='75' cy='75' r='5'/%3E%3Ccircle cx='25' cy='75' r='5'/%3E%3Ccircle cx='75' cy='25' r='5'/%3E%3Cpath d='M50 15 L60 35 L40 35 Z' /%3E%3Cpath d='M50 85 L60 65 L40 65 Z' /%3E%3C/g%3E%3C/svg%3E")`,
                        backgroundColor: '#FFF9D7'
                    }}>
                        <div className="absolute top-10 left-10 text-poke-red animate-pulse opacity-50"><Icons.Gift size={48}/></div>
                        <div className="absolute bottom-20 right-10 text-poke-blue animate-bounce opacity-50"><Icons.Gift size={32}/></div>
                    </div>

                    <div className="relative z-10 w-full max-w-md min-h-screen bg-poke-cream shadow-2xl flex flex-col border-x-4 border-poke-yellow">
                        <header className="bg-gradient-to-r from-poke-blue to-blue-600 p-4 text-white shadow-md flex justify-between items-center border-b-4 border-blue-800">
                            <div className="flex items-center gap-2">
                                <Icons.Gift className="text-poke-yellow drop-shadow-md" size={28} />
                                <h1 className="text-xl font-bold drop-shadow-sm">å¯¶å¯å¤¢ä¸€ç­†ç•«äº¤æ›</h1>
                            </div>
                            <div className="flex items-center gap-2">
                                {mode === 'cloud' && <span className="text-xs bg-blue-800/50 px-2 py-1 rounded-full flex items-center gap-1 font-bold border border-blue-400"><Icons.Cloud size={12}/> é€£ç·šä¸­</span>}
                            </div>
                        </header>

                        <main className="flex-1 p-6 flex flex-col relative">
                            {isProcessing && <div className="absolute inset-0 z-50 bg-poke-cream/80 flex items-center justify-center"><Icons.Loader2 className="text-poke-red" size={64}/></div>}

                            {view === 'home' && (
                                <div className="flex flex-col items-center justify-center h-full gap-8 animate-fade-in relative">
                                    <div className="text-center space-y-2">
                                        <h2 className="text-3xl font-bold text-poke-blue drop-shadow-sm">æ­¡è¿ä¾†åˆ°å¯¶å¯å¤¢äº¤æ›ä¸­å¿ƒï¼</h2>
                                        <div className="bg-poke-light-yellow px-6 py-3 rounded-full inline-block border-2 border-poke-yellow shadow-sm">
                                            <p className="text-poke-blue font-bold">ç›®å‰å·²æœ‰ <span className="text-poke-red text-2xl font-extrabold">{users.length}</span> ä½è¨“ç·´å®¶</p>
                                        </div>
                                    </div>
                                    <div className="w-full space-y-4">
                                        {!myParticipantId ? (
                                            <button onClick={startDrawing} className="w-full py-4 bg-poke-yellow hover:bg-yellow-400 text-poke-blue rounded-2xl shadow-lg flex items-center justify-center gap-3 text-lg font-bold active:scale-95 transition-transform border-b-4 border-yellow-600">
                                                <Icons.PenTool size={28}/> æˆ‘æ˜¯æ–°è¨“ç·´å®¶ (é–‹å§‹ç•«åœ–)
                                            </button>
                                        ) : (
                                            <button onClick={() => setView('my_card')} className="w-full py-4 bg-poke-light-yellow border-4 border-poke-yellow text-poke-blue hover:bg-yellow-100 rounded-2xl flex items-center justify-center gap-2 font-bold shadow-md active:scale-95 transition-transform">
                                                <Icons.Image size={28}/> æŸ¥çœ‹ / ä¿®æ”¹æˆ‘çš„åœ–é‘‘å¡
                                            </button>
                                        )}
                                        <button onClick={() => setView('participants')} className="w-full py-4 bg-poke-cream border-4 border-poke-blue hover:bg-blue-50 text-poke-blue rounded-2xl shadow-sm flex items-center justify-center gap-3 text-lg font-bold transition-transform active:scale-95">
                                            <Icons.Users size={28}/> æŸ¥çœ‹è¨“ç·´å®¶åˆ—è¡¨
                                        </button>
                                        
                                        {Object.keys(matches).length > 0 ? (
                                            <button onClick={() => setView('reveal')} className="w-full py-4 bg-gradient-to-r from-poke-red to-red-600 text-white rounded-2xl shadow-lg flex items-center justify-center gap-3 text-lg font-bold mt-8 animate-pulse border-b-4 border-red-800 active:scale-95 transition-transform">
                                                <Icons.Eye size={28}/> åˆ†é…å®Œæˆï¼æŸ¥çœ‹çµæœ
                                            </button>
                                        ) : (
                                            // Waiting state
                                            <div className="mt-8 text-center text-poke-blue text-sm bg-poke-light-yellow p-6 rounded-2xl border-4 border-poke-yellow shadow-inner">
                                                <p className="font-bold text-lg">ç­‰å¾…åšå£«åˆ†é…å¯¶å¯å¤¢ä¸­...</p>
                                                <Icons.Loader2 className="inline-block mt-4 text-poke-yellow" size={32}/>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Admin & Footer Links */}
                                    <div className="mt-auto pt-8 flex flex-col items-center gap-3 w-full">
                                        {myParticipantId && (
                                            <button onClick={handleManualLogout} className="text-xs text-poke-red hover:text-red-700 flex items-center gap-1 py-2 px-4 rounded-full border-2 border-poke-red hover:bg-red-50 transition mb-2 font-bold">
                                                <Icons.LogOut size={14}/> æ¸…é™¤ç™»å…¥ç‹€æ…‹ (æˆ‘æ˜¯æ–°è¨“ç·´å®¶)
                                            </button>
                                        )}
                                        <button onClick={() => setView('admin_login')} className="text-sm text-poke-blue hover:text-blue-700 flex items-center gap-2 py-2 px-4 rounded-full transition font-bold bg-poke-light-yellow border-2 border-poke-blue hover:bg-blue-100">
                                            <Icons.Lock size={16}/> å¯¶å¯å¤¢ä¸­å¿ƒå¾Œå° (Admin)
                                        </button>

                                        {mode === 'offline' && (
                                            <div className="text-xs text-slate-400 font-bold">
                                                <button onClick={()=>{localStorage.removeItem('fb_config_override');window.location.reload()}} className="underline ml-1 hover:text-poke-blue transition">é‡è¨­é€£ç·š</button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {view === 'draw' && <DrawingPad initialData={editData} onSave={saveUser} onCancel={() => setView(editData ? 'my_card' : 'home')} Icons={Icons} />}
                            
                            {view === 'my_card' && (
                                <div className="flex flex-col h-full animate-fade-in">
                                    <div className="flex items-center justify-center mb-4 relative">
                                         <h2 className="text-2xl font-bold text-center text-poke-blue drop-shadow-sm">æˆ‘çš„åœ–é‘‘å¡</h2>
                                    </div>
                                    {(() => {
                                        const me = users.find(u => u.id === myParticipantId);
                                        // é€™è£¡å°±æ˜¯æ‚¨å¯èƒ½çœ‹åˆ°çš„éŒ¯èª¤ç•«é¢ï¼Œç¾åœ¨æœ‰äº†è‡ªå‹•ç™»å‡ºï¼Œæ‡‰è©²æœƒæ¸›å°‘å‡ºç¾æ©Ÿç‡
                                        if (!me) return (
                                            <div className="flex flex-col items-center justify-center py-10 text-poke-blue gap-4 bg-poke-light-yellow rounded-3xl border-4 border-poke-yellow p-8 shadow-md">
                                                <p className="font-bold text-lg">è®€å–ä¸åˆ°æ‚¨çš„è³‡æ–™ï¼Œå¯èƒ½å·²è¢«åšå£«é‡ç½®ã€‚</p>
                                                <button onClick={handleManualLogout} className="px-6 py-3 bg-poke-blue text-white rounded-xl text-sm font-bold shadow-md border-b-4 border-blue-800 hover:bg-blue-700 transition">æ¸…é™¤ç‹€æ…‹ä¸¦è¿”å›é¦–é </button>
                                            </div>
                                        );
                                        const isLocked = !!matches[me.id];

                                        return (
                                            <div className="flex-1 flex flex-col items-center">
                                                <div className="w-full bg-poke-cream p-6 rounded-3xl shadow-md border-4 border-poke-yellow mb-6 relative">
                                                    <div className="absolute -top-4 -left-4 text-poke-red animate-bounce"><Icons.Gift size={32}/></div>
                                                    <div className="flex justify-between items-center mb-4 border-b-2 border-poke-yellow pb-2">
                                                        <span className="text-poke-blue text-sm font-bold">è¨“ç·´å®¶åç¨±</span>
                                                        <span className="font-bold text-xl text-poke-blue">{me.name}</span>
                                                    </div>
                                                    <div className="aspect-square w-full bg-white rounded-2xl border-4 border-poke-blue overflow-hidden relative shadow-inner">
                                                        <img src={me.drawing} className="w-full h-full object-contain"/>
                                                        {isLocked && <div className="absolute inset-0 bg-poke-blue/20 flex items-center justify-center"><span className="bg-poke-red text-white px-4 py-2 rounded-full text-sm font-bold border-2 border-white shadow-md">å·²é–å®š</span></div>}
                                                    </div>
                                                </div>

                                                {isLocked ? (
                                                    <div className="w-full p-6 bg-orange-100 text-orange-700 rounded-3xl text-sm text-center mb-6 border-4 border-orange-300 shadow-md">
                                                        <p className="font-bold mb-2 text-lg">ğŸ”’ å¯¶å¯å¤¢å·²åˆ†é…ï¼</p>
                                                        ç„¡æ³•å†ä¿®æ”¹åœ–é‘‘å¡äº†ï¼
                                                    </div>
                                                ) : (
                                                    <button onClick={editMyCard} className="w-full py-4 bg-poke-blue hover:bg-blue-700 text-white rounded-2xl shadow-md font-bold flex items-center justify-center gap-2 mb-6 border-b-4 border-blue-800 active:scale-95 transition-transform">
                                                        <Icons.Edit size={24}/> é‡æ–°ç¹ªè£½ / ä¿®æ”¹
                                                    </button>
                                                )}
                                                
                                                <button onClick={() => setView('home')} className="w-full py-4 bg-poke-light-yellow text-poke-blue font-bold rounded-2xl mt-auto border-4 border-poke-yellow hover:bg-yellow-200 transition shadow-sm active:scale-95">è¿”å›é¦–é </button>
                                            </div>
                                        );
                                    })()}
                                </div>
                            )}

                            {view === 'participants' && (
                                <div className="flex flex-col h-full">
                                    <h2 className="text-2xl font-bold mb-6 flex items-center gap-3 text-poke-blue"><Icons.Users className="text-poke-yellow" size={32}/> è¨“ç·´å®¶åå–®</h2>
                                    <div className="flex-1 overflow-y-auto space-y-4 pr-2">
                                        {users.length === 0 ? <div className="text-center text-poke-blue mt-10 font-bold text-lg bg-poke-light-yellow p-8 rounded-3xl border-4 border-poke-yellow">ç›®å‰é‚„æ²’æœ‰è¨“ç·´å®¶åŠ å…¥...</div> : users.map((u, idx) => (
                                            <div key={u.id} className={`p-4 rounded-2xl flex justify-between items-center border-4 shadow-sm transition-transform hover:scale-[1.02] ${isMe(u.id) ? 'bg-yellow-100 border-poke-yellow' : 'bg-poke-cream border-poke-blue'}`}>
                                                <div className="flex items-center gap-3">
                                                    <span className="font-bold text-lg text-poke-blue">#{idx + 1} {u.name}</span>
                                                    {isMe(u.id) && <span className="text-xs bg-poke-red text-white px-3 py-1 rounded-full font-bold border-2 border-white shadow-sm">æˆ‘</span>}
                                                </div>
                                                <span className="text-xs bg-green-100 text-green-700 px-3 py-1 rounded-full font-bold border-2 border-green-300 flex items-center gap-1"><Icons.Check size={14}/> å·²ç¹ªåœ–</span>
                                            </div>
                                        ))}
                                    </div>
                                    <button onClick={() => setView('home')} className="mt-6 w-full py-4 bg-poke-light-yellow text-poke-blue font-bold rounded-2xl border-4 border-poke-yellow hover:bg-yellow-200 transition shadow-sm active:scale-95">è¿”å›</button>
                                </div>
                            )}

                            {view === 'reveal' && (
                                <div className="flex flex-col h-full">
                                    <div className="text-center mb-8">
                                        <h2 className="text-3xl font-bold text-poke-red drop-shadow-sm">åˆ†é…å®Œæˆï¼</h2>
                                        <p className="text-poke-blue font-bold mt-2">è«‹é»æ“Šä½ çš„åå­—ä¸¦è¼¸å…¥å¯†ç¢¼</p>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4 overflow-y-auto pb-6 pr-2">
                                        {users.map((u) => (
                                            <button key={u.id} onClick={() => promptUserLogin(u)} className={`p-6 border-4 rounded-3xl shadow-md flex flex-col items-center justify-center aspect-square transition-all relative group active:scale-95 ${isMe(u.id) ? 'bg-yellow-100 border-poke-red ring-4 ring-yellow-200 hover:bg-yellow-200' : 'bg-poke-cream border-poke-blue hover:bg-blue-100 hover:border-blue-400'}`}>
                                                {isMe(u.id) && <div className="absolute top-3 right-3 text-poke-red font-extrabold text-sm bg-white px-2 py-0.5 rounded-full shadow-sm border border-poke-red">Me</div>}
                                                <Icons.Lock size={32} className={`${isMe(u.id) ? 'text-poke-red' : 'text-poke-blue'} mb-3 group-hover:scale-110 transition-transform`} />
                                                <span className="font-bold text-poke-blue text-lg truncate w-full text-center">{u.name}</span>
                                            </button>
                                        ))}
                                    </div>
                                    <button onClick={() => setView('home')} className="mt-auto w-full py-4 bg-poke-light-yellow text-poke-blue font-bold rounded-2xl border-4 border-poke-yellow hover:bg-yellow-200 transition shadow-sm active:scale-95">è¿”å›é¦–é </button>
                                </div>
                            )}

                            {view === 'check_result' && revealData && (
                                <div className="flex flex-col h-full items-center justify-center text-center animate-fade-in">
                                    <div className="mb-8">
                                        <span className="text-sm text-poke-blue uppercase tracking-widest font-bold">ä½ å¥½, è¨“ç·´å®¶</span>
                                        <h2 className="text-4xl font-extrabold text-poke-blue mt-2 drop-shadow-sm">{revealData.giver.name}</h2>
                                    </div>
                                    <div className="w-full bg-yellow-100 p-8 rounded-3xl border-4 border-poke-yellow mb-8 relative overflow-hidden shadow-lg">
                                        <div className="absolute -top-6 -right-6 text-poke-yellow opacity-50 rotate-12"><Icons.Gift size={80}/></div>
                                        <p className="text-poke-blue mb-4 font-bold text-lg">ä½ è¦é€ç¦®ç‰©çš„å°è±¡æ˜¯ï¼š</p>
                                        
                                        {/* Masked Name */}
                                        <div className="text-3xl font-extrabold text-poke-red mb-4 bg-white py-4 px-8 rounded-2xl shadow-md inline-block tracking-widest border-4 border-poke-red relative z-10">
                                            ??? (ç¥ç§˜è¨“ç·´å®¶)
                                        </div>
                                        <p className="text-sm text-orange-700 mb-8 bg-orange-100 px-4 py-2 rounded-full inline-block font-bold border-2 border-orange-300 relative z-10">åšå£«å°‡åœ¨ç¾å ´æ­æ›‰èº«åˆ†ï¼</p>
                                        
                                        <p className="text-poke-blue mb-4 font-bold text-lg relative z-10">è«‹æº–å‚™ç¬¦åˆæ­¤åœ–çš„å¯¶å¯å¤¢ç¦®ç‰©ï¼š</p>
                                        <div className="bg-white border-4 border-poke-blue rounded-2xl p-4 shadow-inner inline-block relative z-10">
                                            {revealData.receiver ? <img src={revealData.receiver.drawing} alt="Secret Sketch" className="w-64 h-64 object-contain" /> : "Error"}
                                        </div>
                                    </div>
                                    <button onClick={() => setView('reveal')} className="w-full py-4 bg-poke-red text-white font-bold rounded-2xl hover:bg-red-700 transition shadow-md border-b-4 border-red-800 active:scale-95">çœ‹å¥½äº†ï¼(ç™»å‡º)</button>
                                </div>
                            )}
                        </main>
                    </div>
                </div>
            );
        };

        const DrawingPad = ({ onSave, onCancel, Icons, initialData }) => {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);
            const [name, setName] = useState(initialData ? initialData.name : '');
            const [password, setPassword] = useState(initialData ? initialData.password : '');
            const [hasDrawn, setHasDrawn] = useState(false);
            const [isLocked, setIsLocked] = useState(false); // New state to enforce single stroke

            useEffect(() => {
                const canvas = canvasRef.current;
                if(!canvas) return;
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientWidth;
                const ctx = canvas.getContext('2d');
                ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.strokeStyle = '#3466AF'; // Poke Blue
                ctx.lineWidth = 5; // ç¨å¾®åŠ ç²—
                
                // Init background
                ctx.fillStyle = '#FFFFFA'; // Poke Cream
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Load initial image if editing
                if (initialData && initialData.drawing) {
                    const img = new Image();
                    img.src = initialData.drawing;
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        setHasDrawn(true);
                        setIsLocked(true); // Lock loaded image immediately
                    }
                }
            }, [initialData]);

            const getPos = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };
            
            const startDraw = (e) => { 
                if (isLocked) {
                    // Prevent drawing if locked
                    return; 
                }
                setIsDrawing(true); 
                setHasDrawn(true); 
                const pos = getPos(e); 
                const ctx = canvasRef.current.getContext('2d'); 
                ctx.beginPath(); 
                ctx.moveTo(pos.x, pos.y); 
            };
            
            const draw = (e) => { 
                if (!isDrawing) return; 
                const pos = getPos(e); 
                const ctx = canvasRef.current.getContext('2d'); 
                ctx.lineTo(pos.x, pos.y); 
                ctx.stroke(); 
            };
            
            const endDraw = () => {
                if (isDrawing) {
                    setIsDrawing(false);
                    setIsLocked(true); // Lock immediately after one stroke
                }
            };
            
            const clearCanvas = () => { 
                const ctx = canvasRef.current.getContext('2d'); 
                ctx.fillStyle = '#FFFFFA'; 
                ctx.fillRect(0, 0, canvasRef.current.width, canvasRef.current.height); 
                setHasDrawn(false); 
                setIsLocked(false); // Reset lock
            };
            
            const handleSave = () => {
                if (!name.trim()) return alert('è«‹è¼¸å…¥åå­—ï¼');
                if (!password.trim()) return alert('è«‹è¨­å®šå¯†ç¢¼ï¼Œä¹‹å¾ŒæŸ¥çœ‹çµæœéœ€è¦ç”¨åˆ°ï¼');
                if (!hasDrawn) return alert('è«‹ç•«åœ–ï¼');
                onSave(name, password.trim(), canvasRef.current.toDataURL('image/png'));
            };

            return (
                <div className="flex flex-col h-full animate-slide-up font-poke">
                    <h2 className="text-2xl font-bold mb-4 text-center text-poke-blue drop-shadow-sm">{initialData ? 'ä¿®æ”¹åœ–é‘‘å¡' : 'ç¹ªè£½åœ–é‘‘å¡'}</h2>
                    <div className="mb-4 grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-bold text-poke-blue mb-2">è¨“ç·´å®¶åå­—</label>
                            <input type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="ä¾‹å¦‚ï¼šå°æ™º" className="w-full p-3 border-2 border-poke-blue rounded-xl outline-none focus:ring-2 ring-poke-yellow bg-poke-light-yellow text-poke-blue font-bold" />
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-poke-blue mb-2">è¨­å®šå¯†ç¢¼ (æŸ¥çœ‹çµæœç”¨)</label>
                            <input type="text" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="ä¾‹å¦‚ï¼š1234" className="w-full p-3 border-2 border-poke-blue rounded-xl outline-none focus:ring-2 ring-poke-yellow bg-poke-light-yellow text-poke-blue font-bold" />
                        </div>
                    </div>
                    <div className="flex-1 flex flex-col items-center">
                        <div className={`text-sm font-bold mb-3 flex items-center gap-2 px-4 py-2 rounded-full border-2 shadow-sm transition-colors ${isLocked ? 'bg-red-100 text-poke-red border-poke-red' : 'bg-yellow-100 text-poke-blue border-poke-yellow'}`}>
                            <Icons.PenTool size={18}/> 
                            {isLocked ? (hasDrawn ? 'ç­†å¢¨å·²ä¹¾ï¼(åªèƒ½ä¸€ç­†ç•«ï¼Œé»æ“Šé‡ç•«å¯é‡ä¾†)' : 'æŒ‘æˆ°ä¸€ç­†ç•«ï¼') : 'æŒ‘æˆ°ä¸€ç­†ç•«ï¼ä¸‹ç­†å¾Œä¸èƒ½æ–·å–”ï¼'}
                        </div>
                        <div className={`w-full aspect-square border-4 border-dashed rounded-3xl overflow-hidden shadow-inner relative bg-poke-cream touch-none transition-colors ${isLocked ? 'border-poke-red bg-red-50' : 'border-poke-blue hover:border-poke-yellow'}`}>
                            <canvas ref={canvasRef} className={`w-full h-full touch-none ${isLocked ? 'cursor-not-allowed' : 'cursor-crosshair'}`} onMouseDown={startDraw} onMouseMove={draw} onMouseUp={endDraw} onMouseLeave={endDraw} onTouchStart={startDraw} onTouchMove={draw} onTouchEnd={endDraw} />
                            {isLocked && <div className="absolute inset-0 pointer-events-none flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity bg-poke-cream/50 text-poke-red font-extrabold text-lg drop-shadow-sm"></div>}
                        </div>
                        <div className="flex justify-end w-full mt-4"><button onClick={clearCanvas} className="text-sm text-poke-blue flex items-center gap-2 hover:text-poke-red transition font-bold bg-poke-light-yellow px-3 py-1.5 rounded-full border-2 border-poke-blue hover:border-poke-red shadow-sm"><Icons.RotateCcw size={16}/> é‡ç•«</button></div>
                    </div>
                    <div className="mt-8 flex gap-4">
                        <button onClick={onCancel} className="flex-1 py-4 border-4 border-poke-blue text-poke-blue rounded-2xl font-bold hover:bg-blue-50 transition shadow-sm active:scale-95">å–æ¶ˆ</button>
                        <button onClick={handleSave} className="flex-1 py-4 bg-poke-red text-white rounded-2xl shadow-md flex justify-center items-center gap-3 font-bold border-b-4 border-red-800 hover:bg-red-700 transition active:scale-95"><Icons.Save size={20}/> {initialData ? 'æ›´æ–°åœ–é‘‘' : 'ä¸Šå‚³åœ–é‘‘'}</button>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
